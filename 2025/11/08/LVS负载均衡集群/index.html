<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>LVS负载均衡集群 | Felix的个人博客</title><meta name="author" content="Felix"><meta name="copyright" content="Felix"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="LVS负载均衡集群一、什么是LVS？LVS（Linux Virtual Server）是一个开源的负载均衡软件，由阿里巴巴前技术总监章文嵩博士开发。它在Linux操作系统内核层实现负载均衡功能，可以将来自客户端的大量请求分散到多台后端服务器，使得单个服务器的压力被均衡分担。 简单来说，LVS就像一个”交通指挥官”，当用户请求到达时，它根据预设的规则把请求分配给不同的服务器处理，避免某个服务器过载，">
<meta property="og:type" content="article">
<meta property="og:title" content="LVS负载均衡集群">
<meta property="og:url" content="http://example.com/2025/11/08/LVS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9B%86%E7%BE%A4/index.html">
<meta property="og:site_name" content="Felix的个人博客">
<meta property="og:description" content="LVS负载均衡集群一、什么是LVS？LVS（Linux Virtual Server）是一个开源的负载均衡软件，由阿里巴巴前技术总监章文嵩博士开发。它在Linux操作系统内核层实现负载均衡功能，可以将来自客户端的大量请求分散到多台后端服务器，使得单个服务器的压力被均衡分担。 简单来说，LVS就像一个”交通指挥官”，当用户请求到达时，它根据预设的规则把请求分配给不同的服务器处理，避免某个服务器过载，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/imgs/adater.jpg">
<meta property="article:published_time" content="2025-11-08T11:56:26.000Z">
<meta property="article:modified_time" content="2025-11-12T08:02:45.591Z">
<meta property="article:author" content="Felix">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/imgs/adater.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "LVS负载均衡集群",
  "url": "http://example.com/2025/11/08/LVS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9B%86%E7%BE%A4/",
  "image": "http://example.com/imgs/adater.jpg",
  "datePublished": "2025-11-08T11:56:26.000Z",
  "dateModified": "2025-11-12T08:02:45.591Z",
  "author": [
    {
      "@type": "Person",
      "name": "Felix",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2025/11/08/LVS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9B%86%E7%BE%A4/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'LVS负载均衡集群',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.0.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/imgs/background_header.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Felix的个人博客</span></a><a class="nav-page-title" href="/"><span class="site-name">LVS负载均衡集群</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">LVS负载均衡集群</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-11-08T11:56:26.000Z" title="Created 2025-11-08 19:56:26">2025-11-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-11-12T08:02:45.591Z" title="Updated 2025-11-12 16:02:45">2025-11-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="LVS负载均衡集群"><a href="#LVS负载均衡集群" class="headerlink" title="LVS负载均衡集群"></a>LVS负载均衡集群</h1><h2 id="一、什么是LVS？"><a href="#一、什么是LVS？" class="headerlink" title="一、什么是LVS？"></a>一、什么是LVS？</h2><p>LVS（Linux Virtual Server）是一个开源的负载均衡软件，由阿里巴巴前技术总监章文嵩博士开发。它在Linux操作系统内核层实现负载均衡功能，可以<strong>将来自客户端的大量请求分散到多台后端服务器</strong>，使得单个服务器的<strong>压力被均衡分担</strong>。</p>
<p>简单来说，LVS就像一个”交通指挥官”，当用户请求到达时，它根据预设的规则把请求分配给不同的服务器处理，避免某个服务器过载，其他服务器闲置的情况。</p>
<h2 id="二、LVS的工作原理"><a href="#二、LVS的工作原理" class="headerlink" title="二、LVS的工作原理"></a>二、LVS的工作原理</h2><h3 id="2-1-基本架构"><a href="#2-1-基本架构" class="headerlink" title="2.1 基本架构"></a>2.1 基本架构</h3><p>LVS集群由三部分组成：</p>
<ul>
<li><strong>负载均衡器（Director）</strong>：运行LVS的Linux服务器，接收所有客户端请求</li>
<li><strong>真实服务器&#x2F;服务器池（Real Server&#x2F;Server Pool）</strong>：处理实际业务的后端服务器</li>
<li><strong>共享存储（可选）</strong>：存储应用数据的存储设备</li>
</ul>
<p><img src="/./imgs/image-20251108141302490.png" alt="image-20251108141302490"></p>
<h3 id="2-2-三种负载均衡模式"><a href="#2-2-三种负载均衡模式" class="headerlink" title="2.2 三种负载均衡模式"></a>2.2 三种负载均衡模式</h3><h4 id="NAT模式（Network-Address-Translation）"><a href="#NAT模式（Network-Address-Translation）" class="headerlink" title="NAT模式（Network Address Translation）"></a>NAT模式（Network Address Translation）</h4><ul>
<li>负载均衡器修改请求的目标地址为真实服务器地址</li>
<li>真实服务器的响应通过负载均衡器回传给客户端</li>
<li>所有流量都经过负载均衡器，可能成为性能瓶颈</li>
<li>真实服务器可以使用私有IP，便于管理</li>
</ul>
<p><strong>优点</strong>：配置简单，真实服务器对集群无感知 <strong>缺点</strong>：负载均衡器压力大，性能受限</p>
<p><img src="/./imgs/image-20251108141437830.png" alt="image-20251108141437830"></p>
<h4 id="DR模式（Direct-Routing）"><a href="#DR模式（Direct-Routing）" class="headerlink" title="DR模式（Direct Routing）"></a>DR模式（Direct Routing）</h4><ul>
<li>负载均衡器只修改请求的MAC地址，将请求转发到真实服务器</li>
<li>真实服务器直接将响应发送给客户端，绕过负载均衡器</li>
<li>大大提高吞吐量，适合高并发场景</li>
<li>负载均衡器和真实服务器必须在同一局域网内</li>
</ul>
<p><strong>优点</strong>：性能最优，负载均衡器压力小 <strong>缺点</strong>：需要特殊配置，真实服务器需要支持</p>
<p><img src="/./imgs/image-20251108142054913.png" alt="image-20251108142054913"></p>
<h4 id="TUN模式（IP-Tunneling）"><a href="#TUN模式（IP-Tunneling）" class="headerlink" title="TUN模式（IP Tunneling）"></a>TUN模式（IP Tunneling）</h4><ul>
<li>负载均衡器将请求包封装在新的IP包中，发送给真实服务器</li>
<li>真实服务器解封后处理请求，直接响应客户端</li>
<li>允许负载均衡器和真实服务器在不同网络</li>
</ul>
<p><strong>优点</strong>：适合跨域部署，性能良好 <strong>缺点</strong>：配置复杂，对网络要求高</p>
<p><img src="/./imgs/image-20251108142044359.png" alt="image-20251108142044359"></p>
<h3 id="2-3-工作流程"><a href="#2-3-工作流程" class="headerlink" title="2.3 工作流程"></a>2.3 工作流程</h3><p><strong>NAT模式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">客户端请求 (源IP:客户端IP, 目标IP:VIP)</span><br><span class="line">        ↓</span><br><span class="line">  负载均衡器接收</span><br><span class="line">        ↓</span><br><span class="line">   修改目标IP为真实服务器IP</span><br><span class="line">        ↓</span><br><span class="line">  转发请求到真实服务器</span><br><span class="line">        ↓</span><br><span class="line"> 真实服务器处理请求</span><br><span class="line">        ↓</span><br><span class="line">  真实服务器发送响应(源IP:真实服务器IP)</span><br><span class="line">        ↓</span><br><span class="line">  负载均衡器修改源IP为VIP</span><br><span class="line">        ↓</span><br><span class="line">   响应返回给客户端(源IP:VIP)</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：请求和响应<strong>都必须</strong>经过负载均衡器，负载均衡器需要修改目标IP和源IP。</p>
<p><strong>数据流向图：</strong></p>
<p><img src="/./imgs/image-20251111185553299.png" alt="image-20251111185553299"></p>
<p><strong>DR模式（直接路由）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">客户端请求 (源IP:客户端IP, 目标IP:VIP)</span><br><span class="line">        ↓</span><br><span class="line">  负载均衡器接收</span><br><span class="line">        ↓</span><br><span class="line">   修改目标MAC地址为真实服务器MAC</span><br><span class="line">        ↓</span><br><span class="line">  转发请求到真实服务器(IP不变)</span><br><span class="line">        ↓</span><br><span class="line"> 真实服务器接收(目标IP是VIP，自己配置了VIP)</span><br><span class="line">        ↓</span><br><span class="line"> 真实服务器处理请求</span><br><span class="line">        ↓</span><br><span class="line">  真实服务器直接发送响应</span><br><span class="line">   (源IP:VIP, 目标IP:客户端IP)</span><br><span class="line">        ↓</span><br><span class="line">  响应直接返回给客户端(绕过负载均衡器)</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：<strong>只修改MAC地址</strong>，<strong>IP保持不变</strong>。响应<strong>直接</strong>从真实服务器返回给客户端，<strong>绕过</strong>负载均衡器。</p>
<p><strong>数据流向图：</strong></p>
<p><img src="/./imgs/image-20251111191721246.png" alt="image-20251111191721246"></p>
<p><strong>TUN模式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">客户端请求 (源IP:客户端IP, 目标IP:VIP)</span><br><span class="line">        ↓</span><br><span class="line">  负载均衡器接收</span><br><span class="line">        ↓</span><br><span class="line">  将整个请求包作为数据，用新IP头封装</span><br><span class="line">  (新外层IP: 源IP=Director, 目标IP=真实服务器IP)</span><br><span class="line">        ↓</span><br><span class="line">  转发隧道包到真实服务器</span><br><span class="line">        ↓</span><br><span class="line"> 真实服务器解封包得到原始请求</span><br><span class="line">        ↓</span><br><span class="line"> 真实服务器处理请求</span><br><span class="line">        ↓</span><br><span class="line">  真实服务器直接发送响应</span><br><span class="line">   (源IP:VIP, 目标IP:客户端IP)</span><br><span class="line">        ↓</span><br><span class="line">  响应直接返回给客户端(绕过负载均衡器)</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：原始请求被完整封装成新的IP包。响应也直接从真实服务器返回。真实服务器需要配置隧道接口。</p>
<p><img src="/./imgs/image-20251108142604957.png" alt="image-20251108142604957"></p>
<p><img src="/./imgs/image-20251108142619546.png" alt="image-20251108142619546"></p>
<h2 id="三、LVS能做什么？"><a href="#三、LVS能做什么？" class="headerlink" title="三、LVS能做什么？"></a>三、LVS能做什么？</h2><h3 id="3-1-高性能负载均衡"><a href="#3-1-高性能负载均衡" class="headerlink" title="3.1 高性能负载均衡"></a>3.1 高性能负载均衡</h3><p>在传输层实现，性能远优于应用层的负载均衡器（如Nginx）。可以处理数百万级别的并发连接。</p>
<h3 id="3-2-高可用部署"><a href="#3-2-高可用部署" class="headerlink" title="3.2 高可用部署"></a>3.2 高可用部署</h3><p>通过配置多个负载均衡器和健康检查机制，确保服务持续可用。当某个真实服务器宕机时，自动将流量转移到其他正常服务器。</p>
<h3 id="3-3-多种调度算法支持"><a href="#3-3-多种调度算法支持" class="headerlink" title="3.3 多种调度算法支持"></a>3.3 多种调度算法支持</h3><p>LVS提供多种调度算法供不同场景选择，包括轮询、加权轮询、最少连接、加权最少连接、基于目标地址的哈希等。</p>
<h3 id="3-4-适应多种应用场景"><a href="#3-4-适应多种应用场景" class="headerlink" title="3.4 适应多种应用场景"></a>3.4 适应多种应用场景</h3><p>可用于Web服务、数据库集群、缓存集群、API网关、CDN等多种应用领域。</p>
<h3 id="3-5-与Keepalived结合实现高可用"><a href="#3-5-与Keepalived结合实现高可用" class="headerlink" title="3.5 与Keepalived结合实现高可用"></a>3.5 与Keepalived结合实现高可用</h3><p>Keepalived提供虚拟IP（VIP）和故障转移功能，与LVS结合可实现完整的高可用解决方案。</p>
<h2 id="四、如何搭建LVS-NAT集群？"><a href="#四、如何搭建LVS-NAT集群？" class="headerlink" title="四、如何搭建LVS-NAT集群？"></a>四、如何搭建LVS-NAT集群？</h2><p>以NAT模式为例，搭建一个包含1个负载均衡器和2个真实服务器的集群。</p>
<p><strong>拓扑结构</strong></p>
<p><img src="/./imgs/image-20251110103141632-1762745517341-1.png" alt="image-20251110103141632"></p>
<p><strong>搭建流程简述：</strong><br><strong>LVS服务器：</strong> </p>
<p>① 开启防火墙、清空规则<br>       开启net 转发功能（&#x2F;etc&#x2F;sysctl.conf net.ipv4.ip_forward）</p>
<p> ②  安装外网并开启lvs 管理工具 ipvsadm </p>
<p> ③  ⭐设置防火墙nat 地址映射功能，把内网网段的数据报转为外网的IP</p>
<p>即配置SNAT转发规则，将内网流量的源地址转换为LVS的外网地址</p>
<p> ④  ipvsadm配置<br>   ipvsadm 清理规则（ipvsadm -C）<br>   ipvsadm 设置外网访问入口与负载策略<br>   ipvsadm 定义后端地址池位置<br>   ipvsadm 直接启动<br><strong>HTTPD 服务器：</strong></p>
<p>① 关闭防火墙、核心防护、配置本地仓库然后下载httpd，或先下载httpd再<br>② 修改为内网IP<br>       设置内网IP信息，要求能ping通windows 的ip </p>
<p> ③ 开启httpd 后，修改网页，方便验证时分辨lvs的轮循规则</p>
<p>验证1：<br>  在LVS服务器上可以curl访问到后端的2台服务器网页<br>验证2：<br>  在windows的浏览器可以通过访问LVS地址，观测到内网的2台httpd地址</p>
<h3 id="4-1-环境准备"><a href="#4-1-环境准备" class="headerlink" title="4.1 环境准备"></a>4.1 环境准备</h3><p><strong>网络拓扑</strong>：上3 vmnet1仅主机模式 下1作为外网</p>
<ul>
<li>负载均衡器（Director）：192.168.73.90</li>
<li>真实服务器1（RS1）：192.168.73.91</li>
<li>真实服务器2（RS2）：192.168.73.92</li>
<li>虚拟IP（VIP）：192.168.118.90</li>
</ul>
<p>LVS服务器</p>
<p><img src="/./imgs/image-20251108190504764.png" alt="image-20251108190504764"></p>
<p><img src="/./imgs/image-20251108190437936.png" alt="image-20251108190437936"></p>
<p>windows设置</p>
<p>配置windows的vmnat8网关是为了确保windows在两网卡的虚拟机中找到虚拟机，以防混乱找不到</p>
<p><img src="/./imgs/image-20251110111558763.png" alt="image-20251110111558763"></p>
<p>2台服务器</p>
<p><img src="/./imgs/image-20251108145311256.png" alt="image-20251108145311256"></p>
<p><img src="/./imgs/image-20251108145953232.png" alt="image-20251108145953232"></p>
<p><img src="/./imgs/image-20251108150005561.png" alt="image-20251108150005561"></p>
<p><strong>所有服务器</strong>：</p>
<ul>
<li>操作系统：CentOS 7或以上</li>
<li>都在同一局域网内</li>
</ul>
<h3 id="4-2-在负载均衡器上安装并配置LVS"><a href="#4-2-在负载均衡器上安装并配置LVS" class="headerlink" title="4.2 在负载均衡器上安装并配置LVS"></a>4.2 在负载均衡器上安装并配置LVS</h3><h4 id="4-2-1-启用IP转发功能⭐"><a href="#4-2-1-启用IP转发功能⭐" class="headerlink" title="4.2.1 启用IP转发功能⭐"></a>4.2.1 启用IP转发功能⭐</h4><p><strong>为什么这么做？</strong> LVS需要在多个网络接口之间转发数据包。LVS服务器作为中间网关，负责接收来自外网的请求，然后转发给内网的Web服务器，并将响应转发回客户端。因此需要启用内核的IP转发功能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑内核参数配置文件</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到以下行，确保值为1（启用IP转发）</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使配置立即生效</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接写入内核参数（临时生效，重启后失效）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;1&#x27;</span> &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>

<p><strong>作用说明：</strong></p>
<ul>
<li><code>net.ipv4.ip_forward = 1</code>：<strong>启用IPv4转发</strong>，允许系统在接口间路由数据包</li>
<li>这是LVS工作的基础，<strong>没有它LVS无法转发流量</strong>，没有开启IP转发无法从内网访问到外网</li>
</ul>
<p><img src="/./imgs/image-20251108191930813.png" alt="image-20251108191930813"></p>
<h4 id="4-2-2-配置SNAT转发规则⭐"><a href="#4-2-2-配置SNAT转发规则⭐" class="headerlink" title="4.2.2 配置SNAT转发规则⭐"></a>4.2.2 配置SNAT转发规则⭐</h4><p><strong>为什么这么做？</strong> LVS采用NAT（Network Address Translation）模式工作。当内网Web服务器响应客户端请求时，响应包需要通过LVS转发回去。为了使响应包正确路由回客户端（外网），需要将所有来自内网的响应包的源IP地址改为LVS的外网IP（192.168.118.90），这样客户端才能正确接收到回应。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置SNAT规则，将内网流量的源地址转换为LVS的外网地址</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.73.0/24 -o ens33 -j SNAT --to-source 192.168.118.90</span><br><span class="line"><span class="comment"># 将后端服务器的响应包（网段）包装成192.168.118.90外部IP发送出去</span></span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251108192615738.png" alt="image-20251108192615738"></p>
<p><strong>规则解析：</strong></p>
<ul>
<li><code>-t nat</code>：使用NAT表</li>
<li><code>-A POSTROUTING</code>：在POSTROUTING链上追加规则（数据包离开系统时执行）</li>
<li><code>-s 192.168.73.0/24</code>：匹配源地址为内网网段的数据包</li>
<li><code>-o ens33</code>：匹配从ens33网卡出去的数据包</li>
<li><code>-j SNAT</code>：执行SNAT操作</li>
<li><code>--to-source 192.168.118.90</code>：将源地址转换为LVS的外网IP</li>
</ul>
<p><strong>工作流程示例：</strong></p>
<ol>
<li>客户端访问 192.168.118.90:80</li>
<li>LVS将请求转发给 192.168.73.91:80（Web服务器1）</li>
<li>Web服务器响应时，SNAT规则将<strong>响应包的源地址改为 192.168.118.90</strong></li>
<li>客户端收到来自 192.168.118.90 的响应，连接保持正常</li>
</ol>
<h4 id="4-2-3-清除原有防火墙规则"><a href="#4-2-3-清除原有防火墙规则" class="headerlink" title="4.2.3 清除原有防火墙规则"></a>4.2.3 清除原有防火墙规则</h4><p><strong>为什么这么做？</strong> 清除之前可能残留的iptables规则，避免与新配置的LVS规则产生冲突，确保配置的纯净性和可预测性。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清除NAT表中的所有规则</span></span><br><span class="line">iptables -t nat -F</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除filter表（默认）中的所有规则</span></span><br><span class="line">iptables -F</span><br></pre></td></tr></table></figure>

<h4 id="4-2-4-安装ipvsadm管理工具"><a href="#4-2-4-安装ipvsadm管理工具" class="headerlink" title="4.2.4 安装ipvsadm管理工具"></a>4.2.4 安装ipvsadm管理工具</h4><p><strong>为什么这么做？</strong> ipvsadm是LVS的用户空间管理工具，通过它可以配置和管理LVS的虚拟服务和真实服务器，是管理LVS必不可少的工具。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ipvsadm</span></span><br><span class="line">yum -y install ipvsadm</span><br></pre></td></tr></table></figure>

<h4 id="4-2-5-配置负载分配策略"><a href="#4-2-5-配置负载分配策略" class="headerlink" title="4.2.5 配置负载分配策略"></a>4.2.5 配置负载分配策略</h4><p><strong>为什么这么做？</strong> 配置LVS的虚拟服务（VIP）和真实服务器，以及负载均衡算法，使LVS开始发挥作用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清空之前的LVS配置</span></span><br><span class="line">ipvsadm -C</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建虚拟服务</span></span><br><span class="line"><span class="comment"># -A: 添加虚拟服务</span></span><br><span class="line"><span class="comment"># -t: 指定TCP服务</span></span><br><span class="line"><span class="comment"># 192.168.118.90:80: 虚拟服务的IP和端口（即申明外网网卡是192.168.118.90:80，与外部通信的）</span></span><br><span class="line"><span class="comment"># -s rr: 调度算法为轮询（round-robin）</span></span><br><span class="line">ipvsadm -A -t 192.168.118.90:80 -s rr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加第一个真实服务器</span></span><br><span class="line"><span class="comment"># -a: 添加真实服务器到虚拟服务</span></span><br><span class="line"><span class="comment"># -r: 指定真实服务器的IP和端口</span></span><br><span class="line"><span class="comment"># -m: 使用NAT模式（Masquerade）</span></span><br><span class="line">ipvsadm -a -t 192.168.118.90:80 -r 192.168.73.91:80 -m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加第二个真实服务器</span></span><br><span class="line">ipvsadm -a -t 192.168.118.90:80 -r 192.168.73.92:80 -m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出已配置的LVS规则</span></span><br><span class="line">ipvsadm -<span class="built_in">ln</span></span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251108192144277.png" alt="image-20251108192144277"></p>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>-A</code>：添加虚拟服务</li>
<li><code>-a</code>：添加真实服务器到虚拟服务</li>
<li><code>-t</code>：指定虚拟服务为TCP类型</li>
<li><code>-s rr</code>：调度算法为轮询（Round Robin），依次分配请求给每个服务器</li>
<li><code>-m</code>：NAT模式转发</li>
<li><code>-r</code>：真实服务器的地址和端口</li>
<li><code>-ln</code>：以简洁格式显示LVS规则</li>
</ul>
<p><strong>调度算法对比：</strong></p>
<table>
<thead>
<tr>
<th>算法</th>
<th>简称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Round-Robin</td>
<td>rr</td>
<td>轮询，依次分配</td>
</tr>
<tr>
<td>Least-Connection</td>
<td>lc</td>
<td>最少连接</td>
</tr>
<tr>
<td>Destination Hashing</td>
<td>dh</td>
<td>目标哈希</td>
</tr>
<tr>
<td>Source Hashing</td>
<td>sh</td>
<td>源哈希</td>
</tr>
<tr>
<td>Weighted Round-Robin</td>
<td>wrr</td>
<td>加权轮询</td>
</tr>
<tr>
<td>Weighted Least-Connection</td>
<td>wlc</td>
<td>加权最少连接</td>
</tr>
</tbody></table>
<h4 id="4-2-6-保存LVS配置"><a href="#4-2-6-保存LVS配置" class="headerlink" title="4.2.6 保存LVS配置"></a>4.2.6 保存LVS配置</h4><p><strong>为什么这么做？</strong> 保存配置使其在系统重启后仍然有效，避免每次重启都需要手动重新配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存当前的LVS配置到系统配置文件</span></span><br><span class="line">ipvsadm-save &gt; /etc/sysconfig/ipvsadm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用以下方式</span></span><br><span class="line">ipvsadm --save &gt; /etc/sysconfig/ipvsadm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动ipvsadm服务使配置持久化</span></span><br><span class="line">systemctl start ipvsadm.service</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251108192202291.png" alt="image-20251108192202291"></p>
<h4 id="4-2-7-验证配置"><a href="#4-2-7-验证配置" class="headerlink" title="4.2.7 验证配置"></a>4.2.7 验证配置</h4><p><strong>如何查看LVS工作状态？</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看LVS规则（简洁格式）</span></span><br><span class="line">ipvsadm -<span class="built_in">ln</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出示例：</span></span><br><span class="line"><span class="comment"># IP Virtual Server version 1.2.1 (size=4096)</span></span><br><span class="line"><span class="comment"># Prot LocalAddress:Port Scheduler Flags</span></span><br><span class="line"><span class="comment"># -&gt; RemoteAddress:Port Forward Weight ActiveConn InactConn</span></span><br><span class="line"><span class="comment"># TCP 192.168.118.90:80 rr</span></span><br><span class="line"><span class="comment"># -&gt; 192.168.73.91:80 Masq 1 0 0</span></span><br><span class="line"><span class="comment"># -&gt; 192.168.73.92:80 Masq 1 0 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看LVS详细信息</span></span><br><span class="line">ipvsadm -Ln</span><br></pre></td></tr></table></figure>

<p><strong>输出字段说明：</strong></p>
<ul>
<li><code>Prot</code>：协议类型（TCP&#x2F;UDP）</li>
<li><code>LocalAddress:Port</code>：虚拟服务的地址和端口</li>
<li><code>Scheduler</code>：调度算法（rr表示轮询）</li>
<li><code>RemoteAddress:Port</code>：真实服务器的地址和端口</li>
<li><code>Forward</code>：转发方式（Masq表示NAT模式）</li>
<li><code>Weight</code>：权重值</li>
<li><code>ActiveConn</code>：活跃连接数</li>
<li><code>InactConn</code>：非活跃连接数</li>
</ul>
<h3 id="4-3-LVS工作原理（NAT模式）"><a href="#4-3-LVS工作原理（NAT模式）" class="headerlink" title="4.3 LVS工作原理（NAT模式）"></a>4.3 LVS工作原理（NAT模式）</h3><p>LVS-NAT 模式(地址映射)接受用户请求时，LVS 服务器负责将外网IP映射为内网IP，然后通过负载均衡&#x2F;分流算法，将任务分发给后端，响应客户结果的时候，也是由VS服务器来处理的(内网IP映射为外网IP)</p>
<h4 id="请求流程"><a href="#请求流程" class="headerlink" title="请求流程"></a>请求流程</h4><ol>
<li>客户端发送请求到 192.168.118.90:80</li>
<li>LVS接收请求，查看连接表</li>
<li>根据调度算法（轮询）选择一个真实服务器（如192.168.73.91）</li>
<li>LVS修改请求的目标地址，转发给真实服务器</li>
<li>真实服务器处理请求并生成响应</li>
</ol>
<h4 id="响应流程"><a href="#响应流程" class="headerlink" title="响应流程"></a>响应流程</h4><ol>
<li>真实服务器发送响应</li>
<li>SNAT规则将响应的源地址改为 192.168.118.90</li>
<li>LVS修改响应的源端口（从真实服务器的源端口改回虚拟服务的源端口）</li>
<li>响应返回给客户端</li>
</ol>
<h3 id="4-4-测试验证"><a href="#4-4-测试验证" class="headerlink" title="4.4 测试验证"></a>4.4 测试验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在Windows宿主机上使用浏览器访问</span></span><br><span class="line">http://192.168.118.90</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用curl命令测试</span></span><br><span class="line">curl http://192.168.118.90</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：相隔至少20秒再重复访问，以观察轮询效果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在LVS服务器上监控连接状态</span></span><br><span class="line">watch -n 1 <span class="string">&#x27;ipvsadm -ln&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看LVS统计信息</span></span><br><span class="line">ipvsadm -Ln --stats</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251108192246452.png" alt="image-20251108192246452"></p>
<h3 id="4-5-常见问题排查"><a href="#4-5-常见问题排查" class="headerlink" title="4.5 常见问题排查"></a>4.5 常见问题排查</h3><h4 id="问题1：Web服务器无法访问"><a href="#问题1：Web服务器无法访问" class="headerlink" title="问题1：Web服务器无法访问"></a>问题1：Web服务器无法访问</h4><p><strong>检查步骤：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 检查网络连接</span></span><br><span class="line">ping 192.168.73.91</span><br><span class="line">ping 192.168.73.92</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查防火墙</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查httpd服务</span></span><br><span class="line">systemctl status httpd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 检查LVS配置</span></span><br><span class="line">ipvsadm -<span class="built_in">ln</span></span><br></pre></td></tr></table></figure>

<h4 id="问题2：响应缓慢或超时"><a href="#问题2：响应缓慢或超时" class="headerlink" title="问题2：响应缓慢或超时"></a>问题2：响应缓慢或超时</h4><p><strong>检查步骤：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查IP转发是否启用</span></span><br><span class="line"><span class="built_in">cat</span> /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查SNAT规则</span></span><br><span class="line">iptables -t nat -L -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看LVS连接统计</span></span><br><span class="line">ipvsadm -Ln --stats</span><br></pre></td></tr></table></figure>

<h4 id="问题3：某个服务器收不到请求"><a href="#问题3：某个服务器收不到请求" class="headerlink" title="问题3：某个服务器收不到请求"></a>问题3：某个服务器收不到请求</h4><p><strong>可能原因和解决：</strong></p>
<ul>
<li>真实服务器防火墙未关闭：<code>systemctl disable firewalld --now</code></li>
<li>Web服务器的默认网关不正确：检查网卡配置中是否有GATEWAY项</li>
<li>LVS配置中的权重不对：检查 <code>Weight</code> 值是否为0</li>
</ul>
<h2 id="五、如何搭建LVS-DR集群？"><a href="#五、如何搭建LVS-DR集群？" class="headerlink" title="五、如何搭建LVS-DR集群？"></a>五、如何搭建LVS-DR集群？</h2><h3 id="5-1-环境准备"><a href="#5-1-环境准备" class="headerlink" title="5.1 环境准备"></a>5.1 环境准备</h3><p>一台LVS服务器，两台后端服务器</p>
<ul>
<li>负载均衡器（Director）：192.168.118.90</li>
<li>真实服务器1（RS1）：192.168.118.91</li>
<li>真实服务器2（RS2）：192.168.118.92</li>
<li>虚拟IP（VIP）：192.168.118.100</li>
</ul>
<p>注意：都在同一网段</p>
<h3 id="5-2-LVS-DR安装和配置过程"><a href="#5-2-LVS-DR安装和配置过程" class="headerlink" title="5.2 LVS-DR安装和配置过程"></a>5.2 LVS-DR安装和配置过程</h3><h4 id="5-2-1-LVS服务器配置"><a href="#5-2-1-LVS服务器配置" class="headerlink" title="5.2.1 LVS服务器配置"></a>5.2.1 LVS服务器配置</h4><p>关闭防火墙和核心防护</p>
<p><img src="/./imgs/image-20251111193046400.png" alt="image-20251111193046400"></p>
<p>新建虚拟网卡ens33:0配置虚拟IP(VIP)192.168.118.100</p>
<p><img src="/./imgs/image-20251111193053341.png" alt="image-20251111193053341"></p>
<p>关闭路由转发等功能 &#x2F;etc&#x2F;sysctl.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 调整内核参数</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br><span class="line">net.ipv4.conf.all.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line"><span class="comment"># 启用配置</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251111193522601.png" alt="image-20251111193522601"></p>
<p><img src="/./imgs/image-20251111193528171.png" alt="image-20251111193528171"></p>
<p>下载ipvsadm进行后端地址池配置</p>
<p>ipvsadm -C清除规则，并配置调度和地址池</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清除规则</span></span><br><span class="line">ipvsadm -C</span><br><span class="line"><span class="comment"># 配置调度</span></span><br><span class="line">ipvsadm -A -t 192.168.10.180:80 -s rr</span><br><span class="line">ipvsadm -a -t 192.168.10.180:80 -r 192.168.10.16:80 -g</span><br><span class="line">ipvsadm -a -t 192.168.10.180:80 -r 192.168.10.17:80 -g</span><br><span class="line"><span class="comment"># 查看节点状态，Route代表DR模式</span></span><br><span class="line">ipvsadm -<span class="built_in">ln</span> </span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251111193600346.png" alt="image-20251111193600346"></p>
<p>开启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm</span><br></pre></td></tr></table></figure>

<h4 id="5-2-2-后端服务器配置"><a href="#5-2-2-后端服务器配置" class="headerlink" title="5.2.2 后端服务器配置"></a>5.2.2 后端服务器配置</h4><p>关闭防火墙和核心防护</p>
<p>配置<strong>回环网卡</strong>lo:0</p>
<p><img src="/./imgs/image-20251111193228011.png" alt="image-20251111193228011"></p>
<p>⭐添加路由将虚拟IP（VIP）绑定到本地环回接口的虚拟网卡上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add -host 192.168.118.100 dev lo:0</span><br></pre></td></tr></table></figure>

<p>ARP 参数调整，避免MAC冲突 &#x2F;etc&#x2F;sysctl.conf</p>
<p><img src="/./imgs/image-20251111193924580.png" alt="image-20251111193924580"></p>
<p>启动httpd服务</p>
<h3 id="5-3-LVS工作原理（DR模式）"><a href="#5-3-LVS工作原理（DR模式）" class="headerlink" title="5.3 LVS工作原理（DR模式）"></a>5.3 LVS工作原理（DR模式）</h3><p>LVS-DR(直接路由)接受用户请求时，IVS服务器负责接收请求，并转发给后端服务器，任务处理完后，后端服务器会<strong>使用虚拟IP</strong>(VIP)作为源IP，直接通过网关响应客户端(给予结果)</p>
<h4 id="5-3-1-相关概念介绍"><a href="#5-3-1-相关概念介绍" class="headerlink" title="5.3.1 相关概念介绍"></a>5.3.1 相关概念介绍</h4><p><strong>环回网卡lo</strong></p>
<p>环回网卡lo是一个虚拟网卡，用来让本机与自己通信。</p>
<p>作用：</p>
<ul>
<li><strong>本地测试</strong>：允许开发者在不连接外部网络的情况下测试网络应用程序。</li>
<li><strong>服务自检</strong>：系统服务可以使用环回接口来检查网络功能是否正常。</li>
<li><strong>内部通信</strong>：系统内部的不同进程可以通过环回接口进行通信。</li>
</ul>
<p><strong>ARP</strong></p>
<p>ARP是一个协议（相当于<strong>翻译官</strong>），用来通过<strong>IP地址找</strong>到对应的<strong>MAC地址</strong>。</p>
<h4 id="5-3-2-⭐数据流向"><a href="#5-3-2-⭐数据流向" class="headerlink" title="5.3.2 ⭐数据流向"></a>5.3.2 ⭐数据流向</h4><p><img src="/./imgs/image-20251111195008671.png" alt="image-20251111195008671"></p>
<p><strong>数据包走向文字描述：</strong></p>
<p>客户端：IP&#x3D;100，MAC&#x3D;10</p>
<p>Director：IP&#x3D;101，MAC&#x3D;11，VIP&#x3D;180(ens33:0)</p>
<p>RealServer1：IP&#x3D;102，MAC&#x3D;12，VIP&#x3D;180(lo:0)</p>
<p>RealServer2：IP&#x3D;103，MAC&#x3D;13，VIP&#x3D;180(lo:0)</p>
<p><strong>第1步：客户端发起请求</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">以太网头：</span><br><span class="line">  源MAC: 10 (客户端)</span><br><span class="line">  目的MAC: 11 (Director)</span><br><span class="line"></span><br><span class="line">IP头：</span><br><span class="line">  SIP: 100 (客户端)</span><br><span class="line">  DIP: 180 (VIP)</span><br><span class="line"></span><br><span class="line">TCP头：</span><br><span class="line">  源端口: 54321</span><br><span class="line">  目的端口: 80</span><br><span class="line"></span><br><span class="line">应用层：</span><br><span class="line">  GET / HTTP/1.1</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>第2步：数据包到达Director</strong></p>
<p>Director转发给RealServer1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">以太网头：</span><br><span class="line">  源MAC: 11 (Director)</span><br><span class="line">  目的MAC: 12 (RealServer1)  ← 改</span><br><span class="line"></span><br><span class="line">IP头：</span><br><span class="line">  SIP: 100 (保持！)</span><br><span class="line">  DIP: 180 (保持！)           ← 不改！</span><br><span class="line"></span><br><span class="line">TCP头：</span><br><span class="line">  源端口: 54321</span><br><span class="line">  目的端口: 80</span><br><span class="line"></span><br><span class="line">应用层：</span><br><span class="line">  GET / HTTP/1.1</span><br></pre></td></tr></table></figure>

<p><strong>只改MAC，IP全程保持100→180！</strong></p>
<hr>
<p><strong>第3步：数据包到达RealServer1</strong></p>
<p>RealServer1的内核：</p>
<ul>
<li>看到目的MAC&#x3D;12（我自己）✓</li>
<li>看到目的IP&#x3D;180（我有这个地址在lo:0上）✓</li>
<li>接收！</li>
</ul>
<p>应用程序接收连接。</p>
<hr>
<p><strong>第4步：RealServer1返回响应</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">以太网头：</span><br><span class="line">  源MAC: 12 (RealServer1)</span><br><span class="line">  目的MAC: 10 (客户端)</span><br><span class="line"></span><br><span class="line">IP头：</span><br><span class="line">  SIP: 100 (客户端！保持！)</span><br><span class="line">  DIP: 180 (VIP！保持！)</span><br><span class="line"></span><br><span class="line">TCP头：</span><br><span class="line">  源端口: 80</span><br><span class="line">  目的端口: 54321</span><br><span class="line"></span><br><span class="line">应用层：</span><br><span class="line">  HTTP/1.1 200 OK ...</span><br></pre></td></tr></table></figure>

<p><strong>IP也全程不变！从100到180，然后再从100回到180！</strong></p>
<hr>
<p><strong>完整对比：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">请求：</span><br><span class="line">客户 → Director: MAC(10→11), IP(100→180)</span><br><span class="line">Director → Server1: MAC(11→12), IP(100→180) ← IP不变！</span><br><span class="line"></span><br><span class="line">响应：</span><br><span class="line">Server1 → 客户: MAC(12→10), IP(100→180) ← IP仍然不变！</span><br></pre></td></tr></table></figure>

<ul>
<li>一直在跟IP&#x3D;180通信</li>
<li>MAC在变（从Director的11变成Server的12）</li>
<li>但IP始终是 100↔180</li>
</ul>
<p>客户端完全无感知。</p>
<h2 id="六、LVS的调度算法"><a href="#六、LVS的调度算法" class="headerlink" title="六、LVS的调度算法"></a>六、LVS的调度算法</h2><table>
<thead>
<tr>
<th>算法</th>
<th>说明</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>rr</td>
<td>轮询，依次分配请求</td>
<td>服务器性能相同</td>
</tr>
<tr>
<td>wrr</td>
<td>加权轮询，按权重分配</td>
<td>服务器性能不同</td>
</tr>
<tr>
<td>lc</td>
<td>最少连接，优先分配给连接少的服务器</td>
<td>长连接应用</td>
</tr>
<tr>
<td>wlc</td>
<td>加权最少连接</td>
<td>长连接且性能不同</td>
</tr>
<tr>
<td>lblc</td>
<td>基于目标地址的最少连接</td>
<td>缓存服务器</td>
</tr>
<tr>
<td>dh</td>
<td>目标地址哈希，同一源IP始终访问同一服务器</td>
<td>需要会话保持</td>
</tr>
<tr>
<td>sh</td>
<td>源地址哈希</td>
<td>需要会话保持</td>
</tr>
</tbody></table>
<h2 id="七、为什么需要LVS技术？"><a href="#七、为什么需要LVS技术？" class="headerlink" title="七、为什么需要LVS技术？"></a>七、为什么需要LVS技术？</h2><h3 id="7-1-性能角度"><a href="#7-1-性能角度" class="headerlink" title="7.1 性能角度"></a>7.1 性能角度</h3><p>LVS在内核层实现负载均衡，相比应用层的Nginx、HAProxy等方案，性能提升10倍以上，可轻松处理数百万并发连接。对于超大规模互联网应用，这种性能优势至关重要。</p>
<h3 id="7-2-可扩展性角度"><a href="#7-2-可扩展性角度" class="headerlink" title="7.2 可扩展性角度"></a>7.2 可扩展性角度</h3><p>通过添加真实服务器数量，可以线性扩展系统容量。单个负载均衡器理论上可支持数千台真实服务器，极大降低了扩展成本。</p>
<h3 id="7-3-可靠性角度"><a href="#7-3-可靠性角度" class="headerlink" title="7.3 可靠性角度"></a>7.3 可靠性角度</h3><p>结合Keepalived提供的虚拟IP转移和故障检测，当某个真实服务器故障时，自动将其移出集群，用户无感知。真正实现”7×24小时”不间断服务。</p>
<h3 id="7-4-成本角度"><a href="#7-4-成本角度" class="headerlink" title="7.4 成本角度"></a>7.4 成本角度</h3><p>LVS是开源免费软件，无许可费用。使用廉价的x86服务器就可以构建高性能集群，相比专业负载均衡硬件便宜数倍。</p>
<h3 id="7-5-运维角度"><a href="#7-5-运维角度" class="headerlink" title="7.5 运维角度"></a>7.5 运维角度</h3><p>配置相对稳定，一旦部署完成，日常维护工作量小。故障转移自动化，减轻运维负担。</p>
<h3 id="7-6-业务角度"><a href="#7-6-业务角度" class="headerlink" title="7.6 业务角度"></a>7.6 业务角度</h3><p>支持多种调度算法和会话保持机制，能够满足各类业务需求。不限制后端服务类型，可用于Web、数据库、缓存等任何服务。</p>
<h3 id="7-7-业界应用角度"><a href="#7-7-业界应用角度" class="headerlink" title="7.7 业界应用角度"></a>7.7 业界应用角度</h3><p>被阿里巴巴、腾讯、百度等互联网大厂广泛采用，经过百万级流量验证，生产级别稳定性已得到充分验证。</p>
<h2 id="八、LVS-vs-Nginx-vs-HAProxy-vs-SLB"><a href="#八、LVS-vs-Nginx-vs-HAProxy-vs-SLB" class="headerlink" title="八、LVS vs Nginx vs HAProxy vs SLB"></a>八、LVS vs Nginx vs HAProxy vs SLB</h2><table>
<thead>
<tr>
<th>对比项</th>
<th>Nginx</th>
<th>LVS</th>
<th>HAProxy</th>
<th>SLB</th>
</tr>
</thead>
<tbody><tr>
<td><strong>定位</strong></td>
<td>Web服务器 + 反向代理 + 负载均衡</td>
<td>内核级四层负载均衡</td>
<td>专业负载均衡器（四层 + 七层）</td>
<td>云服务负载均衡（四层 + 七层）</td>
</tr>
<tr>
<td><strong>工作层级</strong></td>
<td>四层（TCP）+ 七层（HTTP&#x2F;HTTPS）</td>
<td>四层（TCP&#x2F;UDP，传输层）</td>
<td>四层 + 七层</td>
<td>四层 + 七层</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>高（软件级，单机可达十万级并发）</td>
<td>极高（内核态，百万级并发）</td>
<td>高（接近Nginx，但更专注负载均衡）</td>
<td>极高（云端分布式，支持超高并发）</td>
</tr>
<tr>
<td><strong>功能特点</strong></td>
<td>- 静态资源服务<br/>- 反向代理<br/>- 缓存<br/>- 支持HTTP&#x2F;HTTPS负载均衡</td>
<td>- 高性能转发<br/>- 调度算法丰富（RR、LC、SH…）<br/>- 内核态转发，几乎无性能损耗</td>
<td>- 专注于负载均衡<br/>- 健康检查更强大<br/>- 支持会话保持、SSL卸载等</td>
<td>- 云原生架构<br/>- 自动扩容<br/>- DDoS防护<br/>- 多地域支持</td>
</tr>
<tr>
<td><strong>健康检查</strong></td>
<td>简单（TCP&#x2F;HTTP）</td>
<td>依赖Keepalived或其他工具</td>
<td>强大（多协议、多方式）</td>
<td>强大（多维度监控）</td>
</tr>
<tr>
<td><strong>配置复杂度</strong></td>
<td>简单</td>
<td>较复杂（需ipvsadm&#x2F;keepalived配合）</td>
<td>中等（配置文件灵活）</td>
<td>简单（可视化管理）</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>Web代理、动静分离、中小型集群</td>
<td>超大规模集群、核心四层调度</td>
<td>高可用集群、对健康检查要求高的业务</td>
<td>云上应用、互联网业务、弹性扩展场景</td>
</tr>
<tr>
<td><strong>优点</strong></td>
<td>功能多，易上手</td>
<td>性能最强，稳定</td>
<td>专业负载均衡，健康检查强</td>
<td>完全托管，无需运维，功能齐全</td>
</tr>
<tr>
<td><strong>缺点</strong></td>
<td>七层性能不如LVS&#x2F;HAProxy</td>
<td>只能四层，配置偏复杂</td>
<td>不自带Web服务</td>
<td>成本较高，依赖云厂商</td>
</tr>
</tbody></table>
<p><strong>选择建议</strong>：</p>
<ul>
<li>追求极致性能和承载海量并发：选LVS</li>
<li>需要丰富功能和简单配置：选Nginx</li>
<li>需要强大的会话管理和复杂规则：选HAProxy</li>
<li>实际应用中通常组合使用：LVS + Nginx&#x2F;HAProxy双层架构</li>
</ul>
<h2 id="九、总结"><a href="#九、总结" class="headerlink" title="九、总结"></a>九、总结</h2><p>LVS是一项经过十多年历史验证、在互联网大规模应用中屹立不倒的技术。它以简洁的设计、卓越的性能和强大的稳定性，在超大规模高并发场景中展现出无与伦比的优势。</p>
<p>虽然在小规模应用中不如Nginx灵活，但在构建支撑数千万用户的互联网平台时，LVS是实现高可用、高性能集群的最佳选择。掌握LVS的原理和部署方式，对于成长为高级运维工程师或架构师来说，是必备的技能。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">Felix</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2025/11/08/LVS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9B%86%E7%BE%A4/">http://example.com/2025/11/08/LVS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9B%86%E7%BE%A4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/imgs/adater.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/11/11/NFS%E6%A6%82%E5%BF%B5%E5%8F%8A%E9%85%8D%E7%BD%AE/" title="NFS概念及配置"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">NFS概念及配置</div></div><div class="info-2"><div class="info-item-1">NFS概念及配置NFS与NAS基础什么是NFS（Network File System）？NFS是一个网络文件系统协议，允许不同计算机之间通过网络共享文件系统，就像访问本地磁盘一样访问远程存储。NFS基于客户端-服务器架构，运行在应用层和传输层之间。  ⭐NFS的作用：  给其他服务器分担存储压力 服务器的利旧使用  NFS的关键特点：  透明性：客户端可以像访问本地文件一样访问远程文件，应用程序无需修改 网络性：基于网络协议实现，支持跨网络共享 无状态性：NFS服务器不维护客户端的连接状态，故障恢复简单 性能：相比其他网络文件系统，NFS性能较好，适合LAN环境  NFS版本演进：  NFSv3：支持大文件（&gt;2GB），异步写入，广泛应用 NFSv4：支持强认证、加密、状态管理，更安全，当前主流版本  什么是NAS（Network Attached Storage）？NAS是一个存储设备，通过网络为多个用户和应用程序提供文件级数据访问。NAS实际上是安装了操作系统和存储软件的专用计算机，支持多种文件共享协议（NFS、SMB&#x2F;CIFS等）。 NFS与NAS区别： ...</div></div></div></a><a class="pagination-related" href="/2025/11/07/Kubernetes/" title="Kubernetes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Kubernetes</div></div><div class="info-2"><div class="info-item-1">Kubernetes一、初识Kubernetes1.1 启动 Kubernetes 集群使用 Minikube 启动并验证本地 Kubernetes 集群。Minikube 提供了一种简单方式来设置用于学习和开发的单节点 Kubernetes 环境。 启动minikube 1minikube start   查看集群状态 1minikube status   检查集群节点 1kubectl get nodes     Minikube 启动成功 本地 Kubernetes 集群正在运行 集群已准备就绪 您有一个具有控制平面功能的单节点集群   Minikube 集群在本地机器上提供了完整的 Kubernetes 环境，允许在不需要多节点集群的情况下开发和测试应用程序。 1.2 Kubernetes架构概述核心模型Kubernetes 采用客户端-服务器模型运行：  开发者 通过 kubectl 命令行工具与集群交互 控制平面 是集群的大脑，做出决策和管理状态 工作节点 运行实际的应用程序容器   控制平面（集群的”大脑”）控制平面由四个关键组件组成：    组件 简称 职责   ...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/imgs/adater.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Felix</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/falsezxy"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#LVS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9B%86%E7%BE%A4"><span class="toc-number">1.</span> <span class="toc-text">LVS负载均衡集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFLVS%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">一、什么是LVS？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81LVS%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">二、LVS的工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 基本架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E4%B8%89%E7%A7%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 三种负载均衡模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NAT%E6%A8%A1%E5%BC%8F%EF%BC%88Network-Address-Translation%EF%BC%89"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">NAT模式（Network Address Translation）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DR%E6%A8%A1%E5%BC%8F%EF%BC%88Direct-Routing%EF%BC%89"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">DR模式（Direct Routing）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TUN%E6%A8%A1%E5%BC%8F%EF%BC%88IP-Tunneling%EF%BC%89"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">TUN模式（IP Tunneling）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 工作流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81LVS%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.3.</span> <span class="toc-text">三、LVS能做什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E9%AB%98%E6%80%A7%E8%83%BD%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 高性能负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 高可用部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%A4%9A%E7%A7%8D%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%E6%94%AF%E6%8C%81"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 多种调度算法支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E9%80%82%E5%BA%94%E5%A4%9A%E7%A7%8D%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 适应多种应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E4%B8%8EKeepalived%E7%BB%93%E5%90%88%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">1.3.5.</span> <span class="toc-text">3.5 与Keepalived结合实现高可用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BALVS-NAT%E9%9B%86%E7%BE%A4%EF%BC%9F"><span class="toc-number">1.4.</span> <span class="toc-text">四、如何搭建LVS-NAT集群？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%9C%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8%E4%B8%8A%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AELVS"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 在负载均衡器上安装并配置LVS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-%E5%90%AF%E7%94%A8IP%E8%BD%AC%E5%8F%91%E5%8A%9F%E8%83%BD%E2%AD%90"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">4.2.1 启用IP转发功能⭐</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-%E9%85%8D%E7%BD%AESNAT%E8%BD%AC%E5%8F%91%E8%A7%84%E5%88%99%E2%AD%90"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">4.2.2 配置SNAT转发规则⭐</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-%E6%B8%85%E9%99%A4%E5%8E%9F%E6%9C%89%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">4.2.3 清除原有防火墙规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-%E5%AE%89%E8%A3%85ipvsadm%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">4.2.4 安装ipvsadm管理工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-5-%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">4.2.5 配置负载分配策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-6-%E4%BF%9D%E5%AD%98LVS%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.2.6.</span> <span class="toc-text">4.2.6 保存LVS配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-7-%E9%AA%8C%E8%AF%81%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.2.7.</span> <span class="toc-text">4.2.7 验证配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-LVS%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%EF%BC%88NAT%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 LVS工作原理（NAT模式）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">请求流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">响应流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 测试验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="toc-number">1.4.5.</span> <span class="toc-text">4.5 常见问题排查</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%981%EF%BC%9AWeb%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE"><span class="toc-number">1.4.5.1.</span> <span class="toc-text">问题1：Web服务器无法访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%982%EF%BC%9A%E5%93%8D%E5%BA%94%E7%BC%93%E6%85%A2%E6%88%96%E8%B6%85%E6%97%B6"><span class="toc-number">1.4.5.2.</span> <span class="toc-text">问题2：响应缓慢或超时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%983%EF%BC%9A%E6%9F%90%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%94%B6%E4%B8%8D%E5%88%B0%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.5.3.</span> <span class="toc-text">问题3：某个服务器收不到请求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BALVS-DR%E9%9B%86%E7%BE%A4%EF%BC%9F"><span class="toc-number">1.5.</span> <span class="toc-text">五、如何搭建LVS-DR集群？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-LVS-DR%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 LVS-DR安装和配置过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-LVS%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">5.2.1 LVS服务器配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">5.2.2 后端服务器配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-LVS%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%EF%BC%88DR%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 LVS工作原理（DR模式）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">5.3.1 相关概念介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-%E2%AD%90%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">5.3.2 ⭐数据流向</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81LVS%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">1.6.</span> <span class="toc-text">六、LVS的调度算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81LVS%E6%8A%80%E6%9C%AF%EF%BC%9F"><span class="toc-number">1.7.</span> <span class="toc-text">七、为什么需要LVS技术？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E6%80%A7%E8%83%BD%E8%A7%92%E5%BA%A6"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 性能角度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7%E8%A7%92%E5%BA%A6"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 可扩展性角度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E5%8F%AF%E9%9D%A0%E6%80%A7%E8%A7%92%E5%BA%A6"><span class="toc-number">1.7.3.</span> <span class="toc-text">7.3 可靠性角度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E6%88%90%E6%9C%AC%E8%A7%92%E5%BA%A6"><span class="toc-number">1.7.4.</span> <span class="toc-text">7.4 成本角度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E8%BF%90%E7%BB%B4%E8%A7%92%E5%BA%A6"><span class="toc-number">1.7.5.</span> <span class="toc-text">7.5 运维角度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-%E4%B8%9A%E5%8A%A1%E8%A7%92%E5%BA%A6"><span class="toc-number">1.7.6.</span> <span class="toc-text">7.6 业务角度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-%E4%B8%9A%E7%95%8C%E5%BA%94%E7%94%A8%E8%A7%92%E5%BA%A6"><span class="toc-number">1.7.7.</span> <span class="toc-text">7.7 业界应用角度</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81LVS-vs-Nginx-vs-HAProxy-vs-SLB"><span class="toc-number">1.8.</span> <span class="toc-text">八、LVS vs Nginx vs HAProxy vs SLB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">1.9.</span> <span class="toc-text">九、总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/18/CI%20CD%20%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Ruo-Yi%E9%A1%B9%E7%9B%AE/" title="CI/CD持续集成Ruo-Yi项目">CI/CD持续集成Ruo-Yi项目</a><time datetime="2025-12-18T11:27:44.000Z" title="Created 2025-12-18 19:27:44">2025-12-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/18/jenkins%E9%83%A8%E7%BD%B2ruoyi%E9%A1%B9%E7%9B%AE/" title="jenkins部署ruoyi项目">jenkins部署ruoyi项目</a><time datetime="2025-12-18T01:44:25.000Z" title="Created 2025-12-18 09:44:25">2025-12-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/17/Kubernets-network_rbac_hpa/" title="Kubernetes 网络、RBAC 和 HPA 相关知识">Kubernetes 网络、RBAC 和 HPA 相关知识</a><time datetime="2025-12-17T10:34:40.000Z" title="Created 2025-12-17 18:34:40">2025-12-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/" title="Kubernetes-Ingress服务">Kubernetes-Ingress服务</a><time datetime="2025-12-16T10:12:58.000Z" title="Created 2025-12-16 18:12:58">2025-12-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/16/Kubernetes%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86/" title="Kubernetes存储管理">Kubernetes存储管理</a><time datetime="2025-12-16T01:35:04.000Z" title="Created 2025-12-16 09:35:04">2025-12-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/imgs/background_footer.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Felix</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.0.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.1"></script><script src="/js/main.js?v=5.5.1"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>