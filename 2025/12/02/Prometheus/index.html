<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Prometheus监控系统 | Felix的个人博客</title><meta name="author" content="Felix"><meta name="copyright" content="Felix"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Prometheus 监控系统目录 [Prometheus 基础介绍][##第一部分：Prometheus 基础介绍] [进阶内容](##第二部分：Prometheus 进阶) 实验部署 总结   第一部分：Prometheus 基础介绍1.1 什么是 Prometheus？Prometheus 是一个开源的服务监控系统和时序数据库，具有以下特点：  提供通用的数据模型和快捷的数据采集、存储和查询">
<meta property="og:type" content="article">
<meta property="og:title" content="Prometheus监控系统">
<meta property="og:url" content="http://example.com/2025/12/02/Prometheus/index.html">
<meta property="og:site_name" content="Felix的个人博客">
<meta property="og:description" content="Prometheus 监控系统目录 [Prometheus 基础介绍][##第一部分：Prometheus 基础介绍] [进阶内容](##第二部分：Prometheus 进阶) 实验部署 总结   第一部分：Prometheus 基础介绍1.1 什么是 Prometheus？Prometheus 是一个开源的服务监控系统和时序数据库，具有以下特点：  提供通用的数据模型和快捷的数据采集、存储和查询">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/imgs/adater.jpg">
<meta property="article:published_time" content="2025-12-02T00:55:58.000Z">
<meta property="article:modified_time" content="2025-12-02T03:17:39.016Z">
<meta property="article:author" content="Felix">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/imgs/adater.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Prometheus监控系统",
  "url": "http://example.com/2025/12/02/Prometheus/",
  "image": "http://example.com/imgs/adater.jpg",
  "datePublished": "2025-12-02T00:55:58.000Z",
  "dateModified": "2025-12-02T03:17:39.016Z",
  "author": [
    {
      "@type": "Person",
      "name": "Felix",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2025/12/02/Prometheus/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Prometheus监控系统',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.0.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/imgs/background_header.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Felix的个人博客</span></a><a class="nav-page-title" href="/"><span class="site-name">Prometheus监控系统</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">Prometheus监控系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-12-02T00:55:58.000Z" title="Created 2025-12-02 08:55:58">2025-12-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-12-02T03:17:39.016Z" title="Updated 2025-12-02 11:17:39">2025-12-02</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Prometheus-监控系统"><a href="#Prometheus-监控系统" class="headerlink" title="Prometheus 监控系统"></a>Prometheus 监控系统</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>[Prometheus 基础介绍][##第一部分：Prometheus 基础介绍]</li>
<li>[进阶内容](##第二部分：Prometheus 进阶)</li>
<li><a href="##%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9A%E5%AE%9E%E9%AA%8C%E9%83%A8%E7%BD%B2">实验部署</a></li>
<li><a href="##%E6%80%BB%E7%BB%93">总结</a></li>
</ol>
<hr>
<h2 id="第一部分：Prometheus-基础介绍"><a href="#第一部分：Prometheus-基础介绍" class="headerlink" title="第一部分：Prometheus 基础介绍"></a>第一部分：Prometheus 基础介绍</h2><h3 id="1-1-什么是-Prometheus？"><a href="#1-1-什么是-Prometheus？" class="headerlink" title="1.1 什么是 Prometheus？"></a>1.1 什么是 Prometheus？</h3><p>Prometheus 是一个开源的服务监控系统和时序数据库，具有以下特点：</p>
<ul>
<li>提供通用的数据模型和快捷的数据采集、存储和查询接口</li>
<li>核心组件 Prometheus Server 会<strong>定期</strong>从监控目标中拉取数据</li>
<li>新拉取到的数据会<strong>持久化</strong>到存储设备中</li>
<li>支持基于<strong>时间序列</strong>的数据处理</li>
</ul>
<h3 id="1-2-Prometheus-的核心特点"><a href="#1-2-Prometheus-的核心特点" class="headerlink" title="1.2 Prometheus 的核心特点"></a>1.2 Prometheus 的核心特点</h3><h4 id="多维数据模型"><a href="#多维数据模型" class="headerlink" title="多维数据模型"></a>多维数据模型</h4><ul>
<li>由度量名称和键值对标签唯一标识的时间序列数据</li>
<li><strong>时间序列数据</strong>：按照时间顺序记录系统、设备状态变化的数据</li>
<li><strong>样本数据</strong>：每个数据点称为一个样本</li>
</ul>
<h4 id="内置时间序列数据库（TSDB）"><a href="#内置时间序列数据库（TSDB）" class="headerlink" title="内置时间序列数据库（TSDB）"></a>内置时间序列数据库（TSDB）</h4><ul>
<li>Prometheus 使用自己<strong>内置</strong>的 TSDB 存储数据</li>
<li>外置的远端存储可使用 InfluxDB、OpenTSDB 等</li>
</ul>
<h4 id="灵活的查询语言"><a href="#灵活的查询语言" class="headerlink" title="灵活的查询语言"></a>灵活的查询语言</h4><ul>
<li>PromQL：一种灵活的查询语言，可以利用多维数据完成复杂查询</li>
</ul>
<h4 id="数据采集方式"><a href="#数据采集方式" class="headerlink" title="数据采集方式"></a>数据采集方式</h4><ul>
<li>基于 HTTP 的 pull（拉取）方式采集时间序列数据</li>
<li>同时支持 PushGateway 组件进行数据推送</li>
<li>通过静态配置或服务发现发现目标</li>
</ul>
<h4 id="可视化与告警"><a href="#可视化与告警" class="headerlink" title="可视化与告警"></a>可视化与告警</h4><ul>
<li>支持作为数据源接入 Grafana</li>
<li>支持告警机制，可与 Alertmanager 集成</li>
</ul>
<h3 id="1-3-Prometheus-配置文件详解"><a href="#1-3-Prometheus-配置文件详解" class="headerlink" title="1.3 Prometheus 配置文件详解"></a>1.3 Prometheus 配置文件详解</h3><p>Prometheus 的配置文件通常为 <code>prometheus.yml</code>，由四个主要部分组成：</p>
<h4 id="配置文件四大部分"><a href="#配置文件四大部分" class="headerlink" title="配置文件四大部分"></a>配置文件四大部分</h4><p><strong>1. 全局配置（Global Configuration）</strong></p>
<ul>
<li><strong>主要作用</strong>：配置 Prometheus Server 全局的数据采集参数</li>
<li><strong>scrape_interval</strong>：设置抓取数据的频率，默认为 1 分钟（这里示例设置为 15 秒）</li>
<li><strong>evaluation_interval</strong>：评估告警规则的刷新频次，默认为 1 分钟（这里示例设置为 15 秒）</li>
<li><strong>scrape_timeout</strong>：数据采集的超时时间，默认为 10 秒</li>
<li>更短的采集间隔能够获得更及时的数据，但会增加系统负担</li>
</ul>
<p><strong>2. 告警通知配置（Alerting Configuration）</strong></p>
<ul>
<li><strong>主要作用</strong>：配置 Alertmanager 实例的连接信息</li>
<li>Prometheus 自己没有能力进行告警通知（例如对接钉钉告警）</li>
<li>需要借助其他插件进行告警通知，如 Alertmanager</li>
<li>配置静态的 Alertmanager 地址或基于服务发现动态发现 Alertmanager 实例</li>
</ul>
<p><strong>3. 告警规则配置（Rule Files Configuration）</strong></p>
<ul>
<li><strong>主要作用</strong>：加载告警规则文件</li>
<li>用于判断是否有必要进行告警</li>
<li>需要给定规则的判断标准（*.yml 文件）</li>
<li>支持文件名通配符机制（如 <code>alert_rules/*.yaml</code>）</li>
</ul>
<p><strong>4. 指标数据抓取配置（Scrape Configs）</strong></p>
<ul>
<li><strong>主要作用</strong>：描述如何抓取指标数据</li>
<li>定义要监控的目标（targets）和抓取规则</li>
<li>通常 Prometheus 使用 pull 的方式抓取数据（HTTP 协议）</li>
<li>也可以通过 Pushgateway 推送网关这个组件主动推送数据给 Prometheus</li>
</ul>
<h4 id="配置文件示例"><a href="#配置文件示例" class="headerlink" title="配置文件示例"></a>配置文件示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span>      <span class="comment"># 采集数据的频率设置为 15 秒，默认为 1 分钟</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span>  <span class="comment"># 评估告警规则的刷新频次为 15 秒，默认为 1 分钟</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">10s</span>       <span class="comment"># 抓取数据超时时间为 10 秒（全局默认）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alertmanager 配置</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">alertmanager:9093</span>   <span class="comment"># Alertmanager 的地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载告警规则文件</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;first_rules.yml&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;second_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指标数据抓取的配置</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># job_name 被添加为标签 job=&lt;job_name&gt; 到任何通过此配置抓取的时间序列</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;prometheus&quot;</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">&#x27;/metrics&#x27;</span>  <span class="comment"># 指标数据采集路径，默认为 /metrics</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">&#x27;http&#x27;</span>            <span class="comment"># 协议，默认为 http</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9090&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202095150911.png" alt="image-20251202095150911"></p>
<h3 id="1-4-日志与监控的区别"><a href="#1-4-日志与监控的区别" class="headerlink" title="1.4 日志与监控的区别"></a>1.4 日志与监控的区别</h3><p>根据事件发生的时间阶段，日志和监控有本质的不同：</p>
<table>
<thead>
<tr>
<th>维度</th>
<th>日志</th>
<th>监控</th>
</tr>
</thead>
<tbody><tr>
<td><strong>时间阶段</strong></td>
<td>事中记录、事后追溯</td>
<td>事前、事中、事后</td>
</tr>
<tr>
<td><strong>功能定位</strong></td>
<td>记录和分析工具</td>
<td>观测、提醒通知、告警工具</td>
</tr>
<tr>
<td><strong>应用特性</strong></td>
<td>被动记录已发生的事件</td>
<td>主动观测系统状态变化</td>
</tr>
<tr>
<td><strong>针对性</strong></td>
<td>较弱，事后分析</td>
<td>更具有针对性</td>
</tr>
<tr>
<td><strong>数据依据</strong></td>
<td>为事后追溯提供依据</td>
<td>为优化、升级、故障处理提供数据依据</td>
</tr>
<tr>
<td><strong>时效性</strong></td>
<td>相对滞后</td>
<td>实时或准实时</td>
</tr>
<tr>
<td><strong>管理作用</strong></td>
<td>事件溯源</td>
<td>系统管理人员的”眼睛”</td>
</tr>
</tbody></table>
<p><strong>核心认知：无监控不运维</strong></p>
<p>监控系统能够为项目的健壮性提供持续性的优化、升级、故障处理以及改造的数据依据，是管理人员实时了解系统状态的重要工具。</p>
<h3 id="1-6-Prometheus-的工作模式"><a href="#1-6-Prometheus-的工作模式" class="headerlink" title="1.6 Prometheus 的工作模式"></a>1.6 Prometheus 的工作模式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Prometheus 工作流程                        │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│ 1. 通过 Service Discovery 发现监控目标                         │</span><br><span class="line">│ 2. Prometheus Server 通过 pull 方式抓取指标数据                │</span><br><span class="line">│ 3. 或通过 Pushgateway 接收 push 方式推送的数据                  │</span><br><span class="line">│ 4. 数据通过 TSDB 存储到本地磁盘（默认 15 天）                    │</span><br><span class="line">│ 5. 根据告警规则生成告警通知发送到 Alertmanager                   │</span><br><span class="line">│ 6. Alertmanager 进行分组、去重、路由和发送告警                   │</span><br><span class="line">│ 7. 用户通过 Web UI 使用 PromQL 查询监控数据                     │</span><br><span class="line">│ 8. Grafana 可接入 Prometheus 数据源进行图形化展示               │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202100941705.png" alt="image-20251202100941705"></p>
<h3 id="1-7-Prometheus-生态圈组件详解"><a href="#1-7-Prometheus-生态圈组件详解" class="headerlink" title="1.7 Prometheus 生态圈组件详解"></a>1.7 Prometheus 生态圈组件详解</h3><h4 id="（1）Prometheus-Server"><a href="#（1）Prometheus-Server" class="headerlink" title="（1）Prometheus Server"></a>（1）Prometheus Server</h4><p>核心组件，负责数据收集和存储。由三个部分组成：</p>
<ul>
<li><strong>Retrieval</strong>：负责在活跃的 target 主机上抓取监控指标数据</li>
<li><strong>Storage</strong>：存储模块，主要把采集到的数据存储到磁盘，默认为 15 天</li>
<li><strong>PromQL</strong>：Prometheus 提供的查询语言模块</li>
</ul>
<h4 id="（2）Client-Library（客户端库）"><a href="#（2）Client-Library（客户端库）" class="headerlink" title="（2）Client Library（客户端库）"></a>（2）Client Library（客户端库）</h4><ul>
<li>为期望原生提供 Instrumentation 功能的应用程序提供便捷的开发途径</li>
<li>用于基于应用程序内建的测量系统</li>
</ul>
<h4 id="（3）Exporters（指标暴露器）"><a href="#（3）Exporters（指标暴露器）" class="headerlink" title="（3）Exporters（指标暴露器）"></a>（3）Exporters（指标暴露器）</h4><p>负责收集不支持内建 Instrumentation 的应用程序或服务的性能指标数据，通过 HTTP 接口供 Prometheus Server 获取。</p>
<p><strong>常用的 Exporters：</strong></p>
<table>
<thead>
<tr>
<th>Exporter 名称</th>
<th>功能描述</th>
<th>监控内容</th>
</tr>
</thead>
<tbody><tr>
<td>Node-Exporter</td>
<td>收集服务器节点的物理指标</td>
<td>CPU、内存、磁盘、网络等系统资源</td>
</tr>
<tr>
<td>mysqld-exporter</td>
<td>MySQL 数据库监控</td>
<td>数据库性能指标</td>
</tr>
<tr>
<td>nginx-exporter</td>
<td>Nginx Web 服务器监控</td>
<td>请求数、响应时间等</td>
</tr>
<tr>
<td>Kube-State-Metrics</td>
<td>Kubernetes 资源监控</td>
<td>Pod、Deployment、Service 等状态</td>
</tr>
<tr>
<td>cAdvisor</td>
<td>容器资源监控</td>
<td>CPU、内存、网络 I&#x2F;O、磁盘 I&#x2F;O</td>
</tr>
<tr>
<td>blackbox-exporter</td>
<td>业务容器存活性监控</td>
<td>服务可用性检测</td>
</tr>
</tbody></table>
<h4 id="（4）Service-Discovery（服务发现）"><a href="#（4）Service-Discovery（服务发现）" class="headerlink" title="（4）Service Discovery（服务发现）"></a>（4）Service Discovery（服务发现）</h4><p>用于动态发现待监控的 Target。支持多种服务发现机制：</p>
<ul>
<li>文件服务发现</li>
<li>DNS 服务发现</li>
<li>Consul 服务发现</li>
<li>Kubernetes API 服务发现</li>
<li>其他第三方服务发现</li>
</ul>
<h4 id="（5）Alertmanager（告警管理器）"><a href="#（5）Alertmanager（告警管理器）" class="headerlink" title="（5）Alertmanager（告警管理器）"></a>（5）Alertmanager（告警管理器）</h4><p>独立的告警模块，从 Prometheus Server 接收告警通知后，进行以下操作：</p>
<ul>
<li><strong>去重</strong>：过滤重复告警</li>
<li><strong>分组</strong>：将相似告警合并为单个通知</li>
<li><strong>路由</strong>：根据配置规则将告警路由到相应接收方</li>
<li><strong>发送</strong>：通过邮件、钉钉、企业微信等方式发送告警</li>
</ul>
<h4 id="（6）Pushgateway（推送网关）"><a href="#（6）Pushgateway（推送网关）" class="headerlink" title="（6）Pushgateway（推送网关）"></a>（6）Pushgateway（推送网关）</h4><p>类似一个中转站，用于接收 push 方式推送的数据：</p>
<ul>
<li>某些节点因为某些原因只能使用 push 方式推送数据</li>
<li>目标主机可上报短期任务的数据到 Pushgateway</li>
<li>Prometheus Server 统一从 Pushgateway 拉取数据</li>
</ul>
<h4 id="（7）Grafana（可视化工具）"><a href="#（7）Grafana（可视化工具）" class="headerlink" title="（7）Grafana（可视化工具）"></a>（7）Grafana（可视化工具）</h4><p>跨平台的开源度量分析和可视化工具：</p>
<ul>
<li>将采集的数据可视化展示</li>
<li>及时通知告警接收方</li>
<li>官方库中具有丰富的仪表盘插件</li>
</ul>
<h3 id="1-5-Prometheus-的局限性"><a href="#1-5-Prometheus-的局限性" class="headerlink" title="1.5 Prometheus 的局限性"></a>1.5 Prometheus 的局限性</h3><ul>
<li><strong>不适合存储事件及日志</strong>：Prometheus 是指标监控系统，展示的是趋势性监控，而非精准数据</li>
<li><strong>短期数据存储设计</strong>：本地存储的设计初衷只是保存短期（如一个月）数据，不支持针对大量历史数据的存储</li>
<li><strong>集群机制成熟度不高</strong>：可基于 Thanos 或 Cortex 实现 Prometheus 集群的高可用及联邦集群</li>
</ul>
<h3 id="1-6-TSDB-为什么适合-Prometheus？"><a href="#1-6-TSDB-为什么适合-Prometheus？" class="headerlink" title="1.6 TSDB 为什么适合 Prometheus？"></a>1.6 TSDB 为什么适合 Prometheus？</h3><p>Prometheus 采用 TSDB 作为存储引擎，完美契合监控数据的应用场景：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>存储数据量级</td>
<td>十分庞大</td>
</tr>
<tr>
<td>写入操作</td>
<td>大部分时间都是写入操作</td>
</tr>
<tr>
<td>数据顺序</td>
<td>几乎是顺序添加，数据以时间排序</td>
</tr>
<tr>
<td>数据更新</td>
<td>很少更新数据</td>
</tr>
<tr>
<td>删除操作</td>
<td>一般为区块删除，很少单独删除</td>
</tr>
<tr>
<td>缓存效果</td>
<td>基本数据大，超过内存大小，缓存几乎不起作用</td>
</tr>
<tr>
<td>读操作</td>
<td>典型的升序或降序顺序读</td>
</tr>
<tr>
<td>并发</td>
<td>高并发的读操作十分常见</td>
</tr>
</tbody></table>
<hr>
<h2 id="第二部分：Prometheus-进阶"><a href="#第二部分：Prometheus-进阶" class="headerlink" title="第二部分：Prometheus 进阶"></a>第二部分：Prometheus 进阶</h2><h3 id="2-1-PromQL-简介"><a href="#2-1-PromQL-简介" class="headerlink" title="2.1 PromQL 简介"></a>2.1 PromQL 简介</h3><p>PromQL（Prometheus Query Language）是 Prometheus 内置的数据查询语言，支持实时的数据查询及聚合操作。</p>
<p><strong>基本概念：</strong></p>
<ul>
<li>Prometheus 基于指标名称（metrics name）以及附属的标签集（labelset）唯一定义一条时间序列</li>
<li>指标名称代表着监控目标上某类可测量属性的基本特征标识</li>
<li>标签是这个基本特征上再次细分的多个可测量维度</li>
</ul>
<h3 id="2-2-Prometheus-数据模型"><a href="#2-2-Prometheus-数据模型" class="headerlink" title="2.2 Prometheus 数据模型"></a>2.2 Prometheus 数据模型</h3><p>格式为：<code>&lt;metric_name&gt;{&lt;label_name&gt;=&lt;label_value&gt;, ...}</code></p>
<p><strong>示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prometheus_http_requests_total&#123;code=&quot;200&quot;, job=&quot;prometheus&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>prometheus_http_requests_total</code> 是指标名称</li>
<li><code>code=&quot;200&quot;</code> 和 <code>job=&quot;prometheus&quot;</code> 是标签</li>
</ul>
<p><strong>系统默认标签（双下划线标签）：</strong></p>
<table>
<thead>
<tr>
<th>标签名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>__address__</code></td>
<td>当前 target 实例的套接字地址 <code>&lt;host&gt;:&lt;port&gt;</code></td>
</tr>
<tr>
<td><code>__scheme__</code></td>
<td>采集当前 target 上指标数据时使用的协议（http 或 https）</td>
</tr>
<tr>
<td><code>__metrics_path__</code></td>
<td>采集当前 target 上的指标数据时使用的 URI 路径，默认为 &#x2F;metrics</td>
</tr>
<tr>
<td><code>__param_&lt;name&gt;</code></td>
<td>传递的 URL 参数中第一个名称为 <code>&lt;name&gt;</code> 的参数的值</td>
</tr>
<tr>
<td><code>__name__</code></td>
<td>标识指标名称的预留标签</td>
</tr>
</tbody></table>
<h3 id="2-3-样本数据格式"><a href="#2-3-样本数据格式" class="headerlink" title="2.3 样本数据格式"></a>2.3 样本数据格式</h3><p>Prometheus 的每个数据样本由两部分组成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">prometheus_http_requests_total&#123;code=&quot;200&quot;&#125;  @1434317560885  28</span><br><span class="line">├─ 指标名称和标签 ────────────┤  ├─ 时间戳 ──┤  ├样本值</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>毫秒精度的时间戳</strong></li>
<li><strong>float64 格式的数据</strong></li>
</ul>
<h3 id="2-4-PromQL-的数据类型"><a href="#2-4-PromQL-的数据类型" class="headerlink" title="2.4 PromQL 的数据类型"></a>2.4 PromQL 的数据类型</h3><p>PromQL 的表达式中支持 4 种数据类型：</p>
<h4 id="（1）瞬时向量-Instant-Vector"><a href="#（1）瞬时向量-Instant-Vector" class="headerlink" title="（1）瞬时向量 (Instant Vector)"></a>（1）瞬时向量 (Instant Vector)</h4><p>特定或全部的时间序列集合上，具有相同时间戳的一组样本值。</p>
<h4 id="（2）区间向量-Range-Vector"><a href="#（2）区间向量-Range-Vector" class="headerlink" title="（2）区间向量 (Range Vector)"></a>（2）区间向量 (Range Vector)</h4><p>特定或全部的时间序列集合上，在指定的同一时间范围内的所有样本值。</p>
<h4 id="（3）标量数据-Scalar"><a href="#（3）标量数据-Scalar" class="headerlink" title="（3）标量数据 (Scalar)"></a>（3）标量数据 (Scalar)</h4><p>一个浮点型的数据值。</p>
<h4 id="（4）字符串-String"><a href="#（4）字符串-String" class="headerlink" title="（4）字符串 (String)"></a>（4）字符串 (String)</h4><p>一个字符串，支持使用单引号、双引号进行引用。</p>
<h3 id="2-5-时间序列选择器"><a href="#2-5-时间序列选择器" class="headerlink" title="2.5 时间序列选择器"></a>2.5 时间序列选择器</h3><h4 id="瞬时向量选择器（Instant-Vector-Selectors）"><a href="#瞬时向量选择器（Instant-Vector-Selectors）" class="headerlink" title="瞬时向量选择器（Instant Vector Selectors）"></a>瞬时向量选择器（Instant Vector Selectors）</h4><p>可以返回 0 个、1 个或多个时间序列上在给定时间戳上的各自的一个样本。</p>
<p><strong>三种组合方式：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 仅给定指标名称</span><br><span class="line">prometheus_http_requests_total</span><br><span class="line"></span><br><span class="line"># 仅给定标签选择器</span><br><span class="line">&#123;code=&quot;200&quot;, job=&quot;prometheus&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 指标名称和标签选择器的组合</span><br><span class="line">prometheus_http_requests_total&#123;code=&quot;200&quot;, job=&quot;prometheus&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>标签匹配操作符：</strong></p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>=</code></td>
<td>完全相等</td>
</tr>
<tr>
<td><code>!=</code></td>
<td>不相等</td>
</tr>
<tr>
<td><code>=~</code></td>
<td>正则表达式匹配</td>
</tr>
<tr>
<td><code>!~</code></td>
<td>正则表达式不匹配</td>
</tr>
</tbody></table>
<h4 id="区间向量选择器（Range-Vector-Selectors）"><a href="#区间向量选择器（Range-Vector-Selectors）" class="headerlink" title="区间向量选择器（Range Vector Selectors）"></a>区间向量选择器（Range Vector Selectors）</h4><p>可以返回 0 个、1 个或多个时间序列上在给定时间范围内的各自的一组样本。</p>
<p>通过在瞬时向量选择器表达式后面添加包含在 <code>[]</code> 里的时长来表达时间范围。</p>
<p><strong>时间单位：</strong></p>
<ul>
<li><code>ms</code>（毫秒）、<code>s</code>（秒）、<code>m</code>（分钟）、<code>h</code>（小时）、<code>d</code>（天）、<code>w</code>（周）、<code>y</code>（年）</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 过去 5 分钟内的数据</span><br><span class="line">prometheus_http_requests_total[5m]</span><br><span class="line"></span><br><span class="line"># 过去 1 小时 30 分钟内的数据</span><br><span class="line">prometheus_http_requests_total[1h30m]</span><br></pre></td></tr></table></figure>

<h4 id="偏移向量选择器"><a href="#偏移向量选择器" class="headerlink" title="偏移向量选择器"></a>偏移向量选择器</h4><p>用来调整基准时间，使其往前偏移一段时间。</p>
<p><strong>示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 过去 5 分钟之时的即时样本</span><br><span class="line">prometheus_http_requests_total offset 5m</span><br><span class="line"></span><br><span class="line"># 距此刻 1 天时间之前的 5 分钟内的样本</span><br><span class="line">prometheus_http_requests_total[5m] offset 1d</span><br></pre></td></tr></table></figure>

<h3 id="2-6-PromQL-的指标类型"><a href="#2-6-PromQL-的指标类型" class="headerlink" title="2.6 PromQL 的指标类型"></a>2.6 PromQL 的指标类型</h3><h4 id="（1）Counter（计数器）"><a href="#（1）Counter（计数器）" class="headerlink" title="（1）Counter（计数器）"></a>（1）Counter（计数器）</h4><ul>
<li>用于保存单调递增型的数据</li>
<li>数据单调递增，不支持减少，不能为负值</li>
<li>重启进程后会被重置回 0</li>
<li>通常需要借助 rate、irate、increase 函数来生成样本数据的变化状况</li>
</ul>
<p><strong>常用函数：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 获取排名前 3 的时间序列</span><br><span class="line">topk(3, prometheus_http_requests_total)</span><br><span class="line"></span><br><span class="line"># 获取 1 小时内的增长速率</span><br><span class="line">rate(prometheus_http_requests_total[1h])</span><br><span class="line"></span><br><span class="line"># 获取瞬时速率（基于最后两个样本）</span><br><span class="line">irate(prometheus_http_requests_total[1h])</span><br></pre></td></tr></table></figure>

<h4 id="（2）Gauge（仪表盘）"><a href="#（2）Gauge（仪表盘）" class="headerlink" title="（2）Gauge（仪表盘）"></a>（2）Gauge（仪表盘）</h4><ul>
<li>用于存储有着起伏特征的指标数据</li>
<li>数据可变大，可变小</li>
<li>重启进程后会被重置</li>
<li>常用于求和、取平均值、最小值、最大值等聚合计算</li>
</ul>
<p><strong>常用函数：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 计算 CPU 温度与 2 小时前的差异</span><br><span class="line">delta(cpu_temp_celsius&#123;host=&quot;node01&quot;&#125;[2h])</span><br><span class="line"></span><br><span class="line"># 基于 2 小时数据预测 4 小时后的磁盘空间</span><br><span class="line">predict_linear(node_filesystem_free&#123;job=&quot;node&quot;&#125;[2h], 4 * 3600)</span><br></pre></td></tr></table></figure>

<h4 id="（3）Histogram（累积直方图）"><a href="#（3）Histogram（累积直方图）" class="headerlink" title="（3）Histogram（累积直方图）"></a>（3）Histogram（累积直方图）</h4><ul>
<li>将时间范围内的数据划分成不同的时间段</li>
<li>各自评估其样本个数及样本值之和</li>
<li>可计算出分位数</li>
<li>用于分析因异常值而引起的平均值过大的问题</li>
</ul>
<p><strong>主要指标：</strong></p>
<ul>
<li><code>&lt;basename&gt;_sum</code>：所有样本值的总和</li>
<li><code>&lt;basename&gt;_count</code>：总的采样次数（Counter 类型）</li>
<li><code>&lt;basename&gt;_bucket{le=&quot;&lt;上边界&gt;&quot;}</code>：样本值小于等于上边界的样本数量</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 计算 9 分位数</span><br><span class="line">histogram_quantile(0.9, prometheus_http_request_duration_seconds_bucket)</span><br></pre></td></tr></table></figure>

<h4 id="（4）Summary（摘要）"><a href="#（4）Summary（摘要）" class="headerlink" title="（4）Summary（摘要）"></a>（4）Summary（摘要）</h4><ul>
<li>类似于 Histogram，但在客户端直接计算并上报分位数</li>
<li>在客户端一段时间内（默认 10 分钟）进行统计</li>
</ul>
<p><strong>主要指标：</strong></p>
<ul>
<li><code>&lt;basename&gt;_sum</code>：统计所有样本值之和</li>
<li><code>&lt;basename&gt;_count</code>：统计所有样本总数</li>
<li><code>&lt;basename&gt;{quantile=&quot;x&quot;}</code>：统计样本值的分位数分布情况（0 ≤ x ≤ 1）</li>
</ul>
<h3 id="2-7-Prometheus-的聚合函数"><a href="#2-7-Prometheus-的聚合函数" class="headerlink" title="2.7 Prometheus 的聚合函数"></a>2.7 Prometheus 的聚合函数</h3><p>Prometheus 内置提供 11 个聚合函数，用于针对一组值进行计算并返回结果：</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>sum()</code></td>
<td>对样本值求和</td>
</tr>
<tr>
<td><code>min()</code></td>
<td>求取样本值中的最小者</td>
</tr>
<tr>
<td><code>max()</code></td>
<td>求取样本值中的最大者</td>
</tr>
<tr>
<td><code>avg()</code></td>
<td>对样本值求平均值</td>
</tr>
<tr>
<td><code>count()</code></td>
<td>对分组内的时间序列进行数量统计</td>
</tr>
<tr>
<td><code>stddev()</code></td>
<td>对样本值求标准差</td>
</tr>
<tr>
<td><code>stdvar()</code></td>
<td>对样本值求方差</td>
</tr>
<tr>
<td><code>topk()</code></td>
<td>逆序返回样本值最大的前 k 个时间序列</td>
</tr>
<tr>
<td><code>bottomk()</code></td>
<td>顺序返回样本值最小的前 k 个时间序列</td>
</tr>
<tr>
<td><code>quantile()</code></td>
<td>分位数，评估数据的分布状态</td>
</tr>
<tr>
<td><code>count_values()</code></td>
<td>对分组内时间序列的样本值进行数量统计</td>
</tr>
</tbody></table>
<h3 id="2-8-PromQL-聚合表达式"><a href="#2-8-PromQL-聚合表达式" class="headerlink" title="2.8 PromQL 聚合表达式"></a>2.8 PromQL 聚合表达式</h3><p>聚合操作语法格式有两种：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 方式一</span><br><span class="line">&lt;聚合函数&gt;(向量表达式) by|without (标签)</span><br><span class="line"></span><br><span class="line"># 方式二</span><br><span class="line">&lt;聚合函数&gt; by|without (标签) (向量表达式)</span><br></pre></td></tr></table></figure>

<p><strong>by 与 without 的区别：</strong></p>
<table>
<thead>
<tr>
<th>方式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>by</code></td>
<td>仅使用 by 子句中指定的标签进行聚合，其他标签则会被忽略</td>
</tr>
<tr>
<td><code>without</code></td>
<td>从结果向量中删除由 without 指定的标签，未指定的标签则用作分组标准</td>
</tr>
</tbody></table>
<p><strong>实际应用示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 每台主机 CPU 在最近 5 分钟内的平均使用率</span><br><span class="line">(1 - avg(rate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) by (instance)) * 100</span><br><span class="line"></span><br><span class="line"># 查询 1 分钟的 load average 是否超过 CPU 数量 2 倍</span><br><span class="line">node_load1 &gt; on (instance) 2 * count (node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;) by (instance)</span><br><span class="line"></span><br><span class="line"># 计算主机内存使用率</span><br><span class="line">(node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100</span><br><span class="line"></span><br><span class="line"># 计算所有 node 节点所有容器总计内存（单位 GB）</span><br><span class="line">sum by (instance) (container_memory_usage_bytes&#123;instance=~&quot;node*&quot;&#125;)/1024/1024/1024</span><br><span class="line"></span><br><span class="line"># 计算最近 5 分钟每个容器 CPU 使用情况变化率</span><br><span class="line">sum (rate(container_cpu_usage_seconds_total[5m])) by (container_name)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="第三部分：实验部署"><a href="#第三部分：实验部署" class="headerlink" title="第三部分：实验部署"></a>第三部分：实验部署</h2><h3 id="3-1-部署-Prometheus-Server"><a href="#3-1-部署-Prometheus-Server" class="headerlink" title="3.1 部署 Prometheus Server"></a>3.1 部署 Prometheus Server</h3><h4 id="第一步：关闭防火墙和-SELinux"><a href="#第一步：关闭防火墙和-SELinux" class="headerlink" title="第一步：关闭防火墙和 SELinux"></a>第一步：关闭防火墙和 SELinux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>

<h4 id="第二步：下载并解压"><a href="#第二步：下载并解压" class="headerlink" title="第二步：下载并解压"></a>第二步：下载并解压</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">tar xf prometheus-2.35.0.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">mv</span> prometheus-2.35.0.linux-amd64 /usr/local/prometheus</span><br></pre></td></tr></table></figure>

<h4 id="第三步：查看默认配置文件"><a href="#第三步：查看默认配置文件" class="headerlink" title="第三步：查看默认配置文件"></a>第三步：查看默认配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /usr/local/prometheus/prometheus.yml | grep -v <span class="string">&quot;^#&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置文件结构说明：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span>                    <span class="comment"># 全局配置</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span>     <span class="comment"># 采集间隔，默认 1m</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> <span class="comment"># 告警规则触发间隔，默认 1m</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">10s</span>      <span class="comment"># 数据采集超时时间，默认 10s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alerting:</span>                  <span class="comment"># Alertmanager 实例配置</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span> []</span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span>                <span class="comment"># 告警规则文件路径</span></span><br><span class="line">  <span class="comment"># - &quot;first_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span>            <span class="comment"># 采集时序数据源配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;prometheus&quot;</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">&#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9090&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="第四步：配置系统启动文件，启动systemctl"><a href="#第四步：配置系统启动文件，启动systemctl" class="headerlink" title="第四步：配置系统启动文件，启动systemctl"></a>第四步：配置系统启动文件，启动systemctl</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /usr/lib/systemd/system/prometheus.service &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus Server</span><br><span class="line">Documentation=https://prometheus.io</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/prometheus/prometheus \</span><br><span class="line">--config.file=/usr/local/prometheus/prometheus.yml \</span><br><span class="line">--storage.tsdb.path=/usr/local/prometheus/data/ \</span><br><span class="line">--storage.tsdb.retention=15d \</span><br><span class="line">--web.enable-lifecycle</span><br><span class="line">  </span><br><span class="line">ExecReload=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202095608963.png" alt="image-20251202095608963"></p>
<h4 id="第五步：启动服务"><a href="#第五步：启动服务" class="headerlink" title="第五步：启动服务"></a>第五步：启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start prometheus</span><br><span class="line">systemctl <span class="built_in">enable</span> prometheus</span><br><span class="line">netstat -natp | grep :9090</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202095617216.png" alt="image-20251202095617216"></p>
<p><img src="/./imgs/image-20251202095624338.png" alt="image-20251202095624338"></p>
<h4 id="第六步：验证"><a href="#第六步：验证" class="headerlink" title="第六步：验证"></a>第六步：验证</h4><p>浏览器访问 <code>http://192.168.118.101:9090</code></p>
<ul>
<li>点击 Status -&gt; Targets，检查 Target 状态是否为 UP</li>
<li>访问 <code>http://192.168.118.101:9090/metrics</code> 查看 Prometheus 采集的指标数据</li>
</ul>
<p><img src="/./imgs/image-20251202095640348.png" alt="image-20251202095640348"></p>
<h3 id="3-2-部署-Node-Exporter"><a href="#3-2-部署-Node-Exporter" class="headerlink" title="3.2 部署 Node Exporter"></a>3.2 部署 Node Exporter</h3><p>Node Exporter 用于收集服务器节点的物理指标状态数据。</p>
<h4 id="第一步：下载并解压"><a href="#第一步：下载并解压" class="headerlink" title="第一步：下载并解压"></a>第一步：下载并解压</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">tar xf node_exporter-1.3.1.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">mv</span> node_exporter-1.3.1.linux-amd64/node_exporter /usr/local/bin</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将可执行文件移动到&#x2F;usr&#x2F;local&#x2F;bin中，使系统可以识别命令</p>
</blockquote>
<h4 id="第二步：配置启动文件"><a href="#第二步：配置启动文件" class="headerlink" title="第二步：配置启动文件"></a>第二步：配置启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /usr/lib/systemd/system/node_exporter.service &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">Documentation=https://prometheus.io/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/bin/node_exporter \</span><br><span class="line">--collector.ntp \</span><br><span class="line">--collector.mountstats \</span><br><span class="line">--collector.systemd \</span><br><span class="line">--collector.tcpstat</span><br><span class="line"></span><br><span class="line">ExecReload=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="第三步：启动服务"><a href="#第三步：启动服务" class="headerlink" title="第三步：启动服务"></a>第三步：启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start node_exporter</span><br><span class="line">systemctl <span class="built_in">enable</span> node_exporter</span><br><span class="line">netstat -natp | grep :9100</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202095739922.png" alt="image-20251202095739922"></p>
<h4 id="第四步：验证"><a href="#第四步：验证" class="headerlink" title="第四步：验证"></a>第四步：验证</h4><p>浏览器访问 <code>http://192.168.118.101:9100/metrics</code> 查看 Node Exporter 采集的指标数据</p>
<p><img src="/./imgs/image-20251202095753451.png" alt="image-20251202095753451"></p>
<h4 id="第五步：修改-Prometheus-配置文件"><a href="#第五步：修改-Prometheus-配置文件" class="headerlink" title="第五步：修改 Prometheus 配置文件"></a>第五步：修改 Prometheus 配置文件</h4><p>修改 prometheus 配置文件，加入到 prometheus 监控中（注意yml的格式问题）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/prometheus/prometheus.yml</span><br><span class="line"><span class="comment"># 在尾部增加如下内容</span></span><br><span class="line">  - job_name: nodes</span><br><span class="line">    metrics_path: <span class="string">&quot;/metrics&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">        - 192.168.118.101:9100</span><br><span class="line">        - 192.168.118.103:9100</span><br><span class="line">        - 192.168.118.104:9100</span><br><span class="line">      labels:</span><br><span class="line">        service: master_sit</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202095858245.png" alt="image-20251202095858245"></p>
<h4 id="第六步：重新加载配置"><a href="#第六步：重新加载配置" class="headerlink" title="第六步：重新加载配置"></a>第六步：重新加载配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://192.168.118.101:9090/-/reload</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">systemctl reload prometheus</span><br></pre></td></tr></table></figure>

<p>浏览器查看 Prometheus 页面的 Status -&gt; Targets，可以看到nodes的信息</p>
<p><img src="/./imgs/image-20251202095915841.png" alt="image-20251202095915841"></p>
<h3 id="3-3-部署-MySQL-Exporter"><a href="#3-3-部署-MySQL-Exporter" class="headerlink" title="3.3 部署 MySQL Exporter"></a>3.3 部署 MySQL Exporter</h3><h4 id="第一步：安装-MySQL开启相关日志"><a href="#第一步：安装-MySQL开启相关日志" class="headerlink" title="第一步：安装 MySQL开启相关日志"></a>第一步：安装 MySQL开启相关日志</h4><p><strong>安装mariadb</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mariadb-server </span><br><span class="line">systemctl start mariadb</span><br><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure>

<p><strong>开启二进制日志和慢日志</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">...</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">binlog_format=MIXED</span><br><span class="line">server-id=1</span><br><span class="line"></span><br><span class="line">slow_query_log=ON</span><br><span class="line">long_query_time=2</span><br><span class="line">log_queries_not_using_indexes=ON</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202100545573.png" alt="image-20251202100545573"></p>
<h4 id="第二步：下载并安装-mysqld-exporter"><a href="#第二步：下载并安装-mysqld-exporter" class="headerlink" title="第二步：下载并安装 mysqld_exporter"></a>第二步：下载并安装 mysqld_exporter</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">tar xf mysqld_exporter-0.14.0.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">mv</span> mysqld_exporter-0.14.0.linux-amd64/mysqld_exporter /usr/local/bin</span><br></pre></td></tr></table></figure>

<h4 id="第三步：配置-MySQL-连接信息"><a href="#第三步：配置-MySQL-连接信息" class="headerlink" title="第三步：配置 MySQL 连接信息"></a>第三步：配置 MySQL 连接信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不一定一定是这个文件夹，可以自定义文件夹，但是最后要指定my.cnf</span></span><br><span class="line">vim /usr/local/mysqld_exporter-0.14.0.linux-amd64/.my.cnf</span><br><span class="line">[client]</span><br><span class="line">host=localhost</span><br><span class="line">user=mysqlexporter</span><br><span class="line">password=123456</span><br></pre></td></tr></table></figure>

<h4 id="第四步：创建-MySQL-用户并授权"><a href="#第四步：创建-MySQL-用户并授权" class="headerlink" title="第四步：创建 MySQL 用户并授权"></a>第四步：创建 MySQL 用户并授权</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456</span><br><span class="line">GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO <span class="string">&#x27;mysqlexporter&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202100437540.png" alt="image-20251202100437540"></p>
<h4 id="第五步：配置启动文件"><a href="#第五步：配置启动文件" class="headerlink" title="第五步：配置启动文件"></a>第五步：配置启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /usr/lib/systemd/system/mysqld_exporter.service &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=mysqld_exporter</span><br><span class="line">Documentation=https://prometheus.io/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/bin/mysqld_exporter --config.my-cnf=/etc/my.cnf</span><br><span class="line"></span><br><span class="line">ExecReload=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="第六步：启动服务"><a href="#第六步：启动服务" class="headerlink" title="第六步：启动服务"></a>第六步：启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld_exporter</span><br><span class="line">systemctl <span class="built_in">enable</span> mysqld_exporter</span><br><span class="line">netstat -natp | grep :9104</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202100716346.png" alt="image-20251202100716346"></p>
<p>查看metrics中是否有mysql_up&#x3D;1说明连接上了数据库</p>
<p><img src="/./imgs/image-20251202100726435.png" alt="image-20251202100726435"></p>
<h4 id="第七步：修改-Prometheus-配置文件"><a href="#第七步：修改-Prometheus-配置文件" class="headerlink" title="第七步：修改 Prometheus 配置文件"></a>第七步：修改 Prometheus 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/prometheus/prometheus.yml</span><br><span class="line"><span class="comment"># 在尾部增加如下内容</span></span><br><span class="line">  - job_name: mysqld</span><br><span class="line">    metrics_path: <span class="string">&quot;/metrics&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">          - 192.168.118.101:9104</span><br><span class="line">      labels:</span><br><span class="line">        service: mysqld</span><br></pre></td></tr></table></figure>

<h4 id="第八步：重新加载配置"><a href="#第八步：重新加载配置" class="headerlink" title="第八步：重新加载配置"></a>第八步：重新加载配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://192.168.110.130:9090/-/reload</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202100808875.png" alt="image-20251202100808875"></p>
<h3 id="3-4-部署-Nginx-Exporter-及-Nginx-VTS"><a href="#3-4-部署-Nginx-Exporter-及-Nginx-VTS" class="headerlink" title="3.4 部署 Nginx Exporter 及 Nginx VTS"></a>3.4 部署 Nginx Exporter 及 Nginx VTS</h3><h4 id="Nginx-VTS-简述"><a href="#Nginx-VTS-简述" class="headerlink" title="Nginx-VTS 简述"></a><strong>Nginx-VTS 简述</strong></h4><p>Nginx-VTS（Nginx Virtual Host Traffic Status）是一个 Nginx 模块，用于收集和统计 Nginx 服务器的流量信息。它的主要功能包括：</p>
<ol>
<li><strong>流量统计</strong>：统计每个虚拟主机（server_name）的请求数、响应字节数、请求耗时等详细的流量数据</li>
<li><strong>性能监控</strong>：实时监控 Nginx 的性能指标，包括请求速率、响应时间等</li>
<li><strong>可视化展示</strong>：提供 HTML 格式的状态页面，可以在浏览器中直观查看流量统计信息</li>
<li><strong>指标暴露</strong>：通过 JSON 格式暴露指标数据，方便 Nginx-VTS-Exporter 采集并转换为 Prometheus 格式</li>
<li><strong>灵活控制</strong>：支持在特定的 server 块中禁用统计功能，避免统计不需要的流量信息</li>
</ol>
<p><strong>工作原理：</strong></p>
<ul>
<li>Nginx-VTS 模块在编译时添加到 Nginx 中</li>
<li>在 Nginx 配置文件中启用 <code>vhost_traffic_status_zone</code> 来开启流量统计</li>
<li>通过 <code>/status</code> 端点暴露统计数据</li>
<li>Nginx-VTS-Exporter 定期从 <code>/status/format/json</code> 端点获取 JSON 格式的数据</li>
<li>将数据转换为 Prometheus 能够识别的格式，供 Prometheus Server 抓取</li>
</ul>
<p><strong>应用场景：</strong> 适合对 Nginx 服务器的请求量、响应时间、错误率等进行详细的监控和分析，是构建完整 Nginx 监控体系的重要组件。</p>
<h4 id="第一步：解压-Nginx-VTS-插件"><a href="#第一步：解压-Nginx-VTS-插件" class="headerlink" title="第一步：解压 Nginx VTS 插件"></a>第一步：解压 Nginx VTS 插件</h4><p><strong>安装nginx和vts</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.18.0.tar.gz</span><br><span class="line">wget https://github.com/vozlt/nginx-module-vts/archive/nginx-module-vts-0.1.18.tar.gz</span><br></pre></td></tr></table></figure>

<p><strong>解压VTS插件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">tar xf nginx-module-vts-0.1.18.tar.gz</span><br><span class="line"><span class="built_in">mv</span> nginx-module-vts-0.1.18 /usr/local/nginx-module-vts</span><br></pre></td></tr></table></figure>

<h4 id="第二步：安装依赖和创建-Nginx-用户"><a href="#第二步：安装依赖和创建-Nginx-用户" class="headerlink" title="第二步：安装依赖和创建 Nginx 用户"></a>第二步：安装依赖和创建 Nginx 用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install pcre-devel zlib-devel openssl-devel gcc gcc-c++ make</span><br><span class="line">useradd -M -s /sbin/nologin nginx</span><br></pre></td></tr></table></figure>

<h4 id="第三步：编译安装-Nginx"><a href="#第三步：编译安装-Nginx" class="headerlink" title="第三步：编译安装 Nginx"></a>第三步：编译安装 Nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">tar xf nginx-1.18.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.18.0/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重点--add-module=/usr/local/nginx-module-vts</span></span><br><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--add-module=/usr/local/nginx-module-vts</span><br><span class="line"></span><br><span class="line">make &amp; make install</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202101240489.png" alt="image-20251202101240489"></p>
<p><img src="/./imgs/image-20251202101244952.png" alt="image-20251202101244952"></p>
<h4 id="第四步：配置-Nginx"><a href="#第四步：配置-Nginx" class="headerlink" title="第四步：配置 Nginx"></a>第四步：配置 Nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">	<span class="comment"># nginx-vts</span></span><br><span class="line">    vhost_traffic_status_zone;</span><br><span class="line">    <span class="comment"># 下面的可以不添加</span></span><br><span class="line">    vhost_traffic_status_filter_by_host on;   <span class="comment">#开启此功能，会根据不同的server_name进行流量的统计，否则默认会把流量全部计算到第一个上。</span></span><br><span class="line">    vhost_traffic_status_filter on;</span><br><span class="line">    vhost_traffic_status_filter_by_set_key <span class="variable">$status</span> <span class="variable">$server_name</span>;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8080;</span><br><span class="line">        allow 127.0.0.1;</span><br><span class="line">        allow 192.168.110.128;</span><br><span class="line"></span><br><span class="line">        location /nginx-status &#123;</span><br><span class="line">            stub_status on;</span><br><span class="line">            access_log off;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /status &#123;</span><br><span class="line">            vhost_traffic_status_display;</span><br><span class="line">            vhost_traffic_status_display_format html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第五步：配置-Nginx-启动文件和启动"><a href="#第五步：配置-Nginx-启动文件和启动" class="headerlink" title="第五步：配置 Nginx 启动文件和启动"></a>第五步：配置 Nginx 启动文件和启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /usr/local/nginx/sbin/nginx /usr/local/sbin/</span><br><span class="line">nginx -t</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /lib/systemd/system/nginx.service &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/usr/local/nginx/logs/nginx.pid</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx</span><br><span class="line">ExecReload=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">ExecStop=/bin/kill -s QUIT <span class="variable">$MAINPID</span></span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202101351459.png" alt="image-20251202101351459"></p>
<h4 id="第六步：验证-Nginx-VTS-状态页面"><a href="#第六步：验证-Nginx-VTS-状态页面" class="headerlink" title="第六步：验证 Nginx VTS 状态页面"></a>第六步：验证 Nginx VTS 状态页面</h4><p>浏览器访问：<code>http://192.168.118.101:8080/status</code> 查看 Nginx Vhost Traffic Status 页面信息</p>
<p><img src="/./imgs/image-20251202101408805.png" alt="image-20251202101408805"></p>
<h4 id="第七步：安装-nginx-vts-exporter"><a href="#第七步：安装-nginx-vts-exporter" class="headerlink" title="第七步：安装 nginx-vts-exporter"></a>第七步：安装 nginx-vts-exporter</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">tar -zxvf nginx-vts-exporter-0.10.3.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">mv</span> nginx-vts-exporter-0.10.3.linux-amd64/nginx-vts-exporter /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /usr/lib/systemd/system/nginx-exporter.service &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx-exporter</span><br><span class="line">Documentation=https://prometheus.io/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/bin/nginx-vts-exporter -nginx.scrape_uri=http://localhost:8080/status/format/json</span><br><span class="line"></span><br><span class="line">ExecReload=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl start nginx-exporter</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx-exporter</span><br><span class="line">netstat -natp | grep :9913</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202101450941.png" alt="image-20251202101450941"></p>
<p><img src="/./imgs/image-20251202101457992.png" alt="image-20251202101457992"></p>
<h4 id="第八步：修改-Prometheus-配置文件"><a href="#第八步：修改-Prometheus-配置文件" class="headerlink" title="第八步：修改 Prometheus 配置文件"></a>第八步：修改 Prometheus 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/prometheus/prometheus.yml</span><br><span class="line"><span class="comment"># 在尾部增加如下内容</span></span><br><span class="line">  - job_name: nginx</span><br><span class="line">    metrics_path: <span class="string">&quot;/metrics&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">          - 192.168.118.101:9913</span><br><span class="line">      labels:</span><br><span class="line">        service: nginx</span><br></pre></td></tr></table></figure>

<h4 id="第九步：重新加载配置"><a href="#第九步：重新加载配置" class="headerlink" title="第九步：重新加载配置"></a>第九步：重新加载配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://192.168.118.101:9090/-/reload</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202101513691.png" alt="image-20251202101513691"></p>
<h3 id="3-5-部署-Alertmanager"><a href="#3-5-部署-Alertmanager" class="headerlink" title="3.5 部署 Alertmanager"></a>3.5 部署 Alertmanager</h3><h4 id="第一步：下载并解压-1"><a href="#第一步：下载并解压-1" class="headerlink" title="第一步：下载并解压"></a>第一步：下载并解压</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">tar xf alertmanager-0.24.0.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">mv</span> alertmanager-0.24.0.linux-amd64 /usr/local/alertmanager</span><br></pre></td></tr></table></figure>

<h4 id="第二步：配置-Alertmanager（邮件告警）"><a href="#第二步：配置-Alertmanager（邮件告警）" class="headerlink" title="第二步：配置 Alertmanager（邮件告警）"></a>第二步：配置 Alertmanager（邮件告警）</h4><p>获取 QQ 邮箱授权码：登录 QQ 邮箱 -&gt; 设置 -&gt; 账户 -&gt; 生成授权码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/alertmanager/alertmanager.yml</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line">  smtp_smarthost: <span class="string">&#x27;smtp.qq.com:25&#x27;</span></span><br><span class="line">  smtp_from: <span class="string">&#x27;your-email@qq.com&#x27;</span></span><br><span class="line">  smtp_auth_username: <span class="string">&#x27;your-email@qq.com&#x27;</span></span><br><span class="line">  smtp_auth_password: <span class="string">&#x27;jpfbqumyjsqrbbgg&#x27;</span>    <span class="comment"># 授权码</span></span><br><span class="line">  smtp_require_tls: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  group_by: [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">  group_wait: 20s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 20m</span><br><span class="line">  receiver: <span class="string">&#x27;my-email&#x27;</span></span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line">- name: <span class="string">&#x27;my-email&#x27;</span></span><br><span class="line">  email_configs:</span><br><span class="line">  - to: <span class="string">&#x27;your-email@wo.cn&#x27;</span></span><br><span class="line">    send_resolved: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="第三步：配置启动文件"><a href="#第三步：配置启动文件" class="headerlink" title="第三步：配置启动文件"></a>第三步：配置启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /usr/lib/systemd/system/alertmanager.service &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=alertmanager</span><br><span class="line">Documentation=https://prometheus.io/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/alertmanager/alertmanager \</span><br><span class="line">--config.file=/usr/local/alertmanager/alertmanager.yml \</span><br><span class="line">--log.level=debug</span><br><span class="line"></span><br><span class="line">ExecReload=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="第四步：启动服务"><a href="#第四步：启动服务" class="headerlink" title="第四步：启动服务"></a>第四步：启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start alertmanager</span><br><span class="line">systemctl <span class="built_in">enable</span> alertmanager</span><br><span class="line">netstat -natp | grep :9093</span><br></pre></td></tr></table></figure>

<h3 id="3-6-配置告警规则"><a href="#3-6-配置告警规则" class="headerlink" title="3.6 配置告警规则"></a>3.6 配置告警规则</h3><h4 id="第一步：创建告警规则目录"><a href="#第一步：创建告警规则目录" class="headerlink" title="第一步：创建告警规则目录"></a>第一步：创建告警规则目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /usr/local/prometheus/alert_rules</span><br></pre></td></tr></table></figure>

<h4 id="第二步：创建告警规则文件"><a href="#第二步：创建告警规则文件" class="headerlink" title="第二步：创建告警规则文件"></a>第二步：创建告警规则文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/prometheus/alert_rules/instance_down.yaml</span><br><span class="line"></span><br><span class="line"><span class="built_in">groups</span>:</span><br><span class="line">- name: AllInstances</span><br><span class="line">  rules:</span><br><span class="line">  - alert: InstanceDown</span><br><span class="line">    <span class="built_in">expr</span>: up == 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    annotations:</span><br><span class="line">      title: <span class="string">&#x27;Instance down&#x27;</span></span><br><span class="line">      description: Instance has been down <span class="keyword">for</span> more than 1 minute.</span><br><span class="line">    labels:</span><br><span class="line">      severity: <span class="string">&#x27;critical&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: node_alert</span><br><span class="line">  rules:</span><br><span class="line">  - alert: cpu_alert</span><br><span class="line">    <span class="built_in">expr</span>: 100 -avg(irate(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;[1m])) by (instance)* 100 &gt; 80</span><br><span class="line">    <span class="keyword">for</span>: 5m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      description: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; ,cpu usage is too high ! value: &#123;&#123;<span class="variable">$value</span>&#125;&#125;&quot;</span></span><br><span class="line">      summary: <span class="string">&quot;cpu usage is too high&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="第三步：修改-Prometheus-配置文件"><a href="#第三步：修改-Prometheus-配置文件" class="headerlink" title="第三步：修改 Prometheus 配置文件"></a>第三步：修改 Prometheus 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/prometheus/prometheus.yml</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - 192.168.118.101:9093</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - <span class="string">&quot;/usr/local/prometheus/alert_rules/*.yaml&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="第四步：重新加载配置"><a href="#第四步：重新加载配置" class="headerlink" title="第四步：重新加载配置"></a>第四步：重新加载配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload prometheus</span><br></pre></td></tr></table></figure>

<h3 id="3-7-部署-Grafana-进行可视化展示"><a href="#3-7-部署-Grafana-进行可视化展示" class="headerlink" title="3.7 部署 Grafana 进行可视化展示"></a>3.7 部署 Grafana 进行可视化展示</h3><h4 id="第一步：下载并安装"><a href="#第一步：下载并安装" class="headerlink" title="第一步：下载并安装"></a>第一步：下载并安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载地址：https://grafana.com/grafana/download</span></span><br><span class="line"><span class="comment"># 或 https://mirrors.bfsu.edu.cn/grafana/yum/rpm/</span></span><br><span class="line"></span><br><span class="line">yum install -y grafana-7.4.0-1.x86_64.rpm</span><br><span class="line"></span><br><span class="line">systemctl start grafana-server</span><br><span class="line">systemctl <span class="built_in">enable</span> grafana-server</span><br><span class="line">netstat -natp | grep :3000</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251202100019874.png" alt="image-20251202100019874"></p>
<p><img src="/./imgs/image-20251202100024272.png" alt="image-20251202100024272"></p>
<h4 id="第二步：配置数据源"><a href="#第二步：配置数据源" class="headerlink" title="第二步：配置数据源"></a>第二步：配置数据源</h4><p>浏览器访问 <code>http://192.168.118.101:3000</code></p>
<ol>
<li>默认账号密码：admin&#x2F;admin</li>
<li>Configuration -&gt; Data Sources -&gt; Add data source</li>
<li>选择 Prometheus</li>
<li>HTTP -&gt; URL 输入 <code>http://192.168.118.101:9090</code></li>
<li>点击 Save &amp; Test</li>
</ol>
<p><img src="/./imgs/image-20251202100040759.png" alt="image-20251202100040759"></p>
<p><img src="/./imgs/image-20251202100058171.png" alt="image-20251202100058171"></p>
<h4 id="第三步：导入默认仪表盘"><a href="#第三步：导入默认仪表盘" class="headerlink" title="第三步：导入默认仪表盘"></a>第三步：导入默认仪表盘</h4><ol>
<li>点击上方菜单 Dashboards -&gt; Import 导入默认模板</li>
<li>选择 Prometheus 2.0 Stats 或 Prometheus Stats 即可看到监控图像</li>
</ol>
<h4 id="第四步：导入自定义监控面板"><a href="#第四步：导入自定义监控面板" class="headerlink" title="第四步：导入自定义监控面板"></a>第四步：导入自定义监控面板</h4><ol>
<li>浏览器访问：<code>https://grafana.com/grafana/dashboards</code></li>
<li>搜索 <code>node exporter</code>，选择合适的面板</li>
<li>复制 ID 号</li>
<li>在 Grafana 页面中 + Create -&gt; Import</li>
<li>输入面板 ID 号或上传 JSON 文件</li>
<li>点击 Load 导入监控面板</li>
</ol>
<p><strong>node_exporter</strong></p>
<p><img src="/./imgs/image-20251202100125796.png" alt="image-20251202100125796"></p>
<p><strong>mysqld_exporter</strong></p>
<p><img src="/./imgs/image-20251202100226472.png" alt="image-20251202100226472"></p>
<p><strong>nginx_vts_exporter</strong></p>
<p><img src="/./imgs/image-20251202100237809.png" alt="image-20251202100237809"></p>
<h3 id="3-8-服务发现配置"><a href="#3-8-服务发现配置" class="headerlink" title="3.8 服务发现配置"></a>3.8 服务发现配置</h3><h4 id="基于文件的服务发现"><a href="#基于文件的服务发现" class="headerlink" title="基于文件的服务发现"></a>基于文件的服务发现</h4><p>基于文件的服务发现是最为简单和通用的实现方式，不依赖于任何平台或第三方服务。</p>
<p><strong>第一步：创建服务发现文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/prometheus</span><br><span class="line"><span class="built_in">mkdir</span> targets</span><br><span class="line"></span><br><span class="line">vim targets/node-exporter.yaml</span><br><span class="line">- targets:</span><br><span class="line">  - 192.168.118.101:9100</span><br><span class="line">  - 192.168.118.104:9100</span><br><span class="line">  labels:</span><br><span class="line">    app: node-exporter</span><br><span class="line">    job: node</span><br><span class="line"></span><br><span class="line">vim targets/mysqld-exporter.yaml</span><br><span class="line">- targets:</span><br><span class="line">  - 192.168.118.101:9104</span><br><span class="line">  - 192.168.118.104:9104</span><br><span class="line">  labels:</span><br><span class="line">    app: mysqld-exporter</span><br><span class="line">    job: mysqld</span><br></pre></td></tr></table></figure>

<p><strong>第二步：修改 Prometheus 配置文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/prometheus/prometheus.yml</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: nodes</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - targets/node*.yaml</span><br><span class="line">      refresh_interval: 2m</span><br><span class="line">  </span><br><span class="line">  - job_name: mysqld</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - targets/mysqld*.yaml</span><br><span class="line">      refresh_interval: 2m</span><br></pre></td></tr></table></figure>

<p><strong>第三步：重新加载配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload prometheus</span><br></pre></td></tr></table></figure>

<p>浏览器查看 <code>http://192.168.118.101:9090</code> Status -&gt; Targets</p>
<h4 id="基于-Consul-的服务发现"><a href="#基于-Consul-的服务发现" class="headerlink" title="基于 Consul 的服务发现"></a>基于 Consul 的服务发现</h4><h5 id="3-9-1-Consul-简介"><a href="#3-9-1-Consul-简介" class="headerlink" title="3.9.1 Consul 简介"></a>3.9.1 Consul 简介</h5><p>Consul 是一款基于 Golang 开发的开源工具，主要面向分布式、服务化的系统提供全面的服务治理功能。</p>
<p><strong>主要功能特性：</strong></p>
<ul>
<li>服务注册&#x2F;发现：自动发现和注册微服务实例</li>
<li>健康检查：定期检查服务实例的健康状态</li>
<li>Key&#x2F;Value 存储：分布式配置管理</li>
<li>多数据中心支持：支持跨数据中心的服务发现</li>
<li>分布式一致性保证：基于 Raft 算法保证一致性</li>
</ul>
<p><strong>官方下载地址：</strong> <a target="_blank" rel="noopener" href="https://www.consul.io/downloads/">https://www.consul.io/downloads/</a></p>
<p><strong>Consul 与 Prometheus 集成优势：</strong></p>
<ul>
<li>动态服务发现：自动发现新加入的监控目标</li>
<li>自动去重：Consul 自动处理已注销的服务</li>
<li>健康检查集成：结合 Consul 的健康检查机制</li>
<li>灵活的标签分组：支持基于标签的目标分类</li>
</ul>
<hr>
<h5 id="3-9-2-部署-Consul-服务"><a href="#3-9-2-部署-Consul-服务" class="headerlink" title="3.9.2 部署 Consul 服务"></a>3.9.2 部署 Consul 服务</h5><h6 id="第一步：下载并安装-1"><a href="#第一步：下载并安装-1" class="headerlink" title="第一步：下载并安装"></a>第一步：下载并安装</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">unzip consul_1.9.2_linux_amd64.zip</span><br><span class="line"><span class="built_in">mv</span> consul /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">consul version</span><br></pre></td></tr></table></figure>

<h6 id="第二步：创建数据目录和配置目录"><a href="#第二步：创建数据目录和配置目录" class="headerlink" title="第二步：创建数据目录和配置目录"></a>第二步：创建数据目录和配置目录</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /var/lib/consul-data</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/consul/</span><br></pre></td></tr></table></figure>

<h6 id="第三步：启动-Consul-Server"><a href="#第三步：启动-Consul-Server" class="headerlink" title="第三步：启动 Consul Server"></a>第三步：启动 Consul Server</h6><p>在 Prometheus 服务器上启动 Consul Server（IP: 192.168.118.101）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">consul agent \</span><br><span class="line">  -server \</span><br><span class="line">  -bootstrap \</span><br><span class="line">  -ui \</span><br><span class="line">  -data-dir=/var/lib/consul-data \</span><br><span class="line">  -config-dir=/etc/consul/ \</span><br><span class="line">  -<span class="built_in">bind</span>=192.168.118.101 \</span><br><span class="line">  -client=0.0.0.0 \</span><br><span class="line">  -node=consul-server01 &amp;&gt; /var/log/consul.log &amp;</span><br></pre></td></tr></table></figure>

<p><strong>参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>-server</code></td>
<td>以 Server 模式启动</td>
</tr>
<tr>
<td><code>-bootstrap</code></td>
<td>启用 Bootstrap 模式（初次启动时使用）</td>
</tr>
<tr>
<td><code>-ui</code></td>
<td>启用 Web UI 界面</td>
</tr>
<tr>
<td><code>-data-dir</code></td>
<td>数据存储目录</td>
</tr>
<tr>
<td><code>-config-dir</code></td>
<td>配置文件目录</td>
</tr>
<tr>
<td><code>-bind</code></td>
<td>绑定的 IP 地址（当前 Consul 服务器 IP）</td>
</tr>
<tr>
<td><code>-client</code></td>
<td>客户端可访问的 IP 地址（设为 0.0.0.0 允许任意 IP 连接）</td>
</tr>
<tr>
<td><code>-node</code></td>
<td>节点名称</td>
</tr>
</tbody></table>
<h6 id="第四步：查看-Consul-集群成员"><a href="#第四步：查看-Consul-集群成员" class="headerlink" title="第四步：查看 Consul 集群成员"></a>第四步：查看 Consul 集群成员</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul members</span><br></pre></td></tr></table></figure>

<p><strong>预期输出：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Node              Address              Status  Type    Build  Protocol  DC</span><br><span class="line">consul-server01   192.168.118.101:8301  alive   server  v1.9.2  2         dc1</span><br></pre></td></tr></table></figure>

<h6 id="第五步：访问-Consul-Web-UI"><a href="#第五步：访问-Consul-Web-UI" class="headerlink" title="第五步：访问 Consul Web UI"></a>第五步：访问 Consul Web UI</h6><p>浏览器访问：<code>http://192.168.118.101:8500</code></p>
<p>可以看到 Consul 的 Web 管理界面，显示节点信息、服务列表等。</p>
<hr>
<h5 id="3-9-3-在-Consul-上注册服务"><a href="#3-9-3-在-Consul-上注册服务" class="headerlink" title="3.9.3 在 Consul 上注册服务"></a>3.9.3 在 Consul 上注册服务</h5><h6 id="第一步：创建服务配置文件"><a href="#第一步：创建服务配置文件" class="headerlink" title="第一步：创建服务配置文件"></a>第一步：创建服务配置文件</h6><p>在 Consul 配置目录中创建 JSON 配置文件，注册需要监控的节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/consul/nodes.json</span><br></pre></td></tr></table></figure>

<p><strong>配置内容：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;services&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node_exporter-node01&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node01&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.118.101&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">9100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;nodes&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;checks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;http&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.118.101:9100/metrics&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node_exporter-node02&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node02&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.118.104&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">9100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;nodes&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;checks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;http&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.118.104:9100/metrics&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td>服务实例的唯一标识符</td>
</tr>
<tr>
<td><code>name</code></td>
<td>服务名称（相同 name 的多个 id 表示同一服务的不同实例）</td>
</tr>
<tr>
<td><code>address</code></td>
<td>服务实例的 IP 地址</td>
</tr>
<tr>
<td><code>port</code></td>
<td>服务实例暴露的端口号</td>
</tr>
<tr>
<td><code>tags</code></td>
<td>服务标签数组，用于分类和查询</td>
</tr>
<tr>
<td><code>checks</code></td>
<td>健康检查配置数组</td>
</tr>
<tr>
<td><code>http</code></td>
<td>HTTP 健康检查的 URL</td>
</tr>
<tr>
<td><code>interval</code></td>
<td>健康检查的间隔时间（这里设置为 5 秒检查一次）</td>
</tr>
</tbody></table>
<h6 id="第二步：重新加载-Consul-配置"><a href="#第二步：重新加载-Consul-配置" class="headerlink" title="第二步：重新加载 Consul 配置"></a>第二步：重新加载 Consul 配置</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul reload</span><br></pre></td></tr></table></figure>

<p>此命令会使 Consul 重新加载配置目录中的所有配置文件。</p>
<h6 id="第三步：验证服务注册"><a href="#第三步：验证服务注册" class="headerlink" title="第三步：验证服务注册"></a>第三步：验证服务注册</h6><p><strong>方式一：通过命令行查询</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul catalog services</span><br></pre></td></tr></table></figure>

<p><strong>方式二：通过 Web UI 查看</strong> 浏览器访问：<code>http://192.168.118.101:8500/ui/dc1/services</code></p>
<p>可以看到已注册的服务列表，包括 node01 和 node02。</p>
<hr>
<h5 id="3-9-4-配置-Prometheus-与-Consul-集成"><a href="#3-9-4-配置-Prometheus-与-Consul-集成" class="headerlink" title="3.9.4 配置 Prometheus 与 Consul 集成"></a>3.9.4 配置 Prometheus 与 Consul 集成</h5><h6 id="第一步：修改-Prometheus-配置文件"><a href="#第一步：修改-Prometheus-配置文件" class="headerlink" title="第一步：修改 Prometheus 配置文件"></a>第一步：修改 Prometheus 配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/prometheus/prometheus.yml</span><br></pre></td></tr></table></figure>

<p>在 <code>scrape_configs</code> 部分添加基于 Consul 的服务发现配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">nodes</span></span><br><span class="line">    <span class="attr">consul_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.118</span><span class="number">.101</span><span class="string">:8500</span></span><br><span class="line">      <span class="attr">datacenter:</span> <span class="string">dc1</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="attr">refresh_interval:</span> <span class="string">2m</span></span><br></pre></td></tr></table></figure>

<p><strong>配置参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>server</code></td>
<td>Consul 服务的地址和端口</td>
</tr>
<tr>
<td><code>datacenter</code></td>
<td>Consul 数据中心名称（默认为 dc1）</td>
</tr>
<tr>
<td><code>tags</code></td>
<td>只发现具有指定标签的服务实例</td>
</tr>
<tr>
<td><code>refresh_interval</code></td>
<td>Consul 服务发现的刷新间隔（默认为 30s）</td>
</tr>
</tbody></table>
<h6 id="第二步：重新加载-Prometheus-配置"><a href="#第二步：重新加载-Prometheus-配置" class="headerlink" title="第二步：重新加载 Prometheus 配置"></a>第二步：重新加载 Prometheus 配置</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload prometheus</span><br></pre></td></tr></table></figure>

<p>或者使用 HTTP API 重新加载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://192.168.118.101:9090/-/reload</span><br></pre></td></tr></table></figure>

<h6 id="第三步：验证服务发现"><a href="#第三步：验证服务发现" class="headerlink" title="第三步：验证服务发现"></a>第三步：验证服务发现</h6><p>在 Prometheus Web UI 中验证：</p>
<ol>
<li>浏览器访问：<code>http://192.168.118.101:9090</code></li>
<li>点击 <strong>Status</strong> -&gt; <strong>Service Discovery</strong>，可以看到 Consul 发现的所有服务</li>
<li>点击 <strong>Status</strong> -&gt; <strong>Targets</strong>，可以看到已添加到监控的目标列表</li>
<li>确认两个节点（node01 和 node02）的状态为 <strong>UP</strong></li>
</ol>
<hr>
<h5 id="3-9-5-服务管理操作"><a href="#3-9-5-服务管理操作" class="headerlink" title="3.9.5 服务管理操作"></a>3.9.5 服务管理操作</h5><h6 id="查询已注册的服务"><a href="#查询已注册的服务" class="headerlink" title="查询已注册的服务"></a>查询已注册的服务</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有服务</span></span><br><span class="line">consul catalog services</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定服务的详细信息</span></span><br><span class="line">consul catalog service node01</span><br></pre></td></tr></table></figure>

<h6 id="动态注销服务"><a href="#动态注销服务" class="headerlink" title="动态注销服务"></a>动态注销服务</h6><p>当需要从监控中移除某个服务实例时：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注销指定的服务实例</span></span><br><span class="line">consul services deregister -<span class="built_in">id</span>=<span class="string">&quot;node_exporter-node02&quot;</span></span><br></pre></td></tr></table></figure>

<p>执行此命令后，Prometheus 会在下次刷新时（2 分钟内）自动发现该目标已被移除，并从监控列表中删除。</p>
<h6 id="重新注册服务"><a href="#重新注册服务" class="headerlink" title="重新注册服务"></a>重新注册服务</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新注册之前注销的服务</span></span><br><span class="line">consul services register /etc/consul/nodes.json</span><br></pre></td></tr></table></figure>

<h6 id="查看服务注册日志"><a href="#查看服务注册日志" class="headerlink" title="查看服务注册日志"></a>查看服务注册日志</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Consul 运行日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/consul.log</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="3-9-6-Consul-服务发现工作流程"><a href="#3-9-6-Consul-服务发现工作流程" class="headerlink" title="3.9.6 Consul 服务发现工作流程"></a>3.9.6 Consul 服务发现工作流程</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────┐</span><br><span class="line">│              Consul 服务发现工作流程                  │</span><br><span class="line">├─────────────────────────────────────────────────────┤</span><br><span class="line">│                                                     │</span><br><span class="line">│  1. 在 Consul 中注册服务实例                           │</span><br><span class="line">│     └─&gt; services 包含 address、port、tags 等信息       │</span><br><span class="line">│                                                     │</span><br><span class="line">│  2. Consul 定期执行健康检查                            │</span><br><span class="line">│     └─&gt; HTTP 请求到 /metrics 端点                     │</span><br><span class="line">│     └─&gt; 只有健康的服务才会被 Prometheus 发现            │</span><br><span class="line">│                                                     │</span><br><span class="line">│  3. Prometheus 定期查询 Consul                       │</span><br><span class="line">│     └─&gt; 根据 refresh_interval 刷新（默认 30s）  	     │</span><br><span class="line">│     └─&gt; 获取具有指定 tags 的所有服务实例                │</span><br><span class="line">│                                                     │</span><br><span class="line">│  4. Prometheus 更新 targets 列表                     │</span><br><span class="line">│     └─&gt; 自动添加新发现的服务                           │</span><br><span class="line">│     └─&gt; 自动移除已注销或不健康的服务                     │</span><br><span class="line">│                                                     │</span><br><span class="line">│  5. Prometheus 抓取指标数据                           │</span><br><span class="line">│     └─&gt; 向发现的 targets 的 /metrics 端口发送请求 	   │</span><br><span class="line">│     └─&gt; 存储采集到的时间序列数据                	      │</span><br><span class="line">│                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="3-9-7-常见问题排查"><a href="#3-9-7-常见问题排查" class="headerlink" title="3.9.7 常见问题排查"></a>3.9.7 常见问题排查</h5><p><strong>问题 1：Prometheus 无法连接到 Consul</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查 Consul 是否正常运行</span></span><br><span class="line">consul members</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查端口是否开放</span></span><br><span class="line">netstat -natp | grep :8500</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查防火墙设置</span></span><br><span class="line">firewall-cmd --list-all</span><br></pre></td></tr></table></figure>

<p><strong>问题 2：服务无法被发现</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查服务是否成功注册</span></span><br><span class="line">consul catalog service nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查健康检查是否通过</span></span><br><span class="line">curl http://192.168.118.101:9100/metrics</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Prometheus 日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /usr/local/prometheus/prometheus.log</span><br></pre></td></tr></table></figure>

<p><strong>问题 3：标签不匹配导致服务未被发现</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看已注册服务的标签信息</span></span><br><span class="line">consul catalog service node01</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保 Prometheus 配置中的 tags 与注册的 tags 相匹配</span></span><br></pre></td></tr></table></figure>
<h4 id="对比三种服务发现方式"><a href="#对比三种服务发现方式" class="headerlink" title="对比三种服务发现方式"></a>对比三种服务发现方式</h4><table>
<thead>
<tr>
<th>特性</th>
<th>静态配置</th>
<th>文件服务发现</th>
<th>Consul 服务发现</th>
</tr>
</thead>
<tbody><tr>
<td>配置灵活度</td>
<td>低</td>
<td>中</td>
<td>高</td>
</tr>
<tr>
<td>自动化程度</td>
<td>低（需手动修改）</td>
<td>中（需修改文件）</td>
<td>高（自动发现）</td>
</tr>
<tr>
<td>实时性</td>
<td>无</td>
<td>有延迟（取决于刷新间隔）</td>
<td>实时性好</td>
</tr>
<tr>
<td>健康检查</td>
<td>无</td>
<td>无</td>
<td>有（Consul 原生支持）</td>
</tr>
<tr>
<td>故障转移</td>
<td>无</td>
<td>无</td>
<td>自动转移</td>
</tr>
<tr>
<td>适用场景</td>
<td>小规模、稳定的环境</td>
<td>中等规模、变化不频繁</td>
<td>大规模、动态变化</td>
</tr>
<tr>
<td>学习曲线</td>
<td>平缓</td>
<td>平缓</td>
<td>陡峭</td>
</tr>
</tbody></table>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="核心要点总结"><a href="#核心要点总结" class="headerlink" title="核心要点总结"></a>核心要点总结</h3><h4 id="1-Prometheus-的三大优势"><a href="#1-Prometheus-的三大优势" class="headerlink" title="1. Prometheus 的三大优势"></a>1. Prometheus 的三大优势</h4><ul>
<li><strong>统一的监控平台</strong>：集数据采集、存储、查询和告警于一身</li>
<li><strong>强大的查询能力</strong>：PromQL 提供灵活的数据查询和聚合</li>
<li><strong>完整的生态体系</strong>：丰富的 Exporters、服务发现、告警管理等组件</li>
</ul>
<h4 id="2-关键概念回顾"><a href="#2-关键概念回顾" class="headerlink" title="2. 关键概念回顾"></a>2. 关键概念回顾</h4><ul>
<li><strong>时间序列数据</strong>：Prometheus 中所有数据都是时间序列</li>
<li><strong>标签系统</strong>：通过标签实现数据的多维分析</li>
<li><strong>TSDB 存储</strong>：针对监控数据特性优化的时序数据库</li>
<li><strong>Pull 模式</strong>：主要采用拉取方式，确保系统的被动性和可控性</li>
</ul>
<h4 id="3-部署架构"><a href="#3-部署架构" class="headerlink" title="3. 部署架构"></a>3. 部署架构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">应用/服务 (Exporters)</span><br><span class="line">      ↓ (HTTP 接口)</span><br><span class="line">Prometheus Server (数据采集、存储)</span><br><span class="line">      ↓ (告警规则)</span><br><span class="line">Alertmanager (告警处理、路由、发送)</span><br><span class="line">      ↓ (邮件/钉钉等)</span><br><span class="line">告警接收方</span><br><span class="line">      ↑ (数据源)</span><br><span class="line">Grafana (可视化展示)</span><br></pre></td></tr></table></figure>

<h4 id="4-部署实践要点"><a href="#4-部署实践要点" class="headerlink" title="4. 部署实践要点"></a>4. 部署实践要点</h4><ul>
<li>Prometheus Server 负责核心的采集和存储工作</li>
<li>各类 Exporter 在被监控端收集特定领域的指标数据</li>
<li>Alertmanager 专门负责告警的处理和发送</li>
<li>Grafana 提供友好的数据可视化界面</li>
<li>服务发现机制能够实现动态的目标管理</li>
</ul>
<h4 id="5-PromQL-应用建议"><a href="#5-PromQL-应用建议" class="headerlink" title="5. PromQL 应用建议"></a>5. PromQL 应用建议</h4><ul>
<li>熟练使用标签选择器进行精准数据过滤</li>
<li>理解不同指标类型（Counter、Gauge、Histogram、Summary）的差异</li>
<li>掌握常用的聚合函数进行数据分析</li>
<li>利用偏移修饰符进行时间范围的灵活查询</li>
</ul>
<h4 id="6-最佳实践"><a href="#6-最佳实践" class="headerlink" title="6. 最佳实践"></a>6. 最佳实践</h4><ul>
<li>定期备份 Prometheus 配置文件和告警规则</li>
<li>合理规划数据保留期（平衡存储空间和历史数据需求）</li>
<li>利用标签保持一致性，避免创建无效的时间序列</li>
<li>通过服务发现实现自动化的目标管理</li>
<li>使用 Alertmanager 的分组、去重、抑制功能优化告警</li>
</ul>
<h4 id="7-进阶方向"><a href="#7-进阶方向" class="headerlink" title="7. 进阶方向"></a>7. 进阶方向</h4><ul>
<li>使用 Thanos 或 Cortex 实现 Prometheus 集群的高可用</li>
<li>集成外部存储（InfluxDB、OpenTSDB）进行长期数据存储</li>
<li>开发自定义 Exporter 适配特殊的监控需求</li>
<li>构建完整的可观测性平台（Prometheus + Grafana + ELK）</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">Felix</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2025/12/02/Prometheus/">http://example.com/2025/12/02/Prometheus/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/imgs/adater.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/12/02/Prometheus%E7%9B%91%E6%8E%A7-%E9%92%89%E9%92%89%E8%AD%A6%E5%91%8A-%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3/" title="Prometheus监控+钉钉警告 部署指南"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Prometheus监控+钉钉警告 部署指南</div></div><div class="info-2"><div class="info-item-1">Prometheus监控+钉钉警告 部署指南一、简介及作用简介Prometheus 是一个开源的监控和告警系统，广泛应用于云原生环境中。它通过拉取模式主动采集目标系统的时间序列指标数据，经过灵活的告警规则处理后，由 AlertManager 统一管理和分发告警。钉钉作为企业级实时通讯工具，可通过自定义机器人接收告警消息，让运维团队在第一时间获知系统异常，大大提高了问题的发现和响应效率。 本指南将指导你整合 Prometheus + AlertManager + 钉钉，构建一套企业级的监控告警系统。 系统作用实时监控  全面采集服务器、应用、数据库等各类系统指标 支持自定义指标和应用埋点 毫秒级的数据采集和存储  智能告警  基于阈值和规则的灵活告警机制 支持告警分组、去重和路由 避免告警风暴，提高信号信噪比  及时通知  与钉钉深度集成，告警实时推送到企业群 支持 Markdown 格式的丰富告警消息 构建完整的告警追踪链路  历史数据  长期保存监控数据用于趋势分析 支持数据查询和离线分析 便于问题根因分析和性能优化  适用场景 服务器监控：CPU、内存、磁盘、网络等资源告警 ...</div></div></div></a><a class="pagination-related" href="/2025/12/01/Ansible/" title="Ansible"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Ansible</div></div><div class="info-2"><div class="info-item-1">Ansible 完整学习笔记目录 Ansible 核心概念 环境部署 Ansible 命令行模块 Ansible Playbook Ansible 循环与条件 Ansible Roles 快速手册 面试题   Ansible 核心概念什么是 Ansible？Ansible 是一个基于 Python 开发的开源自动化工具，用于进行配置管理、应用部署、任务编排等工作。它的核心理念是”无Agent”架构，通过 SSH 协议对远程主机进行管理。 Ansible 的核心特性   特性 说明    Agentless 无需在被管理主机上安装任何代理程序   SSH连接 基于 SSH 进行远程连接和操作   幂等性 多次执行相同操作，结果一致   模块化 工作基于模块，每个模块执行特定任务   批量操作 可同时管理成百上千台主机   易于扩展 支持自定义模块和插件   Ansible 工作流程12345678910111213用户执行命令/Playbook        ↓Ansible 解析配置文件        ↓根据主机清单定位目标主机        ↓生成临时执行文件        ↓...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/imgs/adater.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Felix</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/falsezxy"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Prometheus-%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.</span> <span class="toc-text">Prometheus 监控系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9APrometheus-%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.</span> <span class="toc-text">第一部分：Prometheus 基础介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF-Prometheus%EF%BC%9F"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 什么是 Prometheus？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Prometheus-%E7%9A%84%E6%A0%B8%E5%BF%83%E7%89%B9%E7%82%B9"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 Prometheus 的核心特点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E7%BB%B4%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">多维数据模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%88TSDB%EF%BC%89"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">内置时间序列数据库（TSDB）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%81%B5%E6%B4%BB%E7%9A%84%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">灵活的查询语言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">数据采集方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E4%B8%8E%E5%91%8A%E8%AD%A6"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">可视化与告警</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Prometheus-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 Prometheus 配置文件详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%9B%9B%E5%A4%A7%E9%83%A8%E5%88%86"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">配置文件四大部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">配置文件示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E6%97%A5%E5%BF%97%E4%B8%8E%E7%9B%91%E6%8E%A7%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.4 日志与监控的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-Prometheus-%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.5.</span> <span class="toc-text">1.6 Prometheus 的工作模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-Prometheus-%E7%94%9F%E6%80%81%E5%9C%88%E7%BB%84%E4%BB%B6%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.2.6.</span> <span class="toc-text">1.7 Prometheus 生态圈组件详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Prometheus-Server"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">（1）Prometheus Server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Client-Library%EF%BC%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BA%93%EF%BC%89"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">（2）Client Library（客户端库）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89Exporters%EF%BC%88%E6%8C%87%E6%A0%87%E6%9A%B4%E9%9C%B2%E5%99%A8%EF%BC%89"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">（3）Exporters（指标暴露器）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89Service-Discovery%EF%BC%88%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%89"><span class="toc-number">1.2.6.4.</span> <span class="toc-text">（4）Service Discovery（服务发现）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%885%EF%BC%89Alertmanager%EF%BC%88%E5%91%8A%E8%AD%A6%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%89"><span class="toc-number">1.2.6.5.</span> <span class="toc-text">（5）Alertmanager（告警管理器）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%886%EF%BC%89Pushgateway%EF%BC%88%E6%8E%A8%E9%80%81%E7%BD%91%E5%85%B3%EF%BC%89"><span class="toc-number">1.2.6.6.</span> <span class="toc-text">（6）Pushgateway（推送网关）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%887%EF%BC%89Grafana%EF%BC%88%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%EF%BC%89"><span class="toc-number">1.2.6.7.</span> <span class="toc-text">（7）Grafana（可视化工具）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-Prometheus-%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">1.2.7.</span> <span class="toc-text">1.5 Prometheus 的局限性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-TSDB-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%82%E5%90%88-Prometheus%EF%BC%9F"><span class="toc-number">1.2.8.</span> <span class="toc-text">1.6 TSDB 为什么适合 Prometheus？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9APrometheus-%E8%BF%9B%E9%98%B6"><span class="toc-number">1.3.</span> <span class="toc-text">第二部分：Prometheus 进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-PromQL-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 PromQL 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Prometheus-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 Prometheus 数据模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%A0%B7%E6%9C%AC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 样本数据格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-PromQL-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 PromQL 的数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E7%9E%AC%E6%97%B6%E5%90%91%E9%87%8F-Instant-Vector"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">（1）瞬时向量 (Instant Vector)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E5%8C%BA%E9%97%B4%E5%90%91%E9%87%8F-Range-Vector"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">（2）区间向量 (Range Vector)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E6%A0%87%E9%87%8F%E6%95%B0%E6%8D%AE-Scalar"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">（3）标量数据 (Scalar)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E5%AD%97%E7%AC%A6%E4%B8%B2-String"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">（4）字符串 (String)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-number">1.3.5.</span> <span class="toc-text">2.5 时间序列选择器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9E%AC%E6%97%B6%E5%90%91%E9%87%8F%E9%80%89%E6%8B%A9%E5%99%A8%EF%BC%88Instant-Vector-Selectors%EF%BC%89"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">瞬时向量选择器（Instant Vector Selectors）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BA%E9%97%B4%E5%90%91%E9%87%8F%E9%80%89%E6%8B%A9%E5%99%A8%EF%BC%88Range-Vector-Selectors%EF%BC%89"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">区间向量选择器（Range Vector Selectors）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%81%8F%E7%A7%BB%E5%90%91%E9%87%8F%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">偏移向量选择器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-PromQL-%E7%9A%84%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.6.</span> <span class="toc-text">2.6 PromQL 的指标类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Counter%EF%BC%88%E8%AE%A1%E6%95%B0%E5%99%A8%EF%BC%89"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">（1）Counter（计数器）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Gauge%EF%BC%88%E4%BB%AA%E8%A1%A8%E7%9B%98%EF%BC%89"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">（2）Gauge（仪表盘）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89Histogram%EF%BC%88%E7%B4%AF%E7%A7%AF%E7%9B%B4%E6%96%B9%E5%9B%BE%EF%BC%89"><span class="toc-number">1.3.6.3.</span> <span class="toc-text">（3）Histogram（累积直方图）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89Summary%EF%BC%88%E6%91%98%E8%A6%81%EF%BC%89"><span class="toc-number">1.3.6.4.</span> <span class="toc-text">（4）Summary（摘要）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-Prometheus-%E7%9A%84%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.7.</span> <span class="toc-text">2.7 Prometheus 的聚合函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-PromQL-%E8%81%9A%E5%90%88%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.3.8.</span> <span class="toc-text">2.8 PromQL 聚合表达式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9A%E5%AE%9E%E9%AA%8C%E9%83%A8%E7%BD%B2"><span class="toc-number">1.4.</span> <span class="toc-text">第三部分：实验部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E9%83%A8%E7%BD%B2-Prometheus-Server"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 部署 Prometheus Server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%E5%92%8C-SELinux"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">第一步：关闭防火墙和 SELinux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%A7%A3%E5%8E%8B"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">第二步：下载并解压</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E6%9F%A5%E7%9C%8B%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">第三步：查看默认配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6%EF%BC%8C%E5%90%AF%E5%8A%A8systemctl"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">第四步：配置系统启动文件，启动systemctl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.1.5.</span> <span class="toc-text">第五步：启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E9%AA%8C%E8%AF%81"><span class="toc-number">1.4.1.6.</span> <span class="toc-text">第六步：验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E9%83%A8%E7%BD%B2-Node-Exporter"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 部署 Node Exporter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%A7%A3%E5%8E%8B"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">第一步：下载并解压</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">第二步：配置启动文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">第三步：启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E9%AA%8C%E8%AF%81"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">第四步：验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E4%BF%AE%E6%94%B9-Prometheus-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">第五步：修改 Prometheus 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.2.6.</span> <span class="toc-text">第六步：重新加载配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E9%83%A8%E7%BD%B2-MySQL-Exporter"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 部署 MySQL Exporter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%AE%89%E8%A3%85-MySQL%E5%BC%80%E5%90%AF%E7%9B%B8%E5%85%B3%E6%97%A5%E5%BF%97"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">第一步：安装 MySQL开启相关日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85-mysqld-exporter"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">第二步：下载并安装 mysqld_exporter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE-MySQL-%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">第三步：配置 MySQL 连接信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA-MySQL-%E7%94%A8%E6%88%B7%E5%B9%B6%E6%8E%88%E6%9D%83"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">第四步：创建 MySQL 用户并授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">第五步：配置启动文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.3.6.</span> <span class="toc-text">第六步：启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%9A%E4%BF%AE%E6%94%B9-Prometheus-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.3.7.</span> <span class="toc-text">第七步：修改 Prometheus 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E6%AD%A5%EF%BC%9A%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.3.8.</span> <span class="toc-text">第八步：重新加载配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E9%83%A8%E7%BD%B2-Nginx-Exporter-%E5%8F%8A-Nginx-VTS"><span class="toc-number">1.4.4.</span> <span class="toc-text">3.4 部署 Nginx Exporter 及 Nginx VTS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx-VTS-%E7%AE%80%E8%BF%B0"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">Nginx-VTS 简述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E8%A7%A3%E5%8E%8B-Nginx-VTS-%E6%8F%92%E4%BB%B6"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">第一步：解压 Nginx VTS 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%92%8C%E5%88%9B%E5%BB%BA-Nginx-%E7%94%A8%E6%88%B7"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">第二步：安装依赖和创建 Nginx 用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-Nginx"><span class="toc-number">1.4.4.4.</span> <span class="toc-text">第三步：编译安装 Nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE-Nginx"><span class="toc-number">1.4.4.5.</span> <span class="toc-text">第四步：配置 Nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE-Nginx-%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6%E5%92%8C%E5%90%AF%E5%8A%A8"><span class="toc-number">1.4.4.6.</span> <span class="toc-text">第五步：配置 Nginx 启动文件和启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E9%AA%8C%E8%AF%81-Nginx-VTS-%E7%8A%B6%E6%80%81%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.4.4.7.</span> <span class="toc-text">第六步：验证 Nginx VTS 状态页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%9A%E5%AE%89%E8%A3%85-nginx-vts-exporter"><span class="toc-number">1.4.4.8.</span> <span class="toc-text">第七步：安装 nginx-vts-exporter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E6%AD%A5%EF%BC%9A%E4%BF%AE%E6%94%B9-Prometheus-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.4.9.</span> <span class="toc-text">第八步：修改 Prometheus 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E6%AD%A5%EF%BC%9A%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.4.10.</span> <span class="toc-text">第九步：重新加载配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E9%83%A8%E7%BD%B2-Alertmanager"><span class="toc-number">1.4.5.</span> <span class="toc-text">3.5 部署 Alertmanager</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%A7%A3%E5%8E%8B-1"><span class="toc-number">1.4.5.1.</span> <span class="toc-text">第一步：下载并解压</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE-Alertmanager%EF%BC%88%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6%EF%BC%89"><span class="toc-number">1.4.5.2.</span> <span class="toc-text">第二步：配置 Alertmanager（邮件告警）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.5.3.</span> <span class="toc-text">第三步：配置启动文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.5.4.</span> <span class="toc-text">第四步：启动服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E9%85%8D%E7%BD%AE%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">1.4.6.</span> <span class="toc-text">3.6 配置告警规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E7%9B%AE%E5%BD%95"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">第一步：创建告警规则目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.6.2.</span> <span class="toc-text">第二步：创建告警规则文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E4%BF%AE%E6%94%B9-Prometheus-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.6.3.</span> <span class="toc-text">第三步：修改 Prometheus 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.6.4.</span> <span class="toc-text">第四步：重新加载配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-%E9%83%A8%E7%BD%B2-Grafana-%E8%BF%9B%E8%A1%8C%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B1%95%E7%A4%BA"><span class="toc-number">1.4.7.</span> <span class="toc-text">3.7 部署 Grafana 进行可视化展示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85"><span class="toc-number">1.4.7.1.</span> <span class="toc-text">第一步：下载并安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">1.4.7.2.</span> <span class="toc-text">第二步：配置数据源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E5%AF%BC%E5%85%A5%E9%BB%98%E8%AE%A4%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="toc-number">1.4.7.3.</span> <span class="toc-text">第三步：导入默认仪表盘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%AF%BC%E5%85%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF"><span class="toc-number">1.4.7.4.</span> <span class="toc-text">第四步：导入自定义监控面板</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.8.</span> <span class="toc-text">3.8 服务发现配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">1.4.8.1.</span> <span class="toc-text">基于文件的服务发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-Consul-%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">1.4.8.2.</span> <span class="toc-text">基于 Consul 的服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-9-1-Consul-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.4.8.2.1.</span> <span class="toc-text">3.9.1 Consul 简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-9-2-%E9%83%A8%E7%BD%B2-Consul-%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.8.2.2.</span> <span class="toc-text">3.9.2 部署 Consul 服务</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85-1"><span class="toc-number">1.4.8.2.2.1.</span> <span class="toc-text">第一步：下载并安装</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95%E5%92%8C%E9%85%8D%E7%BD%AE%E7%9B%AE%E5%BD%95"><span class="toc-number">1.4.8.2.2.2.</span> <span class="toc-text">第二步：创建数据目录和配置目录</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E5%90%AF%E5%8A%A8-Consul-Server"><span class="toc-number">1.4.8.2.2.3.</span> <span class="toc-text">第三步：启动 Consul Server</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E6%9F%A5%E7%9C%8B-Consul-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98"><span class="toc-number">1.4.8.2.2.4.</span> <span class="toc-text">第四步：查看 Consul 集群成员</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E8%AE%BF%E9%97%AE-Consul-Web-UI"><span class="toc-number">1.4.8.2.2.5.</span> <span class="toc-text">第五步：访问 Consul Web UI</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-9-3-%E5%9C%A8-Consul-%E4%B8%8A%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.8.2.3.</span> <span class="toc-text">3.9.3 在 Consul 上注册服务</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.8.2.3.1.</span> <span class="toc-text">第一步：创建服务配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD-Consul-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.8.2.3.2.</span> <span class="toc-text">第二步：重新加载 Consul 配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.4.8.2.3.3.</span> <span class="toc-text">第三步：验证服务注册</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-9-4-%E9%85%8D%E7%BD%AE-Prometheus-%E4%B8%8E-Consul-%E9%9B%86%E6%88%90"><span class="toc-number">1.4.8.2.4.</span> <span class="toc-text">3.9.4 配置 Prometheus 与 Consul 集成</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%BF%AE%E6%94%B9-Prometheus-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.8.2.4.1.</span> <span class="toc-text">第一步：修改 Prometheus 配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD-Prometheus-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.8.2.4.2.</span> <span class="toc-text">第二步：重新加载 Prometheus 配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">1.4.8.2.4.3.</span> <span class="toc-text">第三步：验证服务发现</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-9-5-%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.8.2.5.</span> <span class="toc-text">3.9.5 服务管理操作</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%B7%B2%E6%B3%A8%E5%86%8C%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.8.2.5.1.</span> <span class="toc-text">查询已注册的服务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E9%94%80%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.8.2.5.2.</span> <span class="toc-text">动态注销服务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.8.2.5.3.</span> <span class="toc-text">重新注册服务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%97%A5%E5%BF%97"><span class="toc-number">1.4.8.2.5.4.</span> <span class="toc-text">查看服务注册日志</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-9-6-Consul-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.8.2.6.</span> <span class="toc-text">3.9.6 Consul 服务发现工作流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-9-7-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="toc-number">1.4.8.2.7.</span> <span class="toc-text">3.9.7 常见问题排查</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94%E4%B8%89%E7%A7%8D%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.8.3.</span> <span class="toc-text">对比三种服务发现方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.1.</span> <span class="toc-text">核心要点总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Prometheus-%E7%9A%84%E4%B8%89%E5%A4%A7%E4%BC%98%E5%8A%BF"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">1. Prometheus 的三大优势</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">2. 关键概念回顾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">3. 部署架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5%E8%A6%81%E7%82%B9"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">4. 部署实践要点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-PromQL-%E5%BA%94%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.5.1.5.</span> <span class="toc-text">5. PromQL 应用建议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.5.1.6.</span> <span class="toc-text">6. 最佳实践</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E8%BF%9B%E9%98%B6%E6%96%B9%E5%90%91"><span class="toc-number">1.5.1.7.</span> <span class="toc-text">7. 进阶方向</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/03/Kubernetes%E4%BA%86%E8%A7%A3%E4%B8%8E%E6%90%AD%E5%BB%BA/" title="Kubernetes了解与搭建">Kubernetes了解与搭建</a><time datetime="2025-12-03T06:44:22.000Z" title="Created 2025-12-03 14:44:22">2025-12-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/02/Prometheus%E7%9B%91%E6%8E%A7-%E9%92%89%E9%92%89%E8%AD%A6%E5%91%8A-%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3/" title="Prometheus监控+钉钉警告 部署指南">Prometheus监控+钉钉警告 部署指南</a><time datetime="2025-12-02T05:39:16.000Z" title="Created 2025-12-02 13:39:16">2025-12-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/02/Prometheus/" title="Prometheus监控系统">Prometheus监控系统</a><time datetime="2025-12-02T00:55:58.000Z" title="Created 2025-12-02 08:55:58">2025-12-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/01/Ansible/" title="Ansible">Ansible</a><time datetime="2025-12-01T00:54:40.000Z" title="Created 2025-12-01 08:54:40">2025-12-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/27/Harbor%20%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%AE%8C%E6%95%B4%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/" title="Harbor 私有镜像仓库完整部署指南">Harbor 私有镜像仓库完整部署指南</a><time datetime="2025-11-27T10:54:40.000Z" title="Created 2025-11-27 18:54:40">2025-11-27</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/imgs/background_footer.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Felix</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.0.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.1"></script><script src="/js/main.js?v=5.5.1"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>