<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kubernetes-Ingress服务 | Felix的个人博客</title><meta name="author" content="Felix"><meta name="copyright" content="Felix"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Kubernetes-Ingress服务一、Ingress 概述1. 为什么需要 Ingress？K8s 内的 Pod IP 与 Service ClusterIP 仅在集群内部可见。为了让外部应用访问集群内服务，K8s 提供了多种方案： 现有方案的问题 NodePort：适合测试，但服务数量多时端口管理困难（端口范围 30000-32767，每个端口仅服务一种服务） LoadBalancer：需">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes-Ingress服务">
<meta property="og:url" content="http://example.com/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/index.html">
<meta property="og:site_name" content="Felix的个人博客">
<meta property="og:description" content="Kubernetes-Ingress服务一、Ingress 概述1. 为什么需要 Ingress？K8s 内的 Pod IP 与 Service ClusterIP 仅在集群内部可见。为了让外部应用访问集群内服务，K8s 提供了多种方案： 现有方案的问题 NodePort：适合测试，但服务数量多时端口管理困难（端口范围 30000-32767，每个端口仅服务一种服务） LoadBalancer：需">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/imgs/adater.jpg">
<meta property="article:published_time" content="2025-12-16T10:12:58.000Z">
<meta property="article:modified_time" content="2025-12-16T11:14:16.802Z">
<meta property="article:author" content="Felix">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/imgs/adater.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kubernetes-Ingress服务",
  "url": "http://example.com/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/",
  "image": "http://example.com/imgs/adater.jpg",
  "datePublished": "2025-12-16T10:12:58.000Z",
  "dateModified": "2025-12-16T11:14:16.802Z",
  "author": [
    {
      "@type": "Person",
      "name": "Felix",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes-Ingress服务',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.0.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/imgs/background_header.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Felix的个人博客</span></a><a class="nav-page-title" href="/"><span class="site-name">Kubernetes-Ingress服务</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">Kubernetes-Ingress服务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-12-16T10:12:58.000Z" title="Created 2025-12-16 18:12:58">2025-12-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-12-16T11:14:16.802Z" title="Updated 2025-12-16 19:14:16">2025-12-16</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Kubernetes-Ingress服务"><a href="#Kubernetes-Ingress服务" class="headerlink" title="Kubernetes-Ingress服务"></a>Kubernetes-Ingress服务</h1><h2 id="一、Ingress-概述"><a href="#一、Ingress-概述" class="headerlink" title="一、Ingress 概述"></a>一、Ingress 概述</h2><h3 id="1-为什么需要-Ingress？"><a href="#1-为什么需要-Ingress？" class="headerlink" title="1. 为什么需要 Ingress？"></a>1. 为什么需要 Ingress？</h3><p>K8s 内的 Pod IP 与 Service ClusterIP 仅在集群内部可见。为了让<strong>外部应用</strong>访问集群内服务，K8s 提供了多种方案：</p>
<h4 id="现有方案的问题"><a href="#现有方案的问题" class="headerlink" title="现有方案的问题"></a>现有方案的问题</h4><ul>
<li><strong>NodePort</strong>：适合测试，但服务数量多时端口管理困难（端口范围 30000-32767，每个端口仅服务一种服务）</li>
<li><strong>LoadBalancer</strong>：需要云厂商支持，通常需要额外费用，仅适合公有云</li>
<li><strong>externalIPs</strong>：为 service 分配外部 IP，配置相对复杂</li>
</ul>
<h4 id="Ingress（七层反向代理）-的优势"><a href="#Ingress（七层反向代理）-的优势" class="headerlink" title="Ingress（七层反向代理） 的优势"></a>Ingress（七层反向代理） 的优势</h4><ul>
<li>仅用一个或少量的公网 IP&#x2F;LB，即可同时将多个 HTTP&#x2F;HTTPS 服务暴露到外网</li>
<li>可理解为**”service 的 service”<strong>：基于</strong>域名&#x2F;URL 路径**将请求转发到一个或多个 service</li>
<li><strong>集中管理端口</strong>，减少 K8s 对外暴露的入口数量</li>
</ul>
<p><img src="/./imgs/image-20251216185022120.png" alt="image-20251216185022120"></p>
<hr>
<h2 id="二、Ingress-的核心组件"><a href="#二、Ingress-的核心组件" class="headerlink" title="二、Ingress 的核心组件"></a>二、Ingress 的核心组件</h2><h3 id="1-Ingress（规则定义）"><a href="#1-Ingress（规则定义）" class="headerlink" title="1. Ingress（规则定义）"></a>1. Ingress（规则定义）</h3><ul>
<li>以 <strong>YAML</strong> 格式定义的 <strong>API 对象</strong></li>
<li>定义请求如何转发到 service 的规则</li>
<li>能提供：外部 URL、负载均衡、SSL&#x2F;TLS、基于域名的反向代理</li>
<li>具体功能需 <strong>Ingress Controller</strong> 实现</li>
</ul>
<h3 id="2-Ingress-Controller（执行转发）"><a href="#2-Ingress-Controller（执行转发）" class="headerlink" title="2. Ingress Controller（执行转发）"></a>2. Ingress Controller（执行转发）</h3><ul>
<li>解析 Ingress 规则并实现反向代理与负载均衡</li>
<li>不是 K8s 自带组件，是一类实现的统称：<ul>
<li>官方维护：<strong>ingress-nginx</strong>（推荐）、GCE</li>
<li>第三方实现：Traefik、Kong、Nginx Inc. 等</li>
</ul>
</li>
<li>典型形态：一个 Pod 内同时运行<strong>守护进程</strong>（监控集群配置）与<strong>反向代理程序</strong>（如 Nginx）</li>
<li><strong>ingress-nginx</strong> 特性：动态生成 Nginx 配置、更新 upstream、按需 reload</li>
</ul>
<blockquote>
<p><strong>结论</strong>：<strong>Ingress Controller</strong> 是真正的流量入口；<strong>Ingress 对象</strong>告诉 Controller 如何转发</p>
</blockquote>
<hr>
<h2 id="三、Ingress-工作原理"><a href="#三、Ingress-工作原理" class="headerlink" title="三、Ingress 工作原理"></a>三、Ingress 工作原理</h2><ol>
<li>Ingress Controller 与 <strong>APIServer</strong> 交互，动态感知 Ingress 规则变化</li>
<li>读取规则并按自定义模板生成 <strong>Nginx 配置文件</strong></li>
<li>将生成的 nginx 配置写入 ingress-controller pod 内的 <code>/etc/nginx/nginx.conf</code></li>
<li>执行 <strong>reload</strong> 使配置生效，实现按域名分流与动态更新</li>
</ol>
<p><img src="/./imgs/image-20251216184837955.png" alt="image-20251216184837955"></p>
<hr>
<h2 id="四、K8s-网络分层架构"><a href="#四、K8s-网络分层架构" class="headerlink" title="四、K8s 网络分层架构"></a>四、K8s 网络分层架构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">L7 入口 (Ingress)</span><br><span class="line">    ↓</span><br><span class="line">L4 服务发现 (Service)</span><br><span class="line">    ↓</span><br><span class="line">Pod 内通讯 (CNI 插件：flannel)</span><br><span class="line">    ↓</span><br><span class="line">容器间通讯 (pause 容器：localhost)</span><br></pre></td></tr></table></figure>

<p><strong>关键概念</strong>：</p>
<ul>
<li>Service 通过 <strong>endpoints</strong> 找到后端 Pod</li>
<li>CNI 插件（如 flannel）负责 Pod 间网络通讯</li>
<li>Pause 容器提供 Pod 内容器间的 localhost 通讯</li>
</ul>
<hr>
<h2 id="五、Service-服务发现与暴露模式"><a href="#五、Service-服务发现与暴露模式" class="headerlink" title="五、Service 服务发现与暴露模式"></a>五、Service 服务发现与暴露模式</h2><h3 id="Service-类型对比"><a href="#Service-类型对比" class="headerlink" title="Service 类型对比"></a>Service 类型对比</h3><table>
<thead>
<tr>
<th>类型</th>
<th>用途</th>
<th>特点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ClusterIP</strong></td>
<td>集群内通讯</td>
<td>直接访问 Service IP</td>
<td>无法对外暴露</td>
</tr>
<tr>
<td><strong>Headless</strong></td>
<td>StatefulSet 场景</td>
<td>无 Service IP，直接解析 Pod 名称访问 Pod IP</td>
<td>需手动管理</td>
</tr>
<tr>
<td><strong>NodePort</strong></td>
<td>开发测试</td>
<td>Kube-proxy 映射 Service→节点 IP+随机端口</td>
<td>端口管理困难，安全风险高</td>
</tr>
<tr>
<td><strong>LoadBalancer</strong></td>
<td>公有云</td>
<td>云厂商自动创建 LB</td>
<td>需要额外费用，仅云环境可用</td>
</tr>
<tr>
<td><strong>ExternalName</strong></td>
<td>外部服务</td>
<td>通过 DNS CNAME 解析</td>
<td>使用较少</td>
</tr>
</tbody></table>
<p><strong>端口管理示例</strong>：</p>
<ul>
<li>若有 50 个微服务，平均 3 个服务端口 → 集群需暴露 150 个端口</li>
<li>导致：端口管理困难，安全问题持续上升 → <strong>Ingress 解决</strong></li>
</ul>
<hr>
<h2 id="六、Ingress-Controller-部署（ingress-nginx-示例）"><a href="#六、Ingress-Controller-部署（ingress-nginx-示例）" class="headerlink" title="六、Ingress Controller 部署（ingress-nginx 示例）"></a>六、Ingress Controller 部署（ingress-nginx 示例）</h2><h3 id="获取官方清单"><a href="#获取官方清单" class="headerlink" title="获取官方清单"></a>获取官方清单</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/ingress &amp;&amp; <span class="built_in">cd</span> /opt/ingress</span><br><span class="line"></span><br><span class="line"><span class="comment"># 官方地址</span></span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 国内镜像</span></span><br><span class="line">wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.30.0/deploy/static/mandatory.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong>：mandatory.yaml 包含 namespace、ConfigMap、Role、ServiceAccount 等所有部署所需资源</p>
</blockquote>
<h3 id="修改-RBAC-权限（0-25-版本）"><a href="#修改-RBAC-权限（0-25-版本）" class="headerlink" title="修改 RBAC 权限（0.25+ 版本）"></a>修改 RBAC 权限（0.25+ 版本）</h3><p>在 <code>mandatory.yaml</code> 中的 <code>ClusterRole</code> 规则中添加 <code>networking.k8s.io</code> API 组：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;extensions&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;networking.k8s.io&quot;</span>  <span class="comment"># 增加此行</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">update</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、三种部署模式对比"><a href="#七、三种部署模式对比" class="headerlink" title="七、三种部署模式对比"></a>七、三种部署模式对比</h2><h3 id="模式一：Deployment-LoadBalancer（云端方案）"><a href="#模式一：Deployment-LoadBalancer（云端方案）" class="headerlink" title="模式一：Deployment + LoadBalancer（云端方案）"></a>模式一：Deployment + LoadBalancer（云端方案）</h3><p><strong>适用场景</strong>：公有云环境</p>
<p><strong>理由</strong>：如果要把ingress部署在公有云，那用这种方式比较合适。用Deployment部署ingress-controller，创建一个 type为 LoadBalancer 的 service 关联这组 pod。大部分公有云，都会为 LoadBalancer 的 service 自动创建一个负载均衡器，通常还绑定了公网地址。 只要把域名解析指向该地址，就实现了集群服务的对外暴露</p>
<p><strong>优点</strong>：</p>
<ul>
<li>LB 自动创建并绑定公网 IP</li>
<li>域名解析指向 LB IP 即可完成对外暴露</li>
<li>无需额外配置</li>
</ul>
<p><img src="/./imgs/image-20251216184649481.png" alt="image-20251216184649481"></p>
<p><strong>配置</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f mandatory.yaml</span><br><span class="line"><span class="comment"># 云厂商自动为 LoadBalancer 类型 service 创建 LB</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="模式二：DaemonSet-HostNetwork-NodeSelector（生产推荐）"><a href="#模式二：DaemonSet-HostNetwork-NodeSelector（生产推荐）" class="headerlink" title="模式二：DaemonSet + HostNetwork + NodeSelector（生产推荐）"></a>模式二：DaemonSet + HostNetwork + NodeSelector（生产推荐）</h3><p><strong>适用场景</strong>：大并发生产环境</p>
<p><strong>理由</strong>：用DaemonSet结合nodeselector来部署ingress-controller到特定的node上，然后使用HostNetwork直接把该pod与宿主机node的网络打通，直接使用宿主机的80&#x2F;433端口就能访问服务。这时，ingress-controller所在的node机器就很类似传统架构的边缘节点，比如机房入口的nginx服务器。该方式整个请求链路最简单，性能相对NodePort模式更好。缺点是由于直接利用宿主机节点的网络和端口，一个node只能部署一个ingress-controller pod。 比较适合大并发的生产环境使用。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>直接占用宿主机 80&#x2F;443 端口</li>
<li>请求链路最短，<strong>性能最好</strong></li>
<li>适合大并发场景</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>一个 node 仅能运行一个 ingress-controller pod</li>
<li>若需高可用，需前置 LVS + keepalived</li>
</ul>
<p><strong>实施步骤</strong>：</p>
<h4 id="1、给-node-打标签，仅在-node02-运行："><a href="#1、给-node-打标签，仅在-node02-运行：" class="headerlink" title="1、给 node 打标签，仅在 node02 运行："></a>1、给 node 打标签，仅在 <code>node02</code> 运行：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node node02 ingress=<span class="literal">true</span></span><br><span class="line">kubectl get nodes --show-labels</span><br></pre></td></tr></table></figure>

<h4 id="2、将-Deployment-改为-DaemonSet，启用-HostNetwork-并指定-node："><a href="#2、将-Deployment-改为-DaemonSet，启用-HostNetwork-并指定-node：" class="headerlink" title="2、将 Deployment 改为 DaemonSet，启用 HostNetwork 并指定 node："></a>2、将 <strong>Deployment</strong> 改为 <strong>DaemonSet</strong>，启用 HostNetwork 并指定 node：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">vim mandatory.yaml</span><br><span class="line">...</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line"><span class="comment"># 修改 kind</span></span><br><span class="line"><span class="comment"># kind: Deployment</span></span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line"><span class="comment"># 删除Replicas</span></span><br><span class="line"><span class="comment"># replicas: 1</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: ingress-nginx</span><br><span class="line">      app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/port: <span class="string">&quot;10254&quot;</span></span><br><span class="line">        prometheus.io/scrape: <span class="string">&quot;true&quot;</span></span><br><span class="line">    spec:</span><br><span class="line">      <span class="comment"># 使用主机网络</span></span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 选择节点运行</span></span><br><span class="line">      nodeSelector:</span><br><span class="line">        ingress: <span class="string">&quot;true&quot;</span></span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="3、在所有-node-上传镜像并加载："><a href="#3、在所有-node-上传镜像并加载：" class="headerlink" title="3、在所有 node 上传镜像并加载："></a>3、在所有 node 上传镜像并加载：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/ingress</span><br><span class="line"><span class="comment"># 假设已有压缩包 ingree.contro.tar.gz</span></span><br><span class="line">tar zxvf ingree.contro.tar.gz</span><br><span class="line">docker load -i ingree.contro.tar</span><br></pre></td></tr></table></figure>

<h4 id="4、启动-Controller，验证监听端口（在-node02）："><a href="#4、启动-Controller，验证监听端口（在-node02）：" class="headerlink" title="4、启动 Controller，验证监听端口（在 node02）："></a>4、启动 Controller，验证监听端口（在 node02）：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n ingress-nginx -o wide</span><br><span class="line">kubectl get cm,daemonset -n ingress-nginx -o wide</span><br><span class="line">netstat -lntp | grep nginx</span><br><span class="line"><span class="comment"># 期望监听：80 / 443 / 8181 / 10254</span></span><br><span class="line"></span><br><span class="line">netstat -lntp | grep nginx</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      7131/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:8181            0.0.0.0:*               LISTEN      7131/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      7131/nginx: master  </span><br><span class="line">tcp6       0      0 :::10254                :::*                    LISTEN      7098/nginx-ingress- </span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：<code>8181</code> 为默认 backend 端口（未匹配到规则时流量进入此处）。若需高可用，可在多节点部署，并在前面加 <strong>LVS + keepalived</strong> 做负载均衡。</p>
</blockquote>
<h4 id="5、创建-ingress-规则"><a href="#5、创建-ingress-规则" class="headerlink" title="5、创建 ingress 规则"></a>5、创建 ingress 规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###创建一个 deploy 和 svc</span></span><br><span class="line">vim service-nginx.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app-svc</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br></pre></td></tr></table></figure>

<h4 id="6、创建-Ingress（两种-API-示例）："><a href="#6、创建-Ingress（两种-API-示例）：" class="headerlink" title="6、创建 Ingress（两种 API 示例）："></a>6、创建 Ingress（两种 API 示例）：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一：extensions/v1beta1（1.22 即将弃用）</span></span><br><span class="line">vim ingress-app.yaml	</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: www.benet.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx-app-svc</span><br><span class="line">          servicePort: 80</span><br><span class="line"><span class="comment"># 方法二：networking.k8s.io/v1（推荐）</span></span><br><span class="line">vim ingress-app.yaml	</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: www.benet.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix  <span class="comment"># 也可使用 Exact</span></span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-app-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>路径匹配：</strong></p>
<ul>
<li><code>Prefix</code>：基于前缀匹配，如 <code>/0805</code> 可匹配 <code>/0805、</code>&#x2F;0805&#x2F;yjs<code>、</code>&#x2F;0805&#x2F;yjs&#x2F;zjl&#96;。</li>
<li><code>Exact</code>：完全匹配，如 <code>/0805</code> 只能匹配 <code>/0805</code>。</li>
</ul>
</blockquote>
<h4 id="7、测试："><a href="#7、测试：" class="headerlink" title="7、测试："></a>7、测试：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f service-nginx.yaml</span><br><span class="line">kubectl apply -f ingress-app.yaml</span><br><span class="line">kubectl get ingress</span><br><span class="line"><span class="comment"># /etc/hosts 添加解析：</span></span><br><span class="line"><span class="comment"># 192.168.10.21 www.benet.com</span></span><br><span class="line">curl www.benet.com</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可进入 Controller Pod 查看生成的 <code>/etc/nginx/nginx.conf</code>，确认 <code>server www.benet.com</code> 段落。</p>
</blockquote>
<hr>
<h3 id="模式三：Deployment-Service-NodePort-（常规方案）"><a href="#模式三：Deployment-Service-NodePort-（常规方案）" class="headerlink" title="模式三：Deployment + Service(NodePort)（常规方案）"></a>模式三：Deployment + Service(NodePort)（常规方案）</h3><p><strong>适用场景</strong>：中小规模集群或开发环境</p>
<p><strong>特点</strong>：</p>
<ul>
<li>多一层 kube-proxy NAT 映射</li>
<li>大流量场景可能影响性能</li>
<li>通常前置一层负载均衡器</li>
</ul>
<p><strong>部署步骤</strong>：</p>
<h4 id="1、下载-nginx-ingress-controller-和-ingress-nginx-暴露端口配置文件"><a href="#1、下载-nginx-ingress-controller-和-ingress-nginx-暴露端口配置文件" class="headerlink" title="1、下载 nginx-ingress-controller 和 ingress-nginx 暴露端口配置文件"></a>1、下载 nginx-ingress-controller 和 ingress-nginx 暴露端口配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/ingress-nodeport &amp;&amp; <span class="built_in">cd</span> /opt/ingress-nodeport</span><br><span class="line"><span class="comment"># 清单获取</span></span><br><span class="line">官方下载地址：</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span><br><span class="line"><span class="comment"># 或国内镜像：</span></span><br><span class="line">wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.30.0/deploy/static/mandatory.yaml</span><br><span class="line">wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在所有 node 节点上传镜像包 ingress-controller-0.30.0.tar 到 /opt/ingress-nodeport 目录，并加载镜像</span></span><br><span class="line">docker load -i ingress-controller-0.30.0.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Controller 与 NodePort Service</span></span><br><span class="line">kubectl apply -f mandatory.yaml</span><br><span class="line">kubectl apply -f service-nodeport.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果K8S Pod 调度失败，在 kubectl describe pod资源时显示：</span></span><br><span class="line"><span class="comment"># Warning  FailedScheduling  ...  didn&#x27;t match node selector</span></span><br><span class="line"><span class="comment"># 解决：</span></span><br><span class="line"><span class="comment"># 1) 按 YAML 中的 nodeSelector 给节点加标签</span></span><br><span class="line">kubectl label nodes &lt;node_name&gt; kubernetes.io/os=linux</span><br><span class="line"><span class="comment"># 2) 或删除 YAML 中的 nodeSelector</span></span><br><span class="line"></span><br><span class="line">kubectl get pod,svc -n ingress-nginx</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251216153920626.png" alt="image-20251216153920626"></p>
<p>启动controller</p>
<p><img src="/./imgs/image-20251216154642569.png" alt="image-20251216154642569"></p>
<p>启动NodePort Service</p>
<p><img src="/./imgs/image-20251216154748647.png" alt="image-20251216154748647"></p>
<p><img src="/./imgs/image-20251216154933520.png" alt="image-20251216154933520"></p>
<p>详细访问效果看八部分</p>
<hr>
<h2 id="八、Ingress-规则配置详解"><a href="#八、Ingress-规则配置详解" class="headerlink" title="八、Ingress 规则配置详解"></a>八、Ingress 规则配置详解</h2><h3 id="8-1-基础-HTTP-代理"><a href="#8-1-基础-HTTP-代理" class="headerlink" title="8.1 基础 HTTP 代理"></a>8.1 基础 HTTP 代理</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建后端应用</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 暴露 Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-app-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 配置 Ingress（networking.k8s.io/v1，推荐）</span></span><br><span class="line"><span class="comment"># Ingress的配置类似于配置nginx.conf</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-app-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.benet.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span>  <span class="comment"># Prefix：前缀匹配；Exact：完全匹配</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-app-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><strong>路径匹配说明</strong>：</p>
<ul>
<li><code>Prefix</code>：基于前缀匹配，如 <code>/api</code> 可匹配 <code>/api</code>、<code>/api/users</code>、<code>/api/users/123</code></li>
<li><code>Exact</code>：完全匹配，如 <code>/api</code> 只能匹配 <code>/api</code></li>
</ul>
<p><strong>验证步骤</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ingress-nginx.yaml</span><br><span class="line">kubectl get ingress</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 ingress-controller 所在节点配置 hosts</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;192.168.110.130 www.benet.com&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">curl www.benet.com  <span class="comment"># 直接访问（HostNetwork 模式）</span></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">curl www.benet.com:31605  <span class="comment"># NodePort 模式（31605 为映射端口）</span></span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251216182546954.png" alt="image-20251216182546954"></p>
<p><img src="/./imgs/image-20251216182553557.png" alt="image-20251216182553557"></p>
<h3 id="8-2-虚拟主机（多域名）"><a href="#8-2-虚拟主机（多域名）" class="headerlink" title="8.2 虚拟主机（多域名）"></a>8.2 虚拟主机（多域名）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署两套应用</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deployment1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">soscscs/myapp:v1</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 第二个应用类似（myapp:v2、svc-2）...</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Ingress 规则：双主机名</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-vhost</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www1.benet.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc-1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www2.benet.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc-2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><strong>测试</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设NodePort端口为32383</span></span><br><span class="line">curl www1.benet.com:32383  <span class="comment"># 返回 v1</span></span><br><span class="line">curl www2.benet.com:32383  <span class="comment"># 返回 v2</span></span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251216182628557.png" alt="image-20251216182628557"></p>
<p><img src="/./imgs/image-20251216182635036.png" alt="image-20251216182635036"></p>
<h3 id="8-3-HTTPS-TLS-配置"><a href="#8-3-HTTPS-TLS-配置" class="headerlink" title="8.3 HTTPS&#x2F;TLS 配置"></a>8.3 HTTPS&#x2F;TLS 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成自签证书</span></span><br><span class="line">openssl req -x509 -sha256 -nodes -days 365 \</span><br><span class="line">  -newkey rsa:2048 -keyout tls.key -out tls.crt \</span><br><span class="line">  -subj <span class="string">&quot;/CN=nginxsvc/O=nginxsvc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 secret</span></span><br><span class="line">kubectl create secret tls tls-secret --key tls.key --cert tls.crt</span><br><span class="line">kubectl get secret tls-secret -o yaml</span><br><span class="line"><span class="comment"># ingress-https.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc-01</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    name: nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-https</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">    - hosts:</span><br><span class="line">      - www3.benet.com</span><br><span class="line">      secretName: tls-secret</span><br><span class="line">  rules:</span><br><span class="line">    - host: www3.benet.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          pathType: Prefix</span><br><span class="line">          backend:</span><br><span class="line">            service:</span><br><span class="line">              name: nginx-svc-01</span><br><span class="line">              port:</span><br><span class="line">                number: 80</span><br><span class="line"> </span><br><span class="line">kubectl apply -f ingress-https.yaml</span><br><span class="line"></span><br><span class="line">kubectl get svc -n ingress-nginx</span><br><span class="line">NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">ingress-nginx   NodePort   10.96.67.119   &lt;none&gt;        80:32383/TCP,443:32133/TCP   3h41m</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设 443:32133 映射</span></span><br><span class="line"><span class="comment"># hosts 添加：192.168.10.21 www3.benet.com</span></span><br><span class="line"><span class="comment"># 浏览器访问：https://www3.benet.com:32133</span></span><br><span class="line">curl --insecure https://www3.benet.com:32133</span><br></pre></td></tr></table></figure>

<h3 id="8-4-BasicAuth-认证"><a href="#8-4-BasicAuth-认证" class="headerlink" title="8.4 BasicAuth 认证"></a>8.4 BasicAuth 认证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/ingress-nodeport/basic-auth &amp;&amp; <span class="built_in">cd</span> /opt/ingress-nodeport/basic-auth</span><br><span class="line"><span class="comment"># 生成 auth 文件</span></span><br><span class="line">yum -y install httpd</span><br><span class="line">htpasswd -c auth zhangsan  <span class="comment"># 交互式输入密码</span></span><br><span class="line"><span class="comment"># 存为 secret</span></span><br><span class="line">kubectl create secret generic basic-auth --from-file=auth</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-auth</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-type: basic</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-secret: basic-auth</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-realm: <span class="string">&#x27;Authentication Required - zhangsan&#x27;</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: auth.benet.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<p><strong>验证</strong>：需要输入用户名密码才能访问</p>
<h3 id="8-5-URL-重写（Rewrite）"><a href="#8-5-URL-重写（Rewrite）" class="headerlink" title="8.5 URL 重写（Rewrite）"></a>8.5 URL 重写（Rewrite）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ingress-rewrite.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-rewrite</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">http://www1.benet.com:32383</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">re.benet.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><strong>常用注解</strong>：</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/rewrite-target</code>：重定向目标 URI（必填）</li>
<li><code>nginx.ingress.kubernetes.io/ssl-redirect</code>：是否仅允许 SSL（默认 true）</li>
<li><code>nginx.ingress.kubernetes.io/force-ssl-redirect</code>：强制 HTTPS 跳转</li>
<li><code>nginx.ingress.kubernetes.io/app-root</code>：应用根路径</li>
<li><code>nginx.ingress.kubernetes.io/use-regex</code>：路径是否使用正则</li>
</ul>
<hr>
<h2 id="九、问题排查与调试"><a href="#九、问题排查与调试" class="headerlink" title="九、问题排查与调试"></a>九、问题排查与调试</h2><h3 id="查看-Controller-运行状态"><a href="#查看-Controller-运行状态" class="headerlink" title="查看 Controller 运行状态"></a>查看 Controller 运行状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Pod 与端口</span></span><br><span class="line">kubectl get pod -n ingress-nginx -o wide</span><br><span class="line">kubectl get svc -n ingress-nginx</span><br><span class="line">netstat -lntp | grep nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 ConfigMap 和资源</span></span><br><span class="line">kubectl get cm,daemonset -n ingress-nginx -o wide</span><br></pre></td></tr></table></figure>

<h3 id="进入-Pod-检查-Nginx-配置"><a href="#进入-Pod-检查-Nginx-配置" class="headerlink" title="进入 Pod 检查 Nginx 配置"></a>进入 Pod 检查 Nginx 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it &lt;controller-pod&gt; -n ingress-nginx -- /bin/bash</span><br><span class="line">more /etc/nginx/nginx.conf</span><br><span class="line"><span class="comment"># 查找 server www.benet.com ... end server www.benet.com 段落</span></span><br></pre></td></tr></table></figure>

<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p><strong>问题 1</strong>：调度失败，提示 <code>didn&#39;t match node selector</code></p>
<ul>
<li><p><strong>解决</strong>：给目标节点加对应标签，或删除 YAML 中的 <code>nodeSelector</code></p>
</li>
<li><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes &lt;node_name&gt; kubernetes.io/os=linux</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>问题 2</strong>：Ingress 创建后仍无法访问</p>
<ul>
<li>检查 hosts 文件是否配置</li>
<li>检查防火墙是否开放端口</li>
<li>验证后端 Pod 是否正常运行：<code>kubectl get pods</code></li>
</ul>
<hr>
<h2 id="十、实践总结"><a href="#十、实践总结" class="headerlink" title="十、实践总结"></a>十、实践总结</h2><h3 id="完整配置流程"><a href="#完整配置流程" class="headerlink" title="完整配置流程"></a>完整配置流程</h3><ol>
<li><strong>部署 ingress-controller</strong><ul>
<li>创建 namespace、RBAC、ConfigMap</li>
<li>部署 ingress-controller pod（选择合适的部署模式）</li>
<li>创建 Service 暴露 controller</li>
</ul>
</li>
<li><strong>配置后端应用</strong><ul>
<li>创建 Deployment</li>
<li>创建 ClusterIP Service</li>
</ul>
</li>
<li><strong>定义 Ingress 规则</strong><ul>
<li>编写 Ingress YAML（指定域名、路径、后端 service）</li>
<li>配置 TLS、认证等高级功能</li>
</ul>
</li>
<li><strong>验证与测试</strong><ul>
<li>配置 hosts 解析</li>
<li>curl 测试域名访问</li>
<li>检查 nginx.conf 配置是否生成</li>
</ul>
</li>
</ol>
<h3 id="生产最佳实践"><a href="#生产最佳实践" class="headerlink" title="生产最佳实践"></a>生产最佳实践</h3><ul>
<li><strong>高可用</strong>：多节点 DaemonSet 部署 + 前置 LVS + keepalived</li>
<li><strong>性能优化</strong>：采用 <strong>DaemonSet + HostNetwork</strong> 模式，避免多层 NAT</li>
<li><strong>监控告警</strong>：接入 Prometheus 采集 ingress-controller 指标（10254 端口）</li>
<li><strong>安全加固</strong>：<ul>
<li>配置 TLS&#x2F;HTTPS</li>
<li>启用 BasicAuth 或 OAuth2 认证</li>
<li>考虑 WAF、限速等防护</li>
<li>定期更新证书</li>
</ul>
</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li>官方 GitHub：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx">https://github.com/kubernetes/ingress-nginx</a></li>
<li>官方网站：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/">https://kubernetes.github.io/ingress-nginx/</a></li>
<li>认证示例：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/examples/auth/basic/">https://kubernetes.github.io/ingress-nginx/examples/auth/basic/</a></li>
</ul>
<h1 id="补充——Kubernetes-安全机制"><a href="#补充——Kubernetes-安全机制" class="headerlink" title="补充——Kubernetes 安全机制"></a>补充——Kubernetes 安全机制</h1><h2 id="一、核心概念"><a href="#一、核心概念" class="headerlink" title="一、核心概念"></a>一、核心概念</h2><h3 id="1-安全机制的本质"><a href="#1-安全机制的本质" class="headerlink" title="1. 安全机制的本质"></a>1. 安全机制的本质</h3><p>Kubernetes 的安全问题本质是：<strong>如何保护 API Server 的安全访问</strong></p>
<p>API Server 是 K8s 集群的大脑，所有请求都要经过它。要保证安全，需要三道防线：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">请求到达 API Server</span><br><span class="line">    ↓</span><br><span class="line">【第1道：认证】你是谁？ ← 验证身份</span><br><span class="line">    ↓</span><br><span class="line">【第2道：鉴权】你能做什么？ ← 检查权限</span><br><span class="line">    ↓</span><br><span class="line">【第3道：准入控制】是否允许执行？ ← 策略检查</span><br><span class="line">    ↓</span><br><span class="line">请求执行</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、三道防线详解"><a href="#二、三道防线详解" class="headerlink" title="二、三道防线详解"></a>二、三道防线详解</h2><h3 id="第1道：认证（Authentication）-你是谁？"><a href="#第1道：认证（Authentication）-你是谁？" class="headerlink" title="第1道：认证（Authentication）- 你是谁？"></a>第1道：认证（Authentication）- 你是谁？</h3><p><strong>作用</strong>：确认访问者的身份，就像门卡验证</p>
<h4 id="认证方式对比"><a href="#认证方式对比" class="headerlink" title="认证方式对比"></a>认证方式对比</h4><table>
<thead>
<tr>
<th>方式</th>
<th>原理</th>
<th>安全性</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>HTTP Token</strong></td>
<td>HTTP Header 携带难以仿冒的长 Token</td>
<td>中等</td>
<td>服务间调用</td>
</tr>
<tr>
<td><strong>HTTP Basic</strong></td>
<td>用户名:密码 Base64 编码放入 Header</td>
<td>低（容易被截获）</td>
<td>开发测试</td>
</tr>
<tr>
<td><strong>HTTPS 证书</strong></td>
<td>CA 根证书签名的双向 TLS 认证</td>
<td>最高</td>
<td>生产环境（推荐）</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>关键点</strong>：Token 和 Basic 是单向认证（只验证客户端）；HTTPS 证书是双向认证（客户端和服务端都验证）</p>
</blockquote>
<h4 id="需要被认证的组件"><a href="#需要被认证的组件" class="headerlink" title="需要被认证的组件"></a>需要被认证的组件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">API Server 被这些组件访问，都需要认证：</span><br><span class="line">├─ kubectl（用户命令行）→ 需要证书</span><br><span class="line">├─ kubelet（节点代理）→ 需要证书或 token</span><br><span class="line">├─ kube-proxy（网络代理）→ 需要证书</span><br><span class="line">├─ controller-manager → 同机无安全端口，走 8080</span><br><span class="line">├─ scheduler → 同机无安全端口，走 8080</span><br><span class="line">└─ Pod 内的应用 → 使用 Service Account（SA）+ token</span><br></pre></td></tr></table></figure>

<p><strong>关键端口</strong>：</p>
<ul>
<li><code>6443</code>：HTTPS 安全端口（需要证书认证）</li>
<li><code>8080</code>：HTTP 非安全端口（同机组件使用，无认证）</li>
</ul>
<h4 id="证书的产生方式"><a href="#证书的产生方式" class="headerlink" title="证书的产生方式"></a>证书的产生方式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">① 手动签发（二进制部署）</span><br><span class="line">   用户 → 手工生成证书 → API Server</span><br><span class="line"></span><br><span class="line">② 自动签发（kubeadm 部署）</span><br><span class="line">   kubelet → 首先用 token 认证 → Controller Manager </span><br><span class="line">   → 为 kubelet 自动生成证书 → 后续用证书认证</span><br></pre></td></tr></table></figure>

<h4 id="kubeconfig-文件（认证凭证）"><a href="#kubeconfig-文件（认证凭证）" class="headerlink" title="kubeconfig 文件（认证凭证）"></a>kubeconfig 文件（认证凭证）</h4><p>kubeconfig 是连接 K8s 集群的”通行证”，包含三部分信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">clusters:</span>           <span class="comment"># 集群信息</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">      <span class="attr">certificate-authority:</span> <span class="string">/path/to/ca.crt</span>  <span class="comment"># CA 证书</span></span><br><span class="line">      <span class="attr">server:</span> <span class="string">https://api-server:6443</span>          <span class="comment"># API Server 地址</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span>          <span class="comment"># 上下文（哪个用户→哪个集群→哪个命名空间）</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">      <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">kubectl-user</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">users:</span>             <span class="comment"># 用户认证信息</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubectl-user</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">client-certificate:</span> <span class="string">/path/to/user.crt</span>   <span class="comment"># 用户证书</span></span><br><span class="line">      <span class="attr">client-key:</span> <span class="string">/path/to/user.key</span>           <span class="comment"># 用户私钥</span></span><br></pre></td></tr></table></figure>

<p><strong>默认位置</strong>：<code>~/.kube/config</code></p>
<p><strong>多集群切换</strong>：通过指定不同 kubeconfig 访问不同集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=cluster1.conf get pods</span><br><span class="line">kubectl --kubeconfig=cluster2.conf get pods</span><br></pre></td></tr></table></figure>

<h4 id="Service-Account（SA）-Pod-的身份证"><a href="#Service-Account（SA）-Pod-的身份证" class="headerlink" title="Service Account（SA）- Pod 的身份证"></a>Service Account（SA）- Pod 的身份证</h4><p><strong>问题</strong>：Pod 频繁创建删除，为每个 Pod 手动签证书不现实</p>
<p><strong>解决</strong>：K8s 引入 Service Account 机制</p>
<p><strong>工作原理</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 每个 namespace 都有一个默认 SA（default）</span><br><span class="line">2. 创建 Pod 时，如果不指定 SA，自动使用所属 namespace 的 default SA</span><br><span class="line">3. 系统自动创建一个 secret 保存 SA 的认证信息</span><br><span class="line">4. 该 secret 自动挂载到 Pod 的 /var/run/secrets/kubernetes.io/serviceaccount/</span><br></pre></td></tr></table></figure>

<p><strong>SA 包含三部分</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/var/run/secrets/kubernetes.io/serviceaccount/</span><br><span class="line">├─ token      # SA 的 JWT token（由 API Server 私钥签名）</span><br><span class="line">├─ ca.crt     # CA 根证书（Pod 用来验证 API Server）</span><br><span class="line">└─ namespace  # SA 所在的 namespace</span><br></pre></td></tr></table></figure>

<p><strong>查看示例</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 default SA</span></span><br><span class="line">kubectl get sa</span><br><span class="line"><span class="comment"># NAME      SECRETS   AGE</span></span><br><span class="line"><span class="comment"># default   1         22d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 SA 生成的 secret</span></span><br><span class="line">kubectl get secret</span><br><span class="line"><span class="comment"># default-token-xxxxx   kubernetes.io/service-account-token</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pod 内使用 SA 访问 API Server</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- sh</span><br><span class="line">curl --header <span class="string">&quot;Authorization: Bearer <span class="subst">$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>&quot;</span> \</span><br><span class="line">  --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \</span><br><span class="line">  https://kubernetes.default.svc.cluster.local/api/v1/namespaces/default/pods</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="第2道：鉴权（Authorization）-你能做什么？"><a href="#第2道：鉴权（Authorization）-你能做什么？" class="headerlink" title="第2道：鉴权（Authorization）- 你能做什么？"></a>第2道：鉴权（Authorization）- 你能做什么？</h3><p><strong>作用</strong>：确认访问者的权限，就像门禁卡的权限等级</p>
<h4 id="授权策略对比"><a href="#授权策略对比" class="headerlink" title="授权策略对比"></a>授权策略对比</h4><table>
<thead>
<tr>
<th>策略</th>
<th>原理</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>AlwaysDeny</strong></td>
<td>拒绝全部</td>
<td>最安全</td>
<td>不实用</td>
<td>测试专用</td>
</tr>
<tr>
<td><strong>AlwaysAllow</strong></td>
<td>允许全部</td>
<td>无限制</td>
<td>毫无安全性</td>
<td>测试专用</td>
</tr>
<tr>
<td><strong>ABAC</strong></td>
<td>配置属性规则授权</td>
<td>灵活</td>
<td>配置复杂，修改需重启 API Server</td>
<td>小型集群</td>
</tr>
<tr>
<td><strong>Webhook</strong></td>
<td>调用外部 REST 服务</td>
<td>可做统一鉴权</td>
<td>网络依赖，额外维护</td>
<td>多集群场景</td>
</tr>
<tr>
<td><strong>RBAC</strong> ⭐</td>
<td>基于角色的访问控制</td>
<td>动态、细粒度、标准化</td>
<td>学习曲线</td>
<td>生产推荐</td>
</tr>
</tbody></table>
<p><strong>推荐方案</strong>：<strong>RBAC</strong>（1.6+ 默认启用）</p>
<h4 id="RBAC-核心概念"><a href="#RBAC-核心概念" class="headerlink" title="RBAC 核心概念"></a>RBAC 核心概念</h4><p>RBAC 只有一个核心思想：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">【用户】拥有【角色】  →  【角色】拥有【权限】</span><br><span class="line">                    ↓</span><br><span class="line">              用户可以执行权限对应的操作</span><br></pre></td></tr></table></figure>

<p><strong>4 个 API 对象</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Role / ClusterRole        ← 定义权限（白名单）</span><br><span class="line">         ↑</span><br><span class="line">         │ 通过 Binding 建立关联</span><br><span class="line">         ↓</span><br><span class="line">RoleBinding / ClusterRoleBinding  ← 绑定到主体（User/Group/SA）</span><br></pre></td></tr></table></figure>

<h4 id="角色定义（Role-vs-ClusterRole）"><a href="#角色定义（Role-vs-ClusterRole）" class="headerlink" title="角色定义（Role vs ClusterRole）"></a>角色定义（Role vs ClusterRole）</h4><p><strong>Role</strong>：作用于某个命名空间</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>              <span class="comment"># 必须指定 namespace</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span>                            <span class="comment"># 权限列表（白名单）</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]                 <span class="comment"># API 组（&quot;&quot; = core API）</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]             <span class="comment"># 资源类型</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>] <span class="comment"># 允许的操作</span></span><br><span class="line">  <span class="comment"># 语义：允许在 default ns 中对 Pod 做 get/watch/list 操作</span></span><br></pre></td></tr></table></figure>

<p><strong>ClusterRole</strong>：作用于整个集群</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span>             <span class="comment"># 不指定 namespace</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line">  <span class="comment"># 语义：允许在全集群范围内对 secrets 做 get/watch/list 操作</span></span><br></pre></td></tr></table></figure>

<h4 id="权限绑定（Binding）"><a href="#权限绑定（Binding）" class="headerlink" title="权限绑定（Binding）"></a>权限绑定（Binding）</h4><p><strong>RoleBinding</strong>：在命名空间内绑定 Role&#x2F;ClusterRole 到主体</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pods</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span>                         <span class="comment"># 主体：User/Group/SA</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zhangsan</span>                  <span class="comment"># 用户名（来自证书 CN 字段）</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span>                          <span class="comment"># 关联的角色</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 语义：将 default ns 的 pod-reader 角色授予用户 zhangsan</span></span><br><span class="line"><span class="comment"># 结果：zhangsan 在 default ns 中可以 get/watch/list pod</span></span><br></pre></td></tr></table></figure>

<p><strong>关键细节</strong>：</p>
<ul>
<li>RoleBinding 可以引用 <strong>ClusterRole</strong>，但仍限制在该 namespace 内</li>
<li>例如：将全集群可用的 ClusterRole 通过 RoleBinding 在某个 ns 内使用，权限自动缩小到该 ns</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例子：在 kube-public ns 内绑定全集群的 ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-public</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lisi</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span>           <span class="comment"># 引用 ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 结果：lisi 只能在 kube-public ns 内读取 secrets</span></span><br><span class="line"><span class="comment">#      虽然 secret-reader 可以全集群读取，但被 RoleBinding ns 限制了</span></span><br></pre></td></tr></table></figure>

<p><strong>ClusterRoleBinding</strong>：绑定到全集群</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets-global</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">manager</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 语义：manager 组内的所有用户在全集群范围可读取 secrets</span></span><br></pre></td></tr></table></figure>

<h4 id="常见权限速查"><a href="#常见权限速查" class="headerlink" title="常见权限速查"></a>常见权限速查</h4><p><strong>verbs（操作）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">get           # 获取单个资源</span><br><span class="line">list          # 列出资源</span><br><span class="line">watch         # 监听资源变化</span><br><span class="line">create        # 创建资源</span><br><span class="line">update        # 更新资源</span><br><span class="line">patch         # 部分更新</span><br><span class="line">delete        # 删除资源</span><br><span class="line">exec          # 进入容器执行命令</span><br></pre></td></tr></table></figure>

<p><strong>resources（资源）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pods、services、deployments、daemonsets</span><br><span class="line">statefulsets、jobs、cronjobs、configmaps</span><br><span class="line">secrets、pvc、pv、nodes、namespaces</span><br><span class="line">rolebindings、clusterroles、etc.</span><br></pre></td></tr></table></figure>

<p><strong>apiGroups（API 组）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;              # core API 组（Pod/Service/Secret 等）</span><br><span class="line">apps            # Deployment/StatefulSet/DaemonSet 等</span><br><span class="line">autoscaling     # HPA 等</span><br><span class="line">batch           # Job/CronJob 等</span><br><span class="line">networking.k8s.io  # NetworkPolicy 等</span><br></pre></td></tr></table></figure>

<p><strong>子资源</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pod 的日志是 Pod 的子资源</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods/log&quot;</span>]      <span class="comment"># 资源/子资源</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="第3道：准入控制（Admission-Control）"><a href="#第3道：准入控制（Admission-Control）" class="headerlink" title="第3道：准入控制（Admission Control）"></a>第3道：准入控制（Admission Control）</h3><p><strong>作用</strong>：额外的策略检查，就像安检的额外规则</p>
<p><strong>工作原理</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">请求通过认证和鉴权后 → 依次通过准入控制插件链</span><br><span class="line">                   → 任何插件拒绝即请求被拒绝</span><br></pre></td></tr></table></figure>

<h4 id="常见插件"><a href="#常见插件" class="headerlink" title="常见插件"></a>常见插件</h4><table>
<thead>
<tr>
<th>插件</th>
<th>作用</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td><strong>NamespaceLifecycle</strong></td>
<td>命名空间生命周期管理</td>
<td>阻止在不存在的 ns 创建对象；防止删除系统 ns</td>
</tr>
<tr>
<td><strong>LimitRanger</strong>——对比resources</td>
<td>限制资源请求</td>
<td>Pod CPU&#x2F;内存&#x2F;数量不能超过 ns 限制</td>
</tr>
<tr>
<td><strong>ServiceAccount</strong></td>
<td>SA 自动注入</td>
<td>Pod 自动挂载 SA token</td>
</tr>
<tr>
<td><strong>ResourceQuota</strong></td>
<td>命名空间配额</td>
<td>Pod 数量、资源总量不能超过 quota</td>
</tr>
<tr>
<td><strong>NodeRestriction</strong></td>
<td>限制 Node 权限</td>
<td>Node 只能修改自己的信息</td>
</tr>
<tr>
<td><strong>MutatingAdmissionWebhook</strong></td>
<td>可变准入</td>
<td>自动修改请求（如注入 sidecar）</td>
</tr>
<tr>
<td><strong>ValidatingAdmissionWebhook</strong></td>
<td>验证准入</td>
<td>验证请求格式（如镜像仓库白名单）</td>
</tr>
</tbody></table>
<p><strong>官方推荐默认插件链</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,</span><br><span class="line">DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,</span><br><span class="line">ResourceQuota,NodeRestriction</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、实践：创建受限用户"><a href="#三、实践：创建受限用户" class="headerlink" title="三、实践：创建受限用户"></a>三、实践：创建受限用户</h2><p><strong>目标</strong>：创建用户 <code>zhangsan</code>，仅能在 <code>yjs0805</code> namespace 内对 Pod 做 get&#x2F;watch&#x2F;list&#x2F;create 操作</p>
<h3 id="步骤-1：创建系统用户"><a href="#步骤-1：创建系统用户" class="headerlink" title="步骤 1：创建系统用户"></a>步骤 1：创建系统用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">useradd zhangsan</span><br><span class="line">passwd zhangsan</span><br><span class="line"></span><br><span class="line"><span class="comment"># 尝试访问（会失败，因为没有证书）</span></span><br><span class="line">su - zhangsan</span><br><span class="line">kubectl get pods</span><br><span class="line"><span class="comment"># Error: The connection to the server localhost:8080 was refused</span></span><br></pre></td></tr></table></figure>

<h3 id="步骤-2：生成用户证书"><a href="#步骤-2：生成用户证书" class="headerlink" title="步骤 2：生成用户证书"></a>步骤 2：生成用户证书</h3><p><strong>准备证书工具</strong>（cfssl）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载到 /usr/local/bin</span></span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/cfssl*</span><br></pre></td></tr></table></figure>

<p><strong>证书申请文件</strong>（CN 作为用户名，O 作为组名）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># zhangsan-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhangsan&quot;</span><span class="punctuation">,</span>           # 用户名</span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BeiJing&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BeiJing&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k8s&quot;</span><span class="punctuation">,</span>              # 组名</span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>生成证书</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.crt -ca-key=ca.key \</span><br><span class="line">  -profile=kubernetes \</span><br><span class="line">  /path/to/zhangsan-csr.json | cfssljson -bare zhangsan</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成文件：zhangsan.pem、zhangsan-key.pem、zhangsan.csr</span></span><br></pre></td></tr></table></figure>

<h3 id="步骤-3：生成-kubeconfig"><a href="#步骤-3：生成-kubeconfig" class="headerlink" title="步骤 3：生成 kubeconfig"></a>步骤 3：生成 kubeconfig</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">APISERVER=<span class="variable">$1</span>  <span class="comment"># 传入 API Server IP</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">&quot;https://<span class="variable">$APISERVER</span>:6443&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=zhangsan.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端认证参数（证书）</span></span><br><span class="line">kubectl config set-credentials zhangsan \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/zhangsan-key.pem \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/zhangsan.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=zhangsan.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置上下文（用户→集群→namespace）</span></span><br><span class="line">kubectl config set-context kubernetes \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=zhangsan \</span><br><span class="line">  --namespace=yjs0805 \</span><br><span class="line">  --kubeconfig=zhangsan.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 激活上下文</span></span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=zhangsan.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发给用户</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /home/zhangsan/.kube</span><br><span class="line"><span class="built_in">cp</span> zhangsan.kubeconfig /home/zhangsan/.kube/config</span><br><span class="line"><span class="built_in">chown</span> -R zhangsan:zhangsan /home/zhangsan/.kube/</span><br></pre></td></tr></table></figure>

<h3 id="步骤-4：创建-RBAC-授权"><a href="#步骤-4：创建-RBAC-授权" class="headerlink" title="步骤 4：创建 RBAC 授权"></a>步骤 4：创建 RBAC 授权</h3><p><strong>创建命名空间</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace yjs0805</span><br></pre></td></tr></table></figure>

<p><strong>创建 Role 和 RoleBinding</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rbac.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yjs0805</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;create&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pods</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yjs0805</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zhangsan</span>          <span class="comment"># 证书 CN 字段</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<p><strong>应用</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f rbac.yaml</span><br><span class="line">kubectl get role,rolebinding -n yjs0805</span><br></pre></td></tr></table></figure>

<h3 id="步骤-5：验证权限"><a href="#步骤-5：验证权限" class="headerlink" title="步骤 5：验证权限"></a>步骤 5：验证权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换用户</span></span><br><span class="line">su - zhangsan</span><br><span class="line"></span><br><span class="line"><span class="comment"># ✅ 允许：列出 yjs0805 的 Pod</span></span><br><span class="line">kubectl get pods</span><br><span class="line"><span class="comment"># NAME         READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment"># pod-test-1   1/1     Running   0          2m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ✅ 允许：创建 Pod</span></span><br><span class="line"><span class="built_in">cat</span> &gt; pod-test.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: my-pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: nginx</span></span><br><span class="line"><span class="string">    image: nginx</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl create -f pod-test.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ❌ 拒绝：访问其他资源（Service）</span></span><br><span class="line">kubectl get svc</span><br><span class="line"><span class="comment"># Error from server (Forbidden): services is forbidden: </span></span><br><span class="line"><span class="comment"># User &quot;zhangsan&quot; cannot list resource &quot;services&quot; in API group &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ❌ 拒绝：访问其他命名空间（default）</span></span><br><span class="line">kubectl get pods -n default</span><br><span class="line"><span class="comment"># Error from server (Forbidden): pods is forbidden:</span></span><br><span class="line"><span class="comment"># User &quot;zhangsan&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、安全性最佳实践"><a href="#四、安全性最佳实践" class="headerlink" title="四、安全性最佳实践"></a>四、安全性最佳实践</h2><h3 id="1-认证层"><a href="#1-认证层" class="headerlink" title="1. 认证层"></a>1. 认证层</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">✅ 使用 HTTPS 证书认证（不用 Token/Basic）</span><br><span class="line">✅ 定期更新证书（特别是 CA 证书）</span><br><span class="line">✅ 为不同组件使用不同的证书</span><br><span class="line">✅ 保护私钥文件（权限 600）</span><br></pre></td></tr></table></figure>

<h3 id="2-授权层"><a href="#2-授权层" class="headerlink" title="2. 授权层"></a>2. 授权层</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">✅ 采用最小权限原则（最初给最少权限，按需增加）</span><br><span class="line">✅ 使用 RBAC（不用 ABAC 或 AlwaysAllow）</span><br><span class="line">✅ 定期审计权限分配</span><br><span class="line">✅ 为不同团队创建不同角色，分离职责</span><br><span class="line">✅ 避免直接修改 system: 前缀的角色</span><br></pre></td></tr></table></figure>

<h3 id="3-准入控制层"><a href="#3-准入控制层" class="headerlink" title="3. 准入控制层"></a>3. 准入控制层</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">✅ 启用 ResourceQuota 防止资源耗尽</span><br><span class="line">✅ 启用 LimitRanger 限制单 Pod 资源</span><br><span class="line">✅ 启用 NodeRestriction 限制 Node 权限</span><br><span class="line">✅ 启用 PodSecurityPolicy/PodSecurityStandard 限制 Pod 能力</span><br></pre></td></tr></table></figure>

<h3 id="4-API-Server-安全"><a href="#4-API-Server-安全" class="headerlink" title="4. API Server 安全"></a>4. API Server 安全</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">✅ 只暴露 6443 HTTPS 端口，关闭 8080</span><br><span class="line">✅ 启用审计日志（--audit-log-path）</span><br><span class="line">✅ 限制 API 访问（IP 白名单、防火墙）</span><br><span class="line">✅ 定期更新 K8s 版本</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、常见面试题"><a href="#五、常见面试题" class="headerlink" title="五、常见面试题"></a>五、常见面试题</h2><p><strong>Q1：K8s 有几道安全防线？</strong> A：三道。认证（谁）→ 鉴权（权限）→ 准入控制（策略）</p>
<p><strong>Q2：Pod 如何访问 API Server？</strong> A：通过 Service Account。Pod 自动挂载 SA token、CA 证书，通过 token 认证和后续的 RBAC 鉴权。</p>
<p><strong>Q3：Role 和 ClusterRole 的区别？</strong> A：Role 作用于某个命名空间，ClusterRole 作用于全集群。RoleBinding 可以绑定 ClusterRole，但仍限于该 namespace。</p>
<p><strong>Q4：权限是加法还是减法？</strong> A：权限是白名单加法模式。即使拥有高权限角色，也不会自动获得下级权限；权限只能累加。</p>
<p><strong>Q5：kubeconfig 里有什么？</strong> A：三部分。集群信息（CA+API Server 地址）、用户认证信息（证书）、上下文（用户→集群→namespace）。</p>
<p><strong>Q6：什么情况下使用 Service Account？</strong> A：Pod 内的应用需要访问 API Server 时。例如 dashboard、coredns、监控 agent 等。</p>
<p><strong>Q7：RoleBinding 中 CN 和 O 字段分别指什么？</strong> A：CN（Common Name）是用户名，O（Organization）是用户组名。API Server 从客户端证书解析这两个字段确认身份。</p>
<hr>
<h2 id="总结速记"><a href="#总结速记" class="headerlink" title="总结速记"></a>总结速记</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">【认证】两个方式：</span><br><span class="line">  ├─ 证书（生产推荐）</span><br><span class="line">  └─ Token/Basic（开发测试）</span><br><span class="line"></span><br><span class="line">【RBAC 四个对象】：</span><br><span class="line">  Role ──┐</span><br><span class="line">         ├─ Binding ──→ User/Group/SA</span><br><span class="line">  ClusterRole ┘</span><br><span class="line"></span><br><span class="line">【最小权限原则】：</span><br><span class="line">  白名单模式 → 权限只能加不能减</span><br><span class="line"></span><br><span class="line">【SA 三件套】：</span><br><span class="line">  token + ca.crt + namespace</span><br></pre></td></tr></table></figure>

<h1 id="K8S-CNI、RBAC、HPA-常见面试题"><a href="#K8S-CNI、RBAC、HPA-常见面试题" class="headerlink" title="K8S CNI、RBAC、HPA 常见面试题"></a>K8S CNI、RBAC、HPA 常见面试题</h1><hr>
<h2 id="一、CNI-插件（Container-Network-Interface）"><a href="#一、CNI-插件（Container-Network-Interface）" class="headerlink" title="一、CNI 插件（Container Network Interface）"></a>一、CNI 插件（Container Network Interface）</h2><h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><p><strong>CNI 是什么？</strong></p>
<ul>
<li>CNI &#x3D; 容器网络接口标准</li>
<li>K8s 的网络实现不是内置的，而是通过 CNI 插件来完成</li>
<li>作用：<strong>为 Pod 分配 IP、配置网络、实现 Pod 间网络通讯</strong></li>
</ul>
<h3 id="面试题精选"><a href="#面试题精选" class="headerlink" title="面试题精选"></a>面试题精选</h3><h4 id="Q1：K8s-中网络通讯分几层？分别用什么实现？"><a href="#Q1：K8s-中网络通讯分几层？分别用什么实现？" class="headerlink" title="Q1：K8s 中网络通讯分几层？分别用什么实现？"></a>Q1：K8s 中网络通讯分几层？分别用什么实现？</h4><p><strong>A</strong>：三层（从外到内）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│ L7 层：Ingress（域名路由）          │ ← Ingress Controller</span><br><span class="line">├─────────────────────────────────────┤</span><br><span class="line">│ L4 层：Service（服务发现）          │ ← kube-proxy</span><br><span class="line">├─────────────────────────────────────┤</span><br><span class="line">│ L3 层：Pod 间网络通讯                │ ← CNI 插件（flannel/calico 等）</span><br><span class="line">├─────────────────────────────────────┤</span><br><span class="line">│ L2 层：容器间通讯                   │ ← pause 容器（localhost）</span><br><span class="line">└─────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>各层职责</strong>：</p>
<ul>
<li><strong>Ingress</strong>：基于域名&#x2F;路径做反向代理，暴露到集群外</li>
<li><strong>Service</strong>：服务发现，通过 endpoints 找到后端 Pod</li>
<li><strong>CNI 插件</strong>：为 Pod 分配 IP，实现 Pod 到 Pod 的网络通讯</li>
<li><strong>Pause 容器</strong>：同 Pod 内的容器共享网络命名空间，通过 localhost 通讯</li>
</ul>
<hr>
<h4 id="Q2：为什么需要-CNI-插件？K8s-为什么不自己实现？"><a href="#Q2：为什么需要-CNI-插件？K8s-为什么不自己实现？" class="headerlink" title="Q2：为什么需要 CNI 插件？K8s 为什么不自己实现？"></a>Q2：为什么需要 CNI 插件？K8s 为什么不自己实现？</h4><p><strong>A</strong>：<strong>CNI 是标准，K8s 需要支持不同的网络实现</strong></p>
<p><strong>原因</strong>：</p>
<ol>
<li><strong>网络是多样化的</strong><ul>
<li>云环境（AWS&#x2F;阿里云）有自己的网络模型</li>
<li>私有数据中心网络结构不同</li>
<li>不同企业有不同的网络策略</li>
</ul>
</li>
<li><strong>K8s 设计哲学</strong>：核心功能 + 可插拔扩展<ul>
<li>CRI（容器运行时）可以是 Docker&#x2F;Containerd</li>
<li>CNI（网络）可以是 flannel&#x2F;calico&#x2F;weave</li>
<li>CSI（存储）可以是各厂商存储驱动</li>
</ul>
</li>
</ol>
<p><strong>类比</strong>：就像手机系统，不能内置所有驱动，而是提供标准接口让厂商实现</p>
<hr>
<h4 id="Q3：常见的-CNI-插件有哪些？区别是什么？"><a href="#Q3：常见的-CNI-插件有哪些？区别是什么？" class="headerlink" title="Q3：常见的 CNI 插件有哪些？区别是什么？"></a>Q3：常见的 CNI 插件有哪些？区别是什么？</h4><p><strong>A</strong>：常见的有 5 种</p>
<table>
<thead>
<tr>
<th>插件</th>
<th>网络模型</th>
<th>性能</th>
<th>网络策略</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>flannel</strong></td>
<td>Overlay（vxlan）</td>
<td>中等</td>
<td>❌ 不支持</td>
<td>小集群、开发测试</td>
</tr>
<tr>
<td><strong>calico</strong></td>
<td>纯三层（BGP）</td>
<td>高</td>
<td>✅ 支持</td>
<td>大集群、生产推荐</td>
</tr>
<tr>
<td><strong>weave</strong></td>
<td>Overlay</td>
<td>中等</td>
<td>✅ 支持</td>
<td>混合环境</td>
</tr>
<tr>
<td><strong>cilium</strong></td>
<td>eBPF</td>
<td>最高</td>
<td>✅ 支持</td>
<td>高性能场景</td>
</tr>
<tr>
<td><strong>AWS&#x2F;阿里云</strong></td>
<td>云厂商网络</td>
<td>高</td>
<td>依赖厂商</td>
<td>公有云专用</td>
</tr>
</tbody></table>
<p><strong>核心区别</strong>：</p>
<p><strong>Flannel</strong>（被吐槽的选择）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">特点：虚拟网络（overlay），Pod IP 不是真实 IP</span><br><span class="line">原理：Pod→Flannel→vxlan 隧道→其他 Node→Pod</span><br><span class="line">缺点：多一层封装，性能有损耗；不支持网络策略</span><br><span class="line">优点：部署简单，开发测试够用</span><br></pre></td></tr></table></figure>

<p><strong>Calico</strong>（生产推荐）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">特点：纯三层网络，用 BGP 协议</span><br><span class="line">原理：Pod IP 是真实 IP，直接路由</span><br><span class="line">优点：高性能，支持网络策略（NetworkPolicy）</span><br><span class="line">缺点：部署相对复杂，对网络环保要求较高（需要支持 BGP）</span><br></pre></td></tr></table></figure>

<p><strong>关键差异</strong>：</p>
<ul>
<li>Flannel 是 overlay（虚拟网络），Calico 是纯三层（真实路由）</li>
<li>Calico 支持 NetworkPolicy，flannel 不支持</li>
<li>Calico 性能比 flannel 好</li>
</ul>
<hr>
<h4 id="Q4：CNI-插件是如何为-Pod-分配-IP-的？"><a href="#Q4：CNI-插件是如何为-Pod-分配-IP-的？" class="headerlink" title="Q4：CNI 插件是如何为 Pod 分配 IP 的？"></a>Q4：CNI 插件是如何为 Pod 分配 IP 的？</h4><p><strong>A</strong>：通过 IPAM（IP Address Management）模块</p>
<p><strong>流程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. kubectl create pod</span><br><span class="line">2. API Server 批准请求</span><br><span class="line">3. kubelet 在 node 上创建 Pod</span><br><span class="line">4. kubelet 调用 CNI 插件</span><br><span class="line">5. CNI 插件的 IPAM 分配 IP</span><br><span class="line">6. CNI 插件配置网络（创建网卡、配置路由等）</span><br><span class="line">7. Pod 启动，拥有了 IP 地址</span><br></pre></td></tr></table></figure>

<p><strong>IP 分配原理</strong>：</p>
<ul>
<li>每个 Node 被分配一个 Pod CIDR（如 10.244.1.0&#x2F;24）</li>
<li>CNI 插件从该 CIDR 内分配 IP 给 Pod</li>
<li>所有 Node 的 CIDR 加起来组成集群网络（如 10.244.0.0&#x2F;16）</li>
</ul>
<p><strong>查看示例</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看每个 node 的 Pod CIDR</span></span><br><span class="line">kubectl get nodes -o wide</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">kubectl describe node node1 | grep PodCIDR</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 pod 的 IP</span></span><br><span class="line">kubectl get pods -o wide</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q5：Pod-在不同-Node-上，怎么通讯？CNI-怎么实现的？"><a href="#Q5：Pod-在不同-Node-上，怎么通讯？CNI-怎么实现的？" class="headerlink" title="Q5：Pod 在不同 Node 上，怎么通讯？CNI 怎么实现的？"></a>Q5：Pod 在不同 Node 上，怎么通讯？CNI 怎么实现的？</h4><p><strong>A</strong>：取决于 CNI 插件的实现</p>
<p><strong>Flannel 的方式（overlay）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Pod A (Node1) ──虚拟网卡──&gt; Flannel 守护进程 ──vxlan 隧道──&gt;</span><br><span class="line">  Flannel 守护进程 (Node2) ──虚拟网卡──&gt; Pod B (Node2)</span><br><span class="line"></span><br><span class="line">原理：</span><br><span class="line">1. Pod A 发送包到虚拟网卡 eth0</span><br><span class="line">2. Flannel 进程拦截，封装为 vxlan 包</span><br><span class="line">3. vxlan 包通过真实网络发送到 Node2</span><br><span class="line">4. Node2 的 Flannel 进程解包</span><br><span class="line">5. 解包后的网包转发给 Pod B</span><br><span class="line"></span><br><span class="line">特点：有隧道封装，性能有损耗</span><br></pre></td></tr></table></figure>

<p><strong>Calico 的方式（三层路由）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pod A (10.244.1.10) ──路由表──&gt; Node2 (192.168.1.100)</span><br><span class="line">  ──BGP 通告──&gt; Pod B (10.244.2.10)</span><br><span class="line"></span><br><span class="line">原理：</span><br><span class="line">1. Node1 上的路由表：目标 10.244.2.0/24 → next hop 192.168.1.100</span><br><span class="line">2. Pod A 的包直接根据路由表转发到 Node2</span><br><span class="line">3. Node2 根据自己的路由表转发给 Pod B</span><br><span class="line"></span><br><span class="line">特点：没有隧道，直接三层路由，性能好</span><br></pre></td></tr></table></figure>

<p><strong>简单对比</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flannel：隧道 → 多一层处理 → 性能相对低</span><br><span class="line">Calico：路由 → 直接转发 → 性能好</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q6：什么是-NetworkPolicy？哪个-CNI-支持？"><a href="#Q6：什么是-NetworkPolicy？哪个-CNI-支持？" class="headerlink" title="Q6：什么是 NetworkPolicy？哪个 CNI 支持？"></a>Q6：什么是 NetworkPolicy？哪个 CNI 支持？</h4><p><strong>A</strong>：<strong>网络策略，定义 Pod 间通讯的规则</strong></p>
<p><strong>作用</strong>：</p>
<ul>
<li>默认情况下，Pod 间可以互相通讯</li>
<li>NetworkPolicy 可以限制 Pod 间的通讯（类似防火墙）</li>
</ul>
<p><strong>示例</strong>：只允许特定 Pod 访问某个 Pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deny-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 语义：</span></span><br><span class="line"><span class="comment"># - 目标：标签为 app=web 的 Pod</span></span><br><span class="line"><span class="comment"># - 入站规则：只允许 app=frontend 的 Pod 访问 80 端口</span></span><br><span class="line"><span class="comment"># - 其他 Pod 无法访问</span></span><br></pre></td></tr></table></figure>

<p><strong>支持情况</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">✅ Calico（完全支持，生产推荐）</span><br><span class="line">✅ Cilium（完全支持）</span><br><span class="line">✅ Weave（支持）</span><br><span class="line">❌ Flannel（不支持）</span><br><span class="line">❌ AWS/阿里云（不同实现）</span><br></pre></td></tr></table></figure>

<p><strong>选型建议</strong>：如果需要 NetworkPolicy，选择 Calico 或 Cilium，别用 flannel</p>
<hr>
<h4 id="Q7：CNI-插件故障会怎样？怎么排查？"><a href="#Q7：CNI-插件故障会怎样？怎么排查？" class="headerlink" title="Q7：CNI 插件故障会怎样？怎么排查？"></a>Q7：CNI 插件故障会怎样？怎么排查？</h4><p><strong>A</strong>：Pod 网络故障</p>
<p><strong>现象</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">✗ Pod 无法分配 IP → Pod 状态 Pending</span><br><span class="line">✗ Pod 无法与其他 Pod 通讯</span><br><span class="line">✗ Pod 无法访问外网</span><br></pre></td></tr></table></figure>

<p><strong>排查方法</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 检查 CNI 插件是否运行</span></span><br><span class="line">kubectl get pods -n kube-system | grep -E <span class="string">&#x27;flannel|calico&#x27;</span></span><br><span class="line"><span class="comment"># 应该看到 Running 状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查 CNI 配置文件</span></span><br><span class="line"><span class="built_in">ls</span> /etc/cni/net.d/</span><br><span class="line"><span class="comment"># 应该看到 CNI 配置文件（如 10-flannel.conflist）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查 CNI 二进制文件</span></span><br><span class="line"><span class="built_in">ls</span> /opt/cni/bin/</span><br><span class="line"><span class="comment"># 应该看到各种 CNI 插件二进制</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 查看 kubelet 日志</span></span><br><span class="line">journalctl -u kubelet -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 描述 Pod 了解错误详情</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q8：能自己写-CNI-插件吗？"><a href="#Q8：能自己写-CNI-插件吗？" class="headerlink" title="Q8：能自己写 CNI 插件吗？"></a>Q8：能自己写 CNI 插件吗？</h4><p><strong>A</strong>：能，但通常不需要</p>
<p><strong>CNI 标准流程</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CNI 插件本质是一个可执行程序，需要实现：</span></span><br><span class="line"><span class="comment"># 1. add：为容器添加网络</span></span><br><span class="line"><span class="comment"># 2. del：删除容器的网络</span></span><br><span class="line"><span class="comment"># 3. check：检查网络是否配置正确</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入：通过环境变量和 stdin 传递</span></span><br><span class="line"><span class="comment"># 输出：返回 IP、路由等信息给 kubelet</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 例子：简单的 CNI 插件伪代码</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># /opt/cni/bin/my-plugin</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$CNI_COMMAND</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">  add)</span><br><span class="line">    <span class="comment"># 1. 从 IPAM 获取 IP</span></span><br><span class="line">    <span class="comment"># 2. 创建虚拟网卡</span></span><br><span class="line">    <span class="comment"># 3. 设置路由</span></span><br><span class="line">    <span class="comment"># 4. 返回 JSON 结果</span></span><br><span class="line">    ;;</span><br><span class="line">  del)</span><br><span class="line">    <span class="comment"># 清理网络配置</span></span><br><span class="line">    ;;</span><br><span class="line">  check)</span><br><span class="line">    <span class="comment"># 验证网络正常</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<p><strong>何时自己写</strong>：</p>
<ul>
<li>需要特殊的网络功能（极少）</li>
<li>特定的企业网络模型（极少）</li>
</ul>
<p><strong>通常做法</strong>：直接用开源的（flannel&#x2F;calico）</p>
<hr>
<h4 id="Q9：Pod-CIDR-和-Service-CIDR-是一样的吗？"><a href="#Q9：Pod-CIDR-和-Service-CIDR-是一样的吗？" class="headerlink" title="Q9：Pod CIDR 和 Service CIDR 是一样的吗？"></a>Q9：Pod CIDR 和 Service CIDR 是一样的吗？</h4><p><strong>A</strong>：<strong>完全不同</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pod CIDR（Pod 网络）：</span><br><span class="line">  - 范围：10.244.0.0/16（例子）</span><br><span class="line">  - 作用：为 Pod 分配真实 IP</span><br><span class="line">  - 特点：Pod IP 在容器内可见，跨 Node 可路由</span><br><span class="line"></span><br><span class="line">Service CIDR（Service 网络）：</span><br><span class="line">  - 范围：10.96.0.0/12（例子）</span><br><span class="line">  - 作用：为 Service 分配 ClusterIP</span><br><span class="line">  - 特点：虚拟 IP，仅集群内可见，不可路由</span><br></pre></td></tr></table></figure>

<p><strong>关键差异</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Pod IP：真实 IP，Pod 可以直接用</span><br><span class="line">  Pod A(10.244.1.5) → Pod B(10.244.2.6)：直接通讯</span><br><span class="line"></span><br><span class="line">Service IP：虚拟 IP，需要 kube-proxy 转发</span><br><span class="line">  Client → Service(10.96.0.1) → kube-proxy 转发 → Pod</span><br></pre></td></tr></table></figure>

<p><strong>配置位置</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Pod CIDR</span></span><br><span class="line">kubectl get nodes -o jsonpath=<span class="string">&#x27;&#123;.items[*].spec.podCIDR&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Service CIDR（在 API Server 启动参数）</span></span><br><span class="line">ps aux | grep api-server | grep service-cluster-ip-range</span><br><span class="line"><span class="comment"># --service-cluster-ip-range=10.96.0.0/12</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q10：CNI-插件如何选择？选型标准是什么？"><a href="#Q10：CNI-插件如何选择？选型标准是什么？" class="headerlink" title="Q10：CNI 插件如何选择？选型标准是什么？"></a>Q10：CNI 插件如何选择？选型标准是什么？</h4><p><strong>A</strong>：根据场景选择</p>
<p><strong>选型决策树</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">开发测试</span><br><span class="line">  └─&gt; Flannel（简单，够用）</span><br><span class="line"></span><br><span class="line">生产小集群（&lt; 100 nodes）</span><br><span class="line">  └─&gt; Flannel（简单）或 Calico（功能完整）</span><br><span class="line"></span><br><span class="line">生产大集群（&gt; 100 nodes）</span><br><span class="line">  └─&gt; Calico（稳定，性能好）</span><br><span class="line"></span><br><span class="line">需要网络策略</span><br><span class="line">  └─&gt; Calico 或 Cilium</span><br><span class="line"></span><br><span class="line">高性能场景（金融、运营商）</span><br><span class="line">  └─&gt; Cilium（eBPF 最高性能）</span><br><span class="line"></span><br><span class="line">公有云</span><br><span class="line">  └─&gt; 用云厂商的网络插件（AWS/阿里云）</span><br></pre></td></tr></table></figure>

<p><strong>决策要点</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">✓ 性能需求：Cilium &gt; Calico &gt; Flannel</span><br><span class="line">✓ 功能完整性：Calico &gt; Flannel</span><br><span class="line">✓ 部署复杂度：Flannel 简单，Calico 中等，Cilium 复杂</span><br><span class="line">✓ 社区支持：Calico 最活跃</span><br><span class="line">✓ 云环境：优先用云厂商的</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、RBAC-认知（简化版）"><a href="#二、RBAC-认知（简化版）" class="headerlink" title="二、RBAC 认知（简化版）"></a>二、RBAC 认知（简化版）</h2><h3 id="快速概念"><a href="#快速概念" class="headerlink" title="快速概念"></a>快速概念</h3><p><strong>RBAC &#x3D; Role-Based Access Control（基于角色的访问控制）</strong></p>
<p><strong>核心公式</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">主体（User/Group/SA）  →  绑定  →  角色（Role/ClusterRole）  →  权限</span><br></pre></td></tr></table></figure>

<h3 id="面试题精选-1"><a href="#面试题精选-1" class="headerlink" title="面试题精选"></a>面试题精选</h3><h4 id="Q1：什么是-RBAC？为什么-K8s-用-RBAC？"><a href="#Q1：什么是-RBAC？为什么-K8s-用-RBAC？" class="headerlink" title="Q1：什么是 RBAC？为什么 K8s 用 RBAC？"></a>Q1：什么是 RBAC？为什么 K8s 用 RBAC？</h4><p><strong>A</strong>：<strong>K8s 的权限管理机制</strong></p>
<p><strong>为什么用 RBAC</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">❌ 不用 RBAC 的问题：</span><br><span class="line">   - 用户权限难以管理（给 A 增加权限需要重启 API Server）</span><br><span class="line">   - 权限细节散乱</span><br><span class="line">   - 修改权限困难</span><br><span class="line"></span><br><span class="line">✅ RBAC 的优势：</span><br><span class="line">   - 动态调整（实时生效，不需重启）</span><br><span class="line">   - 权限集中管理（Role 定义一次，可复用）</span><br><span class="line">   - 权限细粒度（可精确到资源、操作、namespace）</span><br><span class="line">   - 标准 API 对象（用 kubectl 操作）</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q2：RBAC-有哪-4-个对象？分别干什么？"><a href="#Q2：RBAC-有哪-4-个对象？分别干什么？" class="headerlink" title="Q2：RBAC 有哪 4 个对象？分别干什么？"></a>Q2：RBAC 有哪 4 个对象？分别干什么？</h4><p><strong>A</strong>：两种角色 + 两种绑定</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────┐</span><br><span class="line">│ Role（命名空间级）                    │  定义权限</span><br><span class="line">├──────────────────────────────────────┤</span><br><span class="line">│ ClusterRole（集群级）                 │</span><br><span class="line">└──────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌──────────────────────────────────────┐</span><br><span class="line">│ RoleBinding（命名空间级）             │  绑定主体</span><br><span class="line">├──────────────────────────────────────┤</span><br><span class="line">│ ClusterRoleBinding（集群级）          │</span><br><span class="line">└──────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>简单记忆</strong>：</p>
<ul>
<li><strong>Role</strong>：在某个 namespace 内定义权限</li>
<li><strong>ClusterRole</strong>：在整个集群定义权限</li>
<li><strong>RoleBinding</strong>：在某个 namespace 内把角色授予主体</li>
<li><strong>ClusterRoleBinding</strong>：在整个集群把角色授予主体</li>
</ul>
<hr>
<h4 id="Q3：Role-和-ClusterRole-的区别？"><a href="#Q3：Role-和-ClusterRole-的区别？" class="headerlink" title="Q3：Role 和 ClusterRole 的区别？"></a>Q3：Role 和 ClusterRole 的区别？</h4><p><strong>A</strong>：作用域不同</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>Role</th>
<th>ClusterRole</th>
</tr>
</thead>
<tbody><tr>
<td>作用域</td>
<td>某个 namespace</td>
<td>全集群</td>
</tr>
<tr>
<td>元数据</td>
<td>必须有 namespace 字段</td>
<td>不需要 namespace 字段</td>
</tr>
<tr>
<td>权限</td>
<td>只能控制该 namespace 的资源</td>
<td>可以控制全集群的资源</td>
</tr>
<tr>
<td>跨 ns</td>
<td>不能跨越 namespace</td>
<td>可以跨越 namespace</td>
</tr>
</tbody></table>
<p><strong>示例对比</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Role：default namespace 内可读 pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>      <span class="comment"># ← 必须指定</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># ClusterRole：全集群可读 secret</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="comment"># ← 不指定 namespace</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q4：RoleBinding-可以引用-ClusterRole-吗？会怎样？"><a href="#Q4：RoleBinding-可以引用-ClusterRole-吗？会怎样？" class="headerlink" title="Q4：RoleBinding 可以引用 ClusterRole 吗？会怎样？"></a>Q4：RoleBinding 可以引用 ClusterRole 吗？会怎样？</h4><p><strong>A</strong>：<strong>可以，但权限会被限制到该 namespace</strong></p>
<p><strong>示例</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全集群可读 secret 的 ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader-global</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># 但在某个 namespace 内用 RoleBinding 引用它</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-public</span>        <span class="comment"># ← 限制到这个 namespace</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lisi</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span>            <span class="comment"># ← 引用 ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader-global</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：lisi 虽然有全集群读 secret 的权限，</span></span><br><span class="line"><span class="comment">#      但被 RoleBinding 限制，只能在 kube-public namespace 读 secret</span></span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">权限来源：ClusterRole（全集群）</span><br><span class="line">权限范围：RoleBinding 的 namespace（缩小）</span><br><span class="line"></span><br><span class="line">类比：你有全国通行证（ClusterRole），</span><br><span class="line">     但公司只让你在北京分公司用（RoleBinding）</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q5：RoleBinding-和-ClusterRoleBinding-怎么选择？"><a href="#Q5：RoleBinding-和-ClusterRoleBinding-怎么选择？" class="headerlink" title="Q5：RoleBinding 和 ClusterRoleBinding 怎么选择？"></a>Q5：RoleBinding 和 ClusterRoleBinding 怎么选择？</h4><p><strong>A</strong>：看权限范围</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">如果用户需要在某个 namespace 工作</span><br><span class="line">  → 用 RoleBinding（即使绑定 ClusterRole 也被限制）</span><br><span class="line"></span><br><span class="line">如果用户需要全集群权限</span><br><span class="line">  → 用 ClusterRoleBinding</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">  - 开发者只管理 dev namespace → RoleBinding</span><br><span class="line">  - 运维管理整个集群 → ClusterRoleBinding</span><br><span class="line">  - 某人是 admin → ClusterRoleBinding 绑定 cluster-admin</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q6：RBAC-中的-User、Group、ServiceAccount-有什么区别？"><a href="#Q6：RBAC-中的-User、Group、ServiceAccount-有什么区别？" class="headerlink" title="Q6：RBAC 中的 User、Group、ServiceAccount 有什么区别？"></a>Q6：RBAC 中的 User、Group、ServiceAccount 有什么区别？</h4><p><strong>A</strong>：三种主体类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">User（用户）</span><br><span class="line">  └─ 真人用户（如 zhangsan）</span><br><span class="line">     来源：证书的 CN 字段</span><br><span class="line">     例子：kubectl 用户</span><br><span class="line"></span><br><span class="line">Group（用户组）</span><br><span class="line">  └─ 多个用户的集合</span><br><span class="line">     来源：证书的 O（Organization）字段</span><br><span class="line">     例子：system:masters（管理员组）</span><br><span class="line"></span><br><span class="line">ServiceAccount（服务账号）</span><br><span class="line">  └─ Pod 的身份</span><br><span class="line">     来源：K8s 自动创建</span><br><span class="line">     例子：Pod 内的应用访问 API Server 用的身份</span><br></pre></td></tr></table></figure>

<p><strong>使用场景</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">User：单个开发者或运维</span><br><span class="line">  kubectl config set-credentials zhangsan --client-certificate=...</span><br><span class="line"></span><br><span class="line">Group：部门或团队</span><br><span class="line">  kind: User name: manager（O 字段设为 manager，就自动加入 manager 组）</span><br><span class="line"></span><br><span class="line">ServiceAccount：Pod 内应用</span><br><span class="line">  Pod 自动挂载 SA token，用来访问 API Server</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q7：什么是-system-前缀？为什么要避免？"><a href="#Q7：什么是-system-前缀？为什么要避免？" class="headerlink" title="Q7：什么是 system: 前缀？为什么要避免？"></a>Q7：什么是 system: 前缀？为什么要避免？</h4><p><strong>A</strong>：<strong>K8s 系统保留前缀</strong></p>
<p><strong>system: 前缀的用户</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">system:masters           → 集群管理员</span><br><span class="line">system:nodes             → 所有 kubelet（每个 node 一个）</span><br><span class="line">system:kube-controller-manager  → controller manager</span><br><span class="line">system:kube-scheduler    → scheduler</span><br><span class="line">system:serviceaccount:ns:name   → 某个 SA</span><br></pre></td></tr></table></figure>

<p><strong>为什么避免使用</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">❌ 不要创建 system: 前缀的 User</span><br><span class="line">   - 这些是系统保留的</span><br><span class="line">   - 创建会冲突</span><br><span class="line">   - 破坏权限隔离</span><br><span class="line"></span><br><span class="line">✅ 应该创建自己的用户</span><br><span class="line">   - 如 app-dev、ops-team 等</span><br></pre></td></tr></table></figure>

<p><strong>例子</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ❌ 错误做法</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:developers</span>  <span class="comment"># 不要这样做</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ✅ 正确做法</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">developers</span>         <span class="comment"># 用 Group 代替</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q8：集群管理员怎么配置？"><a href="#Q8：集群管理员怎么配置？" class="headerlink" title="Q8：集群管理员怎么配置？"></a>Q8：集群管理员怎么配置？</h4><p><strong>A</strong>：绑定 <code>cluster-admin</code> 角色</p>
<p><strong>预置的 cluster-admin</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># K8s 集群默认已经创建了 cluster-admin ClusterRole</span></span><br><span class="line">kubectl get clusterrole cluster-admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要配置的是 ClusterRoleBinding</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: zhangsan          <span class="comment"># 该用户成为集群管理员</span></span><br></pre></td></tr></table></figure>

<p><strong>验证</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zhangsan 可以执行任何操作</span></span><br><span class="line">su - zhangsan</span><br><span class="line">kubectl get nodes</span><br><span class="line">kubectl delete pod --all --all-namespaces</span><br><span class="line"><span class="comment"># 都成功（如果是普通用户会被拒绝）</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q9：权限是加法还是减法？"><a href="#Q9：权限是加法还是减法？" class="headerlink" title="Q9：权限是加法还是减法？"></a>Q9：权限是加法还是减法？</h4><p><strong>A</strong>：<strong>纯加法，没有减法（白名单模式）</strong></p>
<p><strong>关键特性</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">✓ 如果某个 Role 包含 [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">  → 该用户有这 3 个权限</span><br><span class="line"></span><br><span class="line">✗ 不存在&quot;排除某个权限&quot;的概念</span><br><span class="line">  → 不能说&quot;我有 delete 权限除了 pod&quot;</span><br><span class="line">  → 只能改 Role，移除 delete 权限</span><br><span class="line"></span><br><span class="line">✗ 绑定两个 Role 时，权限是累加的</span><br><span class="line">  → RoleA：get, list</span><br><span class="line">  → RoleB：create, delete</span><br><span class="line">  → 实际拥有：get, list, create, delete（都有）</span><br></pre></td></tr></table></figure>

<p><strong>设计理由</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">减法会导致权限验证复杂（需要遍历所有限制）</span><br><span class="line">加法简单（权限来源单一，易于审计）</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q10：怎么给某个用户添加权限？"><a href="#Q10：怎么给某个用户添加权限？" class="headerlink" title="Q10：怎么给某个用户添加权限？"></a>Q10：怎么给某个用户添加权限？</h4><p><strong>A</strong>：创建或修改 Role 和 RoleBinding</p>
<p><strong>方法 1：修改现有 RoleBinding</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给 zhangsan 添加新权限</span></span><br><span class="line"><span class="comment"># 1. 编辑 Role，增加规则</span></span><br><span class="line">kubectl edit role pod-reader -n default</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 或创建新 Role + RoleBinding</span></span><br><span class="line">kubectl create role pod-deleter --verb=delete --resource=pods -n default</span><br><span class="line">kubectl create rolebinding zhangsan-delete-pods \</span><br><span class="line">  --clusterrole=pod-deleter \</span><br><span class="line">  --user=zhangsan \</span><br><span class="line">  -n default</span><br></pre></td></tr></table></figure>

<p><strong>方法 2：使用 YAML</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-admin</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zhangsan-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zhangsan</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-admin</span></span><br></pre></td></tr></table></figure>

<p><strong>验证</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查权限</span></span><br><span class="line">kubectl auth can-i get pods --as=zhangsan -n default</span><br><span class="line"><span class="comment"># yes</span></span><br><span class="line"></span><br><span class="line">kubectl auth can-i delete pods --as=zhangsan -n default</span><br><span class="line"><span class="comment"># yes</span></span><br><span class="line"></span><br><span class="line">kubectl auth can-i create deployments --as=zhangsan -n default</span><br><span class="line"><span class="comment"># no</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q11：RBAC-应该怎么规划？最佳实践是什么？"><a href="#Q11：RBAC-应该怎么规划？最佳实践是什么？" class="headerlink" title="Q11：RBAC 应该怎么规划？最佳实践是什么？"></a>Q11：RBAC 应该怎么规划？最佳实践是什么？</h4><p><strong>A</strong>：按角色分类，最小权限原则</p>
<p><strong>推荐角色划分</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">集群管理员</span><br><span class="line">  └─ ClusterRoleBinding: cluster-admin</span><br><span class="line">     权限：对所有资源有所有权限</span><br><span class="line"></span><br><span class="line">namespace 管理员</span><br><span class="line">  └─ RoleBinding: admin（每个 namespace）</span><br><span class="line">     权限：该 namespace 内的管理权限</span><br><span class="line"></span><br><span class="line">应用开发者</span><br><span class="line">  └─ RoleBinding: edit（开发 namespace）</span><br><span class="line">     权限：创建、修改、删除 Deployment/Pod/Service</span><br><span class="line">     不能：删除 PVC、修改 RBAC</span><br><span class="line"></span><br><span class="line">应用查看者</span><br><span class="line">  └─ RoleBinding: view</span><br><span class="line">     权限：只读（get/list/watch）</span><br></pre></td></tr></table></figure>

<p><strong>最佳实践</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1. 最小权限原则</span><br><span class="line">   - 初始权限最少</span><br><span class="line">   - 用户申请时，按需增加</span><br><span class="line">   - 定期审计，删除多余权限</span><br><span class="line"></span><br><span class="line">2. 按群体分组</span><br><span class="line">   - 不要给个人分配权限</span><br><span class="line">   - 创建 Group（组）后，多个用户加入</span><br><span class="line">   - 修改 Group 权限时，自动影响所有成员</span><br><span class="line"></span><br><span class="line">3. 定期审计</span><br><span class="line">   - 谁有 delete 权限？</span><br><span class="line">   - 谁有 exec Pod 权限？</span><br><span class="line">   - 谁有修改 RBAC 权限？</span><br><span class="line"></span><br><span class="line">4. 避免 cluster-admin</span><br><span class="line">   - 只给极少数人（如 SRE）</span><br><span class="line">   - 其他管理员用 namespace-admin + RoleBinding</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、HPA（Horizontal-Pod-Autoscaler）"><a href="#三、HPA（Horizontal-Pod-Autoscaler）" class="headerlink" title="三、HPA（Horizontal Pod Autoscaler）"></a>三、HPA（Horizontal Pod Autoscaler）</h2><h3 id="基础概念-1"><a href="#基础概念-1" class="headerlink" title="基础概念"></a>基础概念</h3><p><strong>HPA &#x3D; 水平自动扩容</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HPA 监控 Pod 资源使用 → 判断是否需要扩容 → 自动调整 Pod 副本数</span><br></pre></td></tr></table></figure>

<h3 id="面试题精选-2"><a href="#面试题精选-2" class="headerlink" title="面试题精选"></a>面试题精选</h3><h4 id="Q1：HPA-是干什么的？解决什么问题？"><a href="#Q1：HPA-是干什么的？解决什么问题？" class="headerlink" title="Q1：HPA 是干什么的？解决什么问题？"></a>Q1：HPA 是干什么的？解决什么问题？</h4><p><strong>A</strong>：<strong>自动调整 Pod 副本数，根据负载进行扩缩容</strong></p>
<p><strong>解决的问题</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">❌ 不用 HPA 的问题：</span><br><span class="line">   - 流量突增时，Pod 不够 → 请求失败</span><br><span class="line">   - 需要手动调整副本数（kubectl scale）</span><br><span class="line">   - 流量下降时，Pod 浪费资源</span><br><span class="line"></span><br><span class="line">✅ HPA 的优势：</span><br><span class="line">   - 自动扩容：流量增加 → Pod 自动增加</span><br><span class="line">   - 自动缩容：流量下降 → Pod 自动减少</span><br><span class="line">   - 节省资源：动态调整，避免浪费</span><br><span class="line">   - 提高可用性：能应对流量突增</span><br></pre></td></tr></table></figure>

<p><strong>工作原理</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Metrics Server（监控）</span><br><span class="line">         ↓</span><br><span class="line">    采集 Pod 的 CPU、内存等指标</span><br><span class="line">         ↓</span><br><span class="line">    HPA Controller 比较当前指标 vs 目标指标</span><br><span class="line">         ↓</span><br><span class="line">    如果超过目标 → 增加副本数（扩容）</span><br><span class="line">    如果低于目标 → 减少副本数（缩容）</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q2：HPA-靠什么指标判断是否需要扩容？"><a href="#Q2：HPA-靠什么指标判断是否需要扩容？" class="headerlink" title="Q2：HPA 靠什么指标判断是否需要扩容？"></a>Q2：HPA 靠什么指标判断是否需要扩容？</h4><p><strong>A</strong>：主要 3 种指标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1. CPU 使用率（最常用）</span><br><span class="line">   - 如果 Pod 平均 CPU &gt; 80% → 扩容</span><br><span class="line">   - 如果 Pod 平均 CPU &lt; 20% → 缩容</span><br><span class="line"></span><br><span class="line">2. 内存使用率（较少用）</span><br><span class="line">   - 同 CPU</span><br><span class="line">   - 内存不像 CPU 那样易释放，一般用 CPU</span><br><span class="line"></span><br><span class="line">3. 自定义指标（高级）</span><br><span class="line">   - QPS（请求数）</span><br><span class="line">   - 延迟</span><br><span class="line">   - 自定义业务指标</span><br></pre></td></tr></table></figure>

<p><strong>扩容触发条件</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">当前 CPU 利用率 &gt; 目标 CPU 利用率 × 1.1（有缓冲）</span><br><span class="line">  → 开始扩容</span><br><span class="line">  → 副本数 = ceil(当前 CPU / 目标 CPU × 当前副本数)</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">  - 目标 CPU：80%</span><br><span class="line">  - 当前副本：2</span><br><span class="line">  - 当前平均 CPU：160%（超过 80% × 1.1 的 88%）</span><br><span class="line">  → 副本数 = ceil(160% / 80% × 2) = ceil(4) = 4 个</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q3：HPA-怎么配置？YAML-怎么写？"><a href="#Q3：HPA-怎么配置？YAML-怎么写？" class="headerlink" title="Q3：HPA 怎么配置？YAML 怎么写？"></a>Q3：HPA 怎么配置？YAML 怎么写？</h4><p><strong>A</strong>：定义 HPA 对象，关联 Deployment</p>
<p><strong>基础示例</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span>              <span class="comment"># 关联哪个应用</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-app</span>              <span class="comment"># 关联的 Deployment 名</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">2</span>               <span class="comment"># 最小副本数</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span>              <span class="comment"># 最大副本数</span></span><br><span class="line">  <span class="attr">metrics:</span>                      <span class="comment"># 扩缩容指标</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span>      <span class="comment"># Utilization = 百分比</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">80</span> <span class="comment"># CPU 平均 &gt; 80% 时扩容</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">70</span> <span class="comment"># 内存 &gt; 70% 时扩容</span></span><br></pre></td></tr></table></figure>

<p><strong>简化版（仅用 CPU）</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure>

<p><strong>更简化版（v1 API，但功能少）</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">8</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">80</span>  <span class="comment"># CPU &gt; 80% 扩容</span></span><br></pre></td></tr></table></figure>

<p><strong>应用 HPA</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f hpa.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 HPA 状态</span></span><br><span class="line">kubectl get hpa</span><br><span class="line"><span class="comment"># NAME         REFERENCE       TARGETS        MINPODS MAXPODS REPLICAS   AGE</span></span><br><span class="line"><span class="comment"># nginx-hpa    Deployment/nginx 45%/80%        1       5       2          5m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细信息</span></span><br><span class="line">kubectl describe hpa nginx-hpa</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q4：HPA-需要什么前置条件？为什么必须有？"><a href="#Q4：HPA-需要什么前置条件？为什么必须有？" class="headerlink" title="Q4：HPA 需要什么前置条件？为什么必须有？"></a>Q4：HPA 需要什么前置条件？为什么必须有？</h4><p><strong>A</strong>：需要 Metrics Server，用来采集指标</p>
<p><strong>Metrics Server 是什么</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">K8s 官方的指标采集组件</span><br><span class="line">作用：定期采集每个 Pod 的 CPU、内存使用量</span><br><span class="line">地位：HPA 的眼睛（HPA 靠它判断是否需要扩容）</span><br></pre></td></tr></table></figure>

<p><strong>为什么必须有</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HPA 如何知道 Pod 用了多少 CPU？</span><br><span class="line">  → 需要监控组件告诉它</span><br><span class="line">  → 这个组件就是 Metrics Server</span><br><span class="line"></span><br><span class="line">没有 Metrics Server：</span><br><span class="line">  ✗ HPA 无法获取指标</span><br><span class="line">  ✗ 状态显示 &lt;unknown&gt;</span><br><span class="line">  ✗ 无法进行扩缩容</span><br></pre></td></tr></table></figure>

<p><strong>部署 Metrics Server</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查是否已安装</span></span><br><span class="line">kubectl get deployment -n kube-system | grep metrics-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有，安装（官方推荐）</span></span><br><span class="line">kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">kubectl top nodes        <span class="comment"># 查看节点资源</span></span><br><span class="line">kubectl top pods         <span class="comment"># 查看 Pod 资源</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q5：什么是-Metrics-Server？和-Prometheus-有什么区别？"><a href="#Q5：什么是-Metrics-Server？和-Prometheus-有什么区别？" class="headerlink" title="Q5：什么是 Metrics Server？和 Prometheus 有什么区别？"></a>Q5：什么是 Metrics Server？和 Prometheus 有什么区别？</h4><p><strong>A</strong>：都是监控，但职责不同</p>
<table>
<thead>
<tr>
<th>对比</th>
<th>Metrics Server</th>
<th>Prometheus</th>
</tr>
</thead>
<tbody><tr>
<td><strong>用途</strong></td>
<td>为 HPA 提供实时指标</td>
<td>长期存储监控数据，用于告警&#x2F;可视化</td>
</tr>
<tr>
<td><strong>数据保留</strong></td>
<td>只保留最新的指标（秒级）</td>
<td>持久化存储（天级）</td>
</tr>
<tr>
<td><strong>API</strong></td>
<td>metrics.k8s.io API</td>
<td>Prometheus HTTP API</td>
</tr>
<tr>
<td><strong>部署</strong></td>
<td>系统组件（必需）</td>
<td>可选的第三方监控</td>
</tr>
<tr>
<td><strong>查询</strong></td>
<td><code>kubectl top</code></td>
<td>Grafana</td>
</tr>
</tbody></table>
<p><strong>简单理解</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Metrics Server：K8s 的&quot;心跳监测&quot;，秒级反应</span><br><span class="line">  ↓</span><br><span class="line">  给 HPA 用，实时决策是否扩缩容</span><br><span class="line">  给 kubectl top 用，看当前资源使用</span><br><span class="line"></span><br><span class="line">Prometheus：K8s 的&quot;健康档案&quot;，历史数据</span><br><span class="line">  ↓</span><br><span class="line">  给 Grafana 用，绘制趋势图</span><br><span class="line">  给告警用，检测异常</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q6：HPA-多久检查一次？多久能看到效果？"><a href="#Q6：HPA-多久检查一次？多久能看到效果？" class="headerlink" title="Q6：HPA 多久检查一次？多久能看到效果？"></a>Q6：HPA 多久检查一次？多久能看到效果？</h4><p><strong>A</strong>：<strong>15 秒检查一次，但不是每次都扩容</strong></p>
<p><strong>时间参数</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">扫描间隔：15 秒（--horizontal-pod-autoscaler-sync-period）</span><br><span class="line">  → 每 15 秒评估一次指标</span><br><span class="line"></span><br><span class="line">向上扩容等待时间：3 分钟（--horizontal-pod-autoscaler-upscale-delay）</span><br><span class="line">  → 扩容后，3 分钟内再有高负载，也不继续扩</span><br><span class="line">  → 原因：给新 Pod 时间启动</span><br><span class="line"></span><br><span class="line">向下缩容等待时间：5 分钟（--horizontal-pod-autoscaler-downscale-delay）</span><br><span class="line">  → 缩容后，5 分钟内 Pod 保持，不再缩</span><br><span class="line">  → 原因：避免频繁缩容</span><br></pre></td></tr></table></figure>

<p><strong>整个过程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">时刻 0s：Pod CPU 突增到 90%</span><br><span class="line">时刻 15s：HPA 检查，发现 &gt; 80%，触发扩容</span><br><span class="line">时刻 20s：新 Pod 创建中...</span><br><span class="line">时刻 40s：新 Pod 启动完成</span><br><span class="line">时刻 45s：HPA 检查，但在 upscale-delay 内，暂不继续扩</span><br><span class="line">时刻 3min 15s：可以继续扩容（如果还需要）</span><br><span class="line"></span><br><span class="line">总体：从流量突增到真正完成扩容，可能需要 1-2 分钟</span><br></pre></td></tr></table></figure>

<p><strong>结论</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HPA 有延迟，不能应对秒级流量突增</span><br><span class="line">对于突发高峰，需要预留缓冲（min replicas 足够大）</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q7：HPA-的扩容公式是什么？"><a href="#Q7：HPA-的扩容公式是什么？" class="headerlink" title="Q7：HPA 的扩容公式是什么？"></a>Q7：HPA 的扩容公式是什么？</h4><p><strong>A</strong>：计算需要的副本数</p>
<p><strong>公式</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">新副本数 = ceil(当前 CPU / 目标 CPU × 当前副本数)</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">  - 当前副本：2</span><br><span class="line">  - 当前平均 CPU：160%</span><br><span class="line">  - 目标 CPU：80%</span><br><span class="line">  - 新副本数 = ceil(160 / 80 × 2) = ceil(4) = 4</span><br><span class="line"></span><br><span class="line">  实际变化：2 → 4（增加 2 个）</span><br></pre></td></tr></table></figure>

<p><strong>缩容公式</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">新副本数 = ceil(当前 CPU / 目标 CPU × 当前副本数)</span><br><span class="line"></span><br><span class="line">例子（缩容）：</span><br><span class="line">  - 当前副本：4</span><br><span class="line">  - 当前平均 CPU：20%</span><br><span class="line">  - 目标 CPU：50%</span><br><span class="line">  - 新副本数 = ceil(20 / 50 × 4) = ceil(1.6) = 2</span><br><span class="line"></span><br><span class="line">  实际变化：4 → 2（减少 2 个）</span><br></pre></td></tr></table></figure>

<p><strong>多指标的情况</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">如果同时指定 CPU 和内存，取最大需求值</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">  - CPU 需要：3 个 Pod</span><br><span class="line">  - 内存需要：5 个 Pod</span><br><span class="line">  - 最终：5 个 Pod（取最大值）</span><br><span class="line"></span><br><span class="line">原理：任意一个指标不满足就无法正常运行</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q8：HPA-会不会扩容到超过-maxReplicas？"><a href="#Q8：HPA-会不会扩容到超过-maxReplicas？" class="headerlink" title="Q8：HPA 会不会扩容到超过 maxReplicas？"></a>Q8：HPA 会不会扩容到超过 maxReplicas？</h4><p><strong>A</strong>：<strong>不会，maxReplicas 是硬限制</strong></p>
<p><strong>保护机制</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">如果计算出的副本数 &gt; maxReplicas</span><br><span class="line">  → 扩容到 maxReplicas 就停止</span><br><span class="line">  → Pod 的 CPU 继续升高也不会再扩（因为已到上限）</span><br><span class="line">  → 可能出现过载，但这是故意的设计</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  计算需要: 15 个 Pod</span><br><span class="line">  实际扩容到: 10 个</span><br><span class="line">  结果: 10 个 Pod 可能过载，但不会再扩</span><br></pre></td></tr></table></figure>

<p><strong>应对策略</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 预测流量，合理设置 maxReplicas（不要太小）</span><br><span class="line">2. 如果经常碰到上限，增大 maxReplicas</span><br><span class="line">3. 用多个 HPA（不同应用不同上限）</span><br><span class="line">4. 结合队列（消费者模式），缓冲请求</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q9：minReplicas-设置多少比较好？"><a href="#Q9：minReplicas-设置多少比较好？" class="headerlink" title="Q9：minReplicas 设置多少比较好？"></a>Q9：minReplicas 设置多少比较好？</h4><p><strong>A</strong>：根据业务重要性和成本平衡</p>
<p><strong>考虑因素</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">低 minReplicas（如 1）：</span><br><span class="line">  ✓ 成本低（只需 1 个 Pod）</span><br><span class="line">  ✗ 风险高（Pod 故障或扩容延迟，无备份）</span><br><span class="line">  ✗ 冷启动慢（Pod 才启动，需要等待）</span><br><span class="line">  适用：非关键服务、开发测试</span><br><span class="line"></span><br><span class="line">中等 minReplicas（如 2-3）：</span><br><span class="line">  ✓ 风险较低（至少有 1 个备份）</span><br><span class="line">  ✓ 成本可控</span><br><span class="line">  ✓ 扩容延迟影响较小</span><br><span class="line">  适用：普通服务、可容忍短暂不可用</span><br><span class="line"></span><br><span class="line">高 minReplicas（如 5+）：</span><br><span class="line">  ✓ 风险最低（高可用）</span><br><span class="line">  ✗ 成本高（即使不需要也要维持）</span><br><span class="line">  ✓ 无冷启动问题</span><br><span class="line">  适用：关键服务、金融业务</span><br></pre></td></tr></table></figure>

<p><strong>建议</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">最小值 = max(Pod 正常运行所需, 预期流量的基准数)</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">  - 平时访问 5qps，需要 2 个 Pod</span><br><span class="line">  - minReplicas = 2</span><br><span class="line"></span><br><span class="line">  - 平时访问 100qps，需要 10 个 Pod</span><br><span class="line">  - minReplicas = 10</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q10：HPA-怎么测试？怎么验证能否正常扩缩容？"><a href="#Q10：HPA-怎么测试？怎么验证能否正常扩缩容？" class="headerlink" title="Q10：HPA 怎么测试？怎么验证能否正常扩缩容？"></a>Q10：HPA 怎么测试？怎么验证能否正常扩缩容？</h4><p><strong>A</strong>：制造负载，观察副本数变化</p>
<p><strong>测试步骤</strong>：</p>
<p><strong>1. 部署应用和 HPA</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署 nginx</span></span><br><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line">kubectl expose deployment nginx --port=80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 HPA</span></span><br><span class="line">kubectl autoscale deployment nginx --min=1 --max=5 --cpu-percent=20</span><br><span class="line"><span class="comment"># 注：--cpu-percent=20 表示 CPU &gt; 20% 就扩容（测试用低值）</span></span><br></pre></td></tr></table></figure>

<p><strong>2. 检查 Metrics Server</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确保 metrics server 运行</span></span><br><span class="line">kubectl get pod -n kube-system | grep metrics-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等 30 秒，让 Pod 有指标</span></span><br><span class="line"><span class="built_in">sleep</span> 30</span><br><span class="line">kubectl top pods  <span class="comment"># 应该能看到 CPU/内存使用</span></span><br></pre></td></tr></table></figure>

<p><strong>3. 产生负载</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 Pod，持续请求</span></span><br><span class="line">kubectl run -i --<span class="built_in">tty</span> load-generator --<span class="built_in">rm</span> --image=busybox --restart=Never \</span><br><span class="line">  -- /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在容器内运行（会持续发请求）</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> wget -q -O- http://nginx; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>4. 观察扩容</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在另一个终端，每秒查看副本数</span></span><br><span class="line">watch kubectl get hpa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出示例（随时间变化）：</span></span><br><span class="line"><span class="comment"># NAME      REFERENCE       TARGETS    MINPODS MAXPODS REPLICAS</span></span><br><span class="line"><span class="comment"># nginx-hpa Deployment/nginx 0%/20%     1       5       1       ← 初始 1 个</span></span><br><span class="line"><span class="comment"># nginx-hpa Deployment/nginx 45%/20%    1       5       1       ← CPU 升高</span></span><br><span class="line"><span class="comment"># nginx-hpa Deployment/nginx 50%/20%    1       5       3       ← 开始扩容</span></span><br><span class="line"><span class="comment"># nginx-hpa Deployment/nginx 25%/20%    1       5       5       ← 继续扩</span></span><br></pre></td></tr></table></figure>

<p><strong>5. 停止负载，观察缩容</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 load-generator 容器中 Ctrl+C 停止请求</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 观察缩容（需要等 5 分钟以上）</span></span><br><span class="line">watch kubectl get hpa</span><br><span class="line"><span class="comment"># 副本数会逐步降低</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q11：HPA-不工作了怎么排查？"><a href="#Q11：HPA-不工作了怎么排查？" class="headerlink" title="Q11：HPA 不工作了怎么排查？"></a>Q11：HPA 不工作了怎么排查？</h4><p><strong>A</strong>：检查这 5 点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1. Metrics Server 是否运行？</span><br><span class="line">   kubectl get pod -n kube-system | grep metrics-server</span><br><span class="line">   </span><br><span class="line">   如果没有 → 安装 metrics server</span><br><span class="line">   如果有但不运行 → 查看日志</span><br><span class="line">   kubectl logs -n kube-system deployment/metrics-server</span><br><span class="line"></span><br><span class="line">2. Pod 有没有 resource requests？</span><br><span class="line">   kubectl get pod &lt;pod&gt; -o yaml | grep -A 5 resources</span><br><span class="line">   </span><br><span class="line">   HPA 需要 requests 来计算百分比！</span><br><span class="line">   没有 requests → HPA 无法工作</span><br><span class="line">   </span><br><span class="line">   例子（必须有）：</span><br><span class="line">   resources:</span><br><span class="line">     requests:</span><br><span class="line">       cpu: 100m        # ← 必须有</span><br><span class="line">       memory: 128Mi</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">✓ Metrics Server 在运行</span><br><span class="line">✓ Pod 定义了 resource requests</span><br><span class="line">✓ 等待 15-30 秒让指标生成</span><br><span class="line">✓ HPA 状态不是 &lt;unknown&gt;</span><br><span class="line">✓ minReplicas 和 maxReplicas 配置正确</span><br></pre></td></tr></table></figure>

<p><strong>常见错误</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">错误 1：HPA 显示 &lt;unknown&gt;</span><br><span class="line">  → Pod 没定义 requests</span><br><span class="line">  → 解决：添加 resources.requests</span><br><span class="line"></span><br><span class="line">错误 2：HPA 始终不扩容</span><br><span class="line">  → Metrics Server 未运行</span><br><span class="line">  → 或目标值设置不合理（太高）</span><br><span class="line">  → 检查日志，调整目标值</span><br><span class="line"></span><br><span class="line">错误 3：扩容太快或太慢</span><br><span class="line">  → 调整扫描间隔和延迟时间</span><br><span class="line">  → 或调整 minReplicas/maxReplicas</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q12：什么情况下-HPA-无法工作？"><a href="#Q12：什么情况下-HPA-无法工作？" class="headerlink" title="Q12：什么情况下 HPA 无法工作？"></a>Q12：什么情况下 HPA 无法工作？</h4><p><strong>A</strong>：这 5 种情况不能用 HPA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1. Pod 没有 requests 定义</span><br><span class="line">   → HPA 无法计算 CPU 百分比</span><br><span class="line">   → 必须添加 resources.requests.cpu</span><br><span class="line"></span><br><span class="line">2. Pod 是 StatefulSet 的有状态应用</span><br><span class="line">   → 不能随意杀死 Pod（缩容有风险）</span><br><span class="line">   → 可以用 HPA，但要小心</span><br><span class="line"></span><br><span class="line">3. 需要根据自定义指标扩容（如 QPS）</span><br><span class="line">   → 基础 HPA 只支持 CPU/内存</span><br><span class="line">   → 需要用 Custom Metrics（更复杂）</span><br><span class="line"></span><br><span class="line">4. Pod 启动很慢（如 Java 应用）</span><br><span class="line">   → 扩容延迟会导致流量堆积</span><br><span class="line">   → 需要提高 minReplicas，或用 startup probe</span><br><span class="line"></span><br><span class="line">5. 无法预测流量（流量完全随机）</span><br><span class="line">   → HPA 反应延迟（15 秒 + 3 分钟缓冲）</span><br><span class="line">   → 对突发流量无力</span><br><span class="line">   → 需要结合限流、队列等手段</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q13：HPA-VPA-可以一起用吗？"><a href="#Q13：HPA-VPA-可以一起用吗？" class="headerlink" title="Q13：HPA + VPA 可以一起用吗？"></a>Q13：HPA + VPA 可以一起用吗？</h4><p><strong>A</strong>：<strong>不建议同时用 CPU&#x2F;内存 HPA 和 VPA</strong></p>
<p><strong>VPA（Vertical Pod Autoscaler）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">VPA：竖向自动扩容（增加单个 Pod 的资源）</span><br><span class="line">HPA：横向自动扩容（增加 Pod 数量）</span><br><span class="line"></span><br><span class="line">如果同时用：</span><br><span class="line">  ✗ VPA 修改 Pod 资源 request</span><br><span class="line">  ✗ HPA 根据新的 request 计算副本数</span><br><span class="line">  ✗ 容易出现循环调整，导致不稳定</span><br><span class="line"></span><br><span class="line">建议：</span><br><span class="line">  ① 用 VPA 确定合理的 requests</span><br><span class="line">  ② 固定 requests，再用 HPA</span><br><span class="line">  ③ 或只用 HPA，不用 VPA</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q14：生产环境-HPA-怎么配置才稳定？"><a href="#Q14：生产环境-HPA-怎么配置才稳定？" class="headerlink" title="Q14：生产环境 HPA 怎么配置才稳定？"></a>Q14：生产环境 HPA 怎么配置才稳定？</h4><p><strong>A</strong>：综合考虑这些参数</p>
<p><strong>推荐配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prod-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 1. 副本数合理范围</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">3</span>           <span class="comment"># 最少 3 个（高可用）</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">20</span>          <span class="comment"># 最多 20 个（成本控制）</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 2. 扩缩容指标</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">70</span>    <span class="comment"># 70% 扩容（留 30% 余量）</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 3. 扩缩容行为（v2 API 的高级功能）</span></span><br><span class="line">  <span class="attr">behavior:</span></span><br><span class="line">    <span class="attr">scaleUp:</span></span><br><span class="line">      <span class="attr">stabilizationWindowSeconds:</span> <span class="number">60</span>    <span class="comment"># 扩容稳定期 60 秒</span></span><br><span class="line">      <span class="attr">policies:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Percent</span></span><br><span class="line">        <span class="attr">value:</span> <span class="number">50</span>                        <span class="comment"># 每次增加 50%</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">scaleDown:</span></span><br><span class="line">      <span class="attr">stabilizationWindowSeconds:</span> <span class="number">300</span>   <span class="comment"># 缩容稳定期 300 秒（更保守）</span></span><br><span class="line">      <span class="attr">policies:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Percent</span></span><br><span class="line">        <span class="attr">value:</span> <span class="number">25</span>                        <span class="comment"># 每次减少 25%</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>

<p><strong>配置说明</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">minReplicas: 3</span><br><span class="line">  → 任何时候至少 3 个 Pod（故障转移能力）</span><br><span class="line"></span><br><span class="line">maxReplicas: 20</span><br><span class="line">  → 控制成本，防止无限扩容</span><br><span class="line"></span><br><span class="line">averageUtilization: 70</span><br><span class="line">  → CPU 使用率高于 70% 才扩容</span><br><span class="line">  → 留 30% 余量，应对突增</span><br><span class="line"></span><br><span class="line">scaleUp policies:</span><br><span class="line">  → 每次增加 50%（快速响应高峰）</span><br><span class="line">  → periodSeconds: 60（每 60 秒评估一次）</span><br><span class="line"></span><br><span class="line">scaleDown policies:</span><br><span class="line">  → 每次减少 25%（缓慢降低，避免震荡）</span><br><span class="line">  → stabilizationWindowSeconds: 300（5 分钟稳定期，更保守）</span><br></pre></td></tr></table></figure>

<p><strong>为什么 scaleDown 保守</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">缩容错了，只是浪费资源，不影响功能</span><br><span class="line">扩容错了，Pod 不够，请求失败，影响用户</span><br><span class="line"></span><br><span class="line">所以：缩容慢一点，扩容快一点（不对称）</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结对比表"><a href="#总结对比表" class="headerlink" title="总结对比表"></a>总结对比表</h2><h3 id="CNI-插件选型速查"><a href="#CNI-插件选型速查" class="headerlink" title="CNI 插件选型速查"></a>CNI 插件选型速查</h3><table>
<thead>
<tr>
<th>特性</th>
<th>Flannel</th>
<th>Calico</th>
<th>Cilium</th>
</tr>
</thead>
<tbody><tr>
<td><strong>网络模型</strong></td>
<td>Overlay</td>
<td>三层路由</td>
<td>eBPF</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>中</td>
<td>高</td>
<td>最高</td>
</tr>
<tr>
<td><strong>NetworkPolicy</strong></td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td><strong>部署复杂度</strong></td>
<td>低</td>
<td>中</td>
<td>高</td>
</tr>
<tr>
<td><strong>社区支持</strong></td>
<td>中</td>
<td>强</td>
<td>强</td>
</tr>
<tr>
<td><strong>推荐场景</strong></td>
<td>开发测试</td>
<td>生产推荐</td>
<td>高性能</td>
</tr>
</tbody></table>
<h3 id="RBAC-核心快记"><a href="#RBAC-核心快记" class="headerlink" title="RBAC 核心快记"></a>RBAC 核心快记</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">4 个对象：Role、ClusterRole、RoleBinding、ClusterRoleBinding</span><br><span class="line">3 个主体：User、Group、ServiceAccount  </span><br><span class="line">权限模式：白名单加法（不支持减法）</span><br><span class="line">选择原则：权限范围小→Role，大→ClusterRole</span><br><span class="line">绑定原则：跨 ns→ClusterRoleBinding，单 ns→RoleBinding</span><br></pre></td></tr></table></figure>

<h3 id="HPA-配置快记"><a href="#HPA-配置快记" class="headerlink" title="HPA 配置快记"></a>HPA 配置快记</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">必要条件：Metrics Server + Pod 的 resource requests</span><br><span class="line">工作周期：15 秒扫描 + 3 分钟(扩)/5 分钟(缩)缓冲</span><br><span class="line">指标类型：CPU(最常用) &gt; 内存 &gt; 自定义指标</span><br><span class="line">配置要点：minReplicas(≥2) + maxReplicas(成本控制) + 目标值</span><br><span class="line">测试方法：制造负载 → 观察副本变化 → 停止负载 → 观察缩容</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">Felix</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/">http://example.com/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/imgs/adater.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/12/16/Kubernetes%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86/" title="Kubernetes存储管理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Kubernetes存储管理</div></div><div class="info-2"><div class="info-item-1">Kubernetes 存储管理一、ConfigMap 与 Secret 配置管理1.1 ConfigMap（配置管理）概念ConfigMap 用于管理 Pod 中容器内服务的配置文件和环境变量。 适用场景 存储应用配置文件（如 Nginx.conf、数据库连接配置） 定义环境变量 非加密的配置数据  典型例子：Ruo-Yi 微服务 前端：Nginx + VUE 框架（DIST 文件） 配置文件：Nginx.conf  1.2 Secret（加密管理）概念Secret 管理 Pod 中容器的加密信息、令牌与密钥文件。 适用场景 存储加密密钥 管理用户凭证（用户名&#x2F;密码） 存储 API Token 和 Secret 密钥文件 敏感信息保护  Secret 创建方式方式一：使用 kubectl 命令创建 1kubectl create secret generic &lt;secret-name&gt; --from-file=&lt;file-path&gt;  方式二：Base64 编码后编写 YAML 12345678910111213141516# 编码敏感信息ech...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/imgs/adater.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Felix</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">39</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/falsezxy"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-Ingress%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">Kubernetes-Ingress服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Ingress-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">一、Ingress 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-Ingress%EF%BC%9F"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. 为什么需要 Ingress？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%B0%E6%9C%89%E6%96%B9%E6%A1%88%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">现有方案的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ingress%EF%BC%88%E4%B8%83%E5%B1%82%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%EF%BC%89-%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">Ingress（七层反向代理） 的优势</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Ingress-%E7%9A%84%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">二、Ingress 的核心组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Ingress%EF%BC%88%E8%A7%84%E5%88%99%E5%AE%9A%E4%B9%89%EF%BC%89"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. Ingress（规则定义）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Ingress-Controller%EF%BC%88%E6%89%A7%E8%A1%8C%E8%BD%AC%E5%8F%91%EF%BC%89"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. Ingress Controller（执行转发）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Ingress-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">三、Ingress 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81K8s-%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84"><span class="toc-number">1.4.</span> <span class="toc-text">四、K8s 网络分层架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81Service-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E6%9A%B4%E9%9C%B2%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.</span> <span class="toc-text">五、Service 服务发现与暴露模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-%E7%B1%BB%E5%9E%8B%E5%AF%B9%E6%AF%94"><span class="toc-number">1.5.1.</span> <span class="toc-text">Service 类型对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81Ingress-Controller-%E9%83%A8%E7%BD%B2%EF%BC%88ingress-nginx-%E7%A4%BA%E4%BE%8B%EF%BC%89"><span class="toc-number">1.6.</span> <span class="toc-text">六、Ingress Controller 部署（ingress-nginx 示例）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%98%E6%96%B9%E6%B8%85%E5%8D%95"><span class="toc-number">1.6.1.</span> <span class="toc-text">获取官方清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-RBAC-%E6%9D%83%E9%99%90%EF%BC%880-25-%E7%89%88%E6%9C%AC%EF%BC%89"><span class="toc-number">1.6.2.</span> <span class="toc-text">修改 RBAC 权限（0.25+ 版本）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E4%B8%89%E7%A7%8D%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-number">1.7.</span> <span class="toc-text">七、三种部署模式对比</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%B8%80%EF%BC%9ADeployment-LoadBalancer%EF%BC%88%E4%BA%91%E7%AB%AF%E6%96%B9%E6%A1%88%EF%BC%89"><span class="toc-number">1.7.1.</span> <span class="toc-text">模式一：Deployment + LoadBalancer（云端方案）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%BA%8C%EF%BC%9ADaemonSet-HostNetwork-NodeSelector%EF%BC%88%E7%94%9F%E4%BA%A7%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">1.7.2.</span> <span class="toc-text">模式二：DaemonSet + HostNetwork + NodeSelector（生产推荐）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E7%BB%99-node-%E6%89%93%E6%A0%87%E7%AD%BE%EF%BC%8C%E4%BB%85%E5%9C%A8-node02-%E8%BF%90%E8%A1%8C%EF%BC%9A"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">1、给 node 打标签，仅在 node02 运行：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%B0%86-Deployment-%E6%94%B9%E4%B8%BA-DaemonSet%EF%BC%8C%E5%90%AF%E7%94%A8-HostNetwork-%E5%B9%B6%E6%8C%87%E5%AE%9A-node%EF%BC%9A"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">2、将 Deployment 改为 DaemonSet，启用 HostNetwork 并指定 node：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E5%9C%A8%E6%89%80%E6%9C%89-node-%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E5%B9%B6%E5%8A%A0%E8%BD%BD%EF%BC%9A"><span class="toc-number">1.7.2.3.</span> <span class="toc-text">3、在所有 node 上传镜像并加载：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%90%AF%E5%8A%A8-Controller%EF%BC%8C%E9%AA%8C%E8%AF%81%E7%9B%91%E5%90%AC%E7%AB%AF%E5%8F%A3%EF%BC%88%E5%9C%A8-node02%EF%BC%89%EF%BC%9A"><span class="toc-number">1.7.2.4.</span> <span class="toc-text">4、启动 Controller，验证监听端口（在 node02）：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E5%88%9B%E5%BB%BA-ingress-%E8%A7%84%E5%88%99"><span class="toc-number">1.7.2.5.</span> <span class="toc-text">5、创建 ingress 规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81%E5%88%9B%E5%BB%BA-Ingress%EF%BC%88%E4%B8%A4%E7%A7%8D-API-%E7%A4%BA%E4%BE%8B%EF%BC%89%EF%BC%9A"><span class="toc-number">1.7.2.6.</span> <span class="toc-text">6、创建 Ingress（两种 API 示例）：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="toc-number">1.7.2.7.</span> <span class="toc-text">7、测试：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%B8%89%EF%BC%9ADeployment-Service-NodePort-%EF%BC%88%E5%B8%B8%E8%A7%84%E6%96%B9%E6%A1%88%EF%BC%89"><span class="toc-number">1.7.3.</span> <span class="toc-text">模式三：Deployment + Service(NodePort)（常规方案）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E4%B8%8B%E8%BD%BD-nginx-ingress-controller-%E5%92%8C-ingress-nginx-%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">1、下载 nginx-ingress-controller 和 ingress-nginx 暴露端口配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81Ingress-%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.8.</span> <span class="toc-text">八、Ingress 规则配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%9F%BA%E7%A1%80-HTTP-%E4%BB%A3%E7%90%86"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 基础 HTTP 代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%EF%BC%88%E5%A4%9A%E5%9F%9F%E5%90%8D%EF%BC%89"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 虚拟主机（多域名）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-HTTPS-TLS-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.8.3.</span> <span class="toc-text">8.3 HTTPS&#x2F;TLS 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-BasicAuth-%E8%AE%A4%E8%AF%81"><span class="toc-number">1.8.4.</span> <span class="toc-text">8.4 BasicAuth 认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-URL-%E9%87%8D%E5%86%99%EF%BC%88Rewrite%EF%BC%89"><span class="toc-number">1.8.5.</span> <span class="toc-text">8.5 URL 重写（Rewrite）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B8%8E%E8%B0%83%E8%AF%95"><span class="toc-number">1.9.</span> <span class="toc-text">九、问题排查与调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-Controller-%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81"><span class="toc-number">1.9.1.</span> <span class="toc-text">查看 Controller 运行状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5-Pod-%E6%A3%80%E6%9F%A5-Nginx-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.9.2.</span> <span class="toc-text">进入 Pod 检查 Nginx 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.9.3.</span> <span class="toc-text">常见问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93"><span class="toc-number">1.10.</span> <span class="toc-text">十、实践总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B"><span class="toc-number">1.10.1.</span> <span class="toc-text">完整配置流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.10.2.</span> <span class="toc-text">生产最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.11.</span> <span class="toc-text">参考文献</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E2%80%94%E2%80%94Kubernetes-%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6"><span class="toc-number">2.</span> <span class="toc-text">补充——Kubernetes 安全机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">2.1.</span> <span class="toc-text">一、核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">2.1.1.</span> <span class="toc-text">1. 安全机制的本质</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%B8%89%E9%81%93%E9%98%B2%E7%BA%BF%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.2.</span> <span class="toc-text">二、三道防线详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC1%E9%81%93%EF%BC%9A%E8%AE%A4%E8%AF%81%EF%BC%88Authentication%EF%BC%89-%E4%BD%A0%E6%98%AF%E8%B0%81%EF%BC%9F"><span class="toc-number">2.2.1.</span> <span class="toc-text">第1道：认证（Authentication）- 你是谁？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">认证方式对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E8%A2%AB%E8%AE%A4%E8%AF%81%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">需要被认证的组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6%E7%9A%84%E4%BA%A7%E7%94%9F%E6%96%B9%E5%BC%8F"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">证书的产生方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kubeconfig-%E6%96%87%E4%BB%B6%EF%BC%88%E8%AE%A4%E8%AF%81%E5%87%AD%E8%AF%81%EF%BC%89"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">kubeconfig 文件（认证凭证）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service-Account%EF%BC%88SA%EF%BC%89-Pod-%E7%9A%84%E8%BA%AB%E4%BB%BD%E8%AF%81"><span class="toc-number">2.2.1.5.</span> <span class="toc-text">Service Account（SA）- Pod 的身份证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC2%E9%81%93%EF%BC%9A%E9%89%B4%E6%9D%83%EF%BC%88Authorization%EF%BC%89-%E4%BD%A0%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.2.2.</span> <span class="toc-text">第2道：鉴权（Authorization）- 你能做什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5%E5%AF%B9%E6%AF%94"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">授权策略对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RBAC-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">RBAC 核心概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E5%AE%9A%E4%B9%89%EF%BC%88Role-vs-ClusterRole%EF%BC%89"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">角色定义（Role vs ClusterRole）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%BB%91%E5%AE%9A%EF%BC%88Binding%EF%BC%89"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">权限绑定（Binding）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%9D%83%E9%99%90%E9%80%9F%E6%9F%A5"><span class="toc-number">2.2.2.5.</span> <span class="toc-text">常见权限速查</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC3%E9%81%93%EF%BC%9A%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%EF%BC%88Admission-Control%EF%BC%89"><span class="toc-number">2.2.3.</span> <span class="toc-text">第3道：准入控制（Admission Control）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%8F%92%E4%BB%B6"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">常见插件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AE%9E%E8%B7%B5%EF%BC%9A%E5%88%9B%E5%BB%BA%E5%8F%97%E9%99%90%E7%94%A8%E6%88%B7"><span class="toc-number">2.3.</span> <span class="toc-text">三、实践：创建受限用户</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E5%88%9B%E5%BB%BA%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7"><span class="toc-number">2.3.1.</span> <span class="toc-text">步骤 1：创建系统用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E7%94%9F%E6%88%90%E7%94%A8%E6%88%B7%E8%AF%81%E4%B9%A6"><span class="toc-number">2.3.2.</span> <span class="toc-text">步骤 2：生成用户证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E7%94%9F%E6%88%90-kubeconfig"><span class="toc-number">2.3.3.</span> <span class="toc-text">步骤 3：生成 kubeconfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-4%EF%BC%9A%E5%88%9B%E5%BB%BA-RBAC-%E6%8E%88%E6%9D%83"><span class="toc-number">2.3.4.</span> <span class="toc-text">步骤 4：创建 RBAC 授权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-5%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%9D%83%E9%99%90"><span class="toc-number">2.3.5.</span> <span class="toc-text">步骤 5：验证权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%89%E5%85%A8%E6%80%A7%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.4.</span> <span class="toc-text">四、安全性最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%AE%A4%E8%AF%81%E5%B1%82"><span class="toc-number">2.4.1.</span> <span class="toc-text">1. 认证层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8E%88%E6%9D%83%E5%B1%82"><span class="toc-number">2.4.2.</span> <span class="toc-text">2. 授权层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%B1%82"><span class="toc-number">2.4.3.</span> <span class="toc-text">3. 准入控制层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-API-Server-%E5%AE%89%E5%85%A8"><span class="toc-number">2.4.4.</span> <span class="toc-text">4. API Server 安全</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">2.5.</span> <span class="toc-text">五、常见面试题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E9%80%9F%E8%AE%B0"><span class="toc-number">2.6.</span> <span class="toc-text">总结速记</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#K8S-CNI%E3%80%81RBAC%E3%80%81HPA-%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">K8S CNI、RBAC、HPA 常见面试题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81CNI-%E6%8F%92%E4%BB%B6%EF%BC%88Container-Network-Interface%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">一、CNI 插件（Container Network Interface）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">3.1.1.</span> <span class="toc-text">基础概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E7%B2%BE%E9%80%89"><span class="toc-number">3.1.2.</span> <span class="toc-text">面试题精选</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Q1%EF%BC%9AK8s-%E4%B8%AD%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF%E5%88%86%E5%87%A0%E5%B1%82%EF%BC%9F%E5%88%86%E5%88%AB%E7%94%A8%E4%BB%80%E4%B9%88%E5%AE%9E%E7%8E%B0%EF%BC%9F"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">Q1：K8s 中网络通讯分几层？分别用什么实现？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q2%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-CNI-%E6%8F%92%E4%BB%B6%EF%BC%9FK8s-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0%EF%BC%9F"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">Q2：为什么需要 CNI 插件？K8s 为什么不自己实现？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q3%EF%BC%9A%E5%B8%B8%E8%A7%81%E7%9A%84-CNI-%E6%8F%92%E4%BB%B6%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F%E5%8C%BA%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">Q3：常见的 CNI 插件有哪些？区别是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q4%EF%BC%9ACNI-%E6%8F%92%E4%BB%B6%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%BA-Pod-%E5%88%86%E9%85%8D-IP-%E7%9A%84%EF%BC%9F"><span class="toc-number">3.1.2.4.</span> <span class="toc-text">Q4：CNI 插件是如何为 Pod 分配 IP 的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q5%EF%BC%9APod-%E5%9C%A8%E4%B8%8D%E5%90%8C-Node-%E4%B8%8A%EF%BC%8C%E6%80%8E%E4%B9%88%E9%80%9A%E8%AE%AF%EF%BC%9FCNI-%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F"><span class="toc-number">3.1.2.5.</span> <span class="toc-text">Q5：Pod 在不同 Node 上，怎么通讯？CNI 怎么实现的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q6%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF-NetworkPolicy%EF%BC%9F%E5%93%AA%E4%B8%AA-CNI-%E6%94%AF%E6%8C%81%EF%BC%9F"><span class="toc-number">3.1.2.6.</span> <span class="toc-text">Q6：什么是 NetworkPolicy？哪个 CNI 支持？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q7%EF%BC%9ACNI-%E6%8F%92%E4%BB%B6%E6%95%85%E9%9A%9C%E4%BC%9A%E6%80%8E%E6%A0%B7%EF%BC%9F%E6%80%8E%E4%B9%88%E6%8E%92%E6%9F%A5%EF%BC%9F"><span class="toc-number">3.1.2.7.</span> <span class="toc-text">Q7：CNI 插件故障会怎样？怎么排查？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q8%EF%BC%9A%E8%83%BD%E8%87%AA%E5%B7%B1%E5%86%99-CNI-%E6%8F%92%E4%BB%B6%E5%90%97%EF%BC%9F"><span class="toc-number">3.1.2.8.</span> <span class="toc-text">Q8：能自己写 CNI 插件吗？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q9%EF%BC%9APod-CIDR-%E5%92%8C-Service-CIDR-%E6%98%AF%E4%B8%80%E6%A0%B7%E7%9A%84%E5%90%97%EF%BC%9F"><span class="toc-number">3.1.2.9.</span> <span class="toc-text">Q9：Pod CIDR 和 Service CIDR 是一样的吗？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q10%EF%BC%9ACNI-%E6%8F%92%E4%BB%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%EF%BC%9F%E9%80%89%E5%9E%8B%E6%A0%87%E5%87%86%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">3.1.2.10.</span> <span class="toc-text">Q10：CNI 插件如何选择？选型标准是什么？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81RBAC-%E8%AE%A4%E7%9F%A5%EF%BC%88%E7%AE%80%E5%8C%96%E7%89%88%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">二、RBAC 认知（简化版）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E6%A6%82%E5%BF%B5"><span class="toc-number">3.2.1.</span> <span class="toc-text">快速概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E7%B2%BE%E9%80%89-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">面试题精选</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Q1%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF-RBAC%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88-K8s-%E7%94%A8-RBAC%EF%BC%9F"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">Q1：什么是 RBAC？为什么 K8s 用 RBAC？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q2%EF%BC%9ARBAC-%E6%9C%89%E5%93%AA-4-%E4%B8%AA%E5%AF%B9%E8%B1%A1%EF%BC%9F%E5%88%86%E5%88%AB%E5%B9%B2%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">Q2：RBAC 有哪 4 个对象？分别干什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q3%EF%BC%9ARole-%E5%92%8C-ClusterRole-%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">Q3：Role 和 ClusterRole 的区别？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q4%EF%BC%9ARoleBinding-%E5%8F%AF%E4%BB%A5%E5%BC%95%E7%94%A8-ClusterRole-%E5%90%97%EF%BC%9F%E4%BC%9A%E6%80%8E%E6%A0%B7%EF%BC%9F"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">Q4：RoleBinding 可以引用 ClusterRole 吗？会怎样？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q5%EF%BC%9ARoleBinding-%E5%92%8C-ClusterRoleBinding-%E6%80%8E%E4%B9%88%E9%80%89%E6%8B%A9%EF%BC%9F"><span class="toc-number">3.2.2.5.</span> <span class="toc-text">Q5：RoleBinding 和 ClusterRoleBinding 怎么选择？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q6%EF%BC%9ARBAC-%E4%B8%AD%E7%9A%84-User%E3%80%81Group%E3%80%81ServiceAccount-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">3.2.2.6.</span> <span class="toc-text">Q6：RBAC 中的 User、Group、ServiceAccount 有什么区别？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q7%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF-system-%E5%89%8D%E7%BC%80%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E9%81%BF%E5%85%8D%EF%BC%9F"><span class="toc-number">3.2.2.7.</span> <span class="toc-text">Q7：什么是 system: 前缀？为什么要避免？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q8%EF%BC%9A%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%91%98%E6%80%8E%E4%B9%88%E9%85%8D%E7%BD%AE%EF%BC%9F"><span class="toc-number">3.2.2.8.</span> <span class="toc-text">Q8：集群管理员怎么配置？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q9%EF%BC%9A%E6%9D%83%E9%99%90%E6%98%AF%E5%8A%A0%E6%B3%95%E8%BF%98%E6%98%AF%E5%87%8F%E6%B3%95%EF%BC%9F"><span class="toc-number">3.2.2.9.</span> <span class="toc-text">Q9：权限是加法还是减法？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q10%EF%BC%9A%E6%80%8E%E4%B9%88%E7%BB%99%E6%9F%90%E4%B8%AA%E7%94%A8%E6%88%B7%E6%B7%BB%E5%8A%A0%E6%9D%83%E9%99%90%EF%BC%9F"><span class="toc-number">3.2.2.10.</span> <span class="toc-text">Q10：怎么给某个用户添加权限？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q11%EF%BC%9ARBAC-%E5%BA%94%E8%AF%A5%E6%80%8E%E4%B9%88%E8%A7%84%E5%88%92%EF%BC%9F%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">3.2.2.11.</span> <span class="toc-text">Q11：RBAC 应该怎么规划？最佳实践是什么？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81HPA%EF%BC%88Horizontal-Pod-Autoscaler%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">三、HPA（Horizontal Pod Autoscaler）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">基础概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E7%B2%BE%E9%80%89-2"><span class="toc-number">3.3.2.</span> <span class="toc-text">面试题精选</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Q1%EF%BC%9AHPA-%E6%98%AF%E5%B9%B2%E4%BB%80%E4%B9%88%E7%9A%84%EF%BC%9F%E8%A7%A3%E5%86%B3%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">Q1：HPA 是干什么的？解决什么问题？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q2%EF%BC%9AHPA-%E9%9D%A0%E4%BB%80%E4%B9%88%E6%8C%87%E6%A0%87%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E6%89%A9%E5%AE%B9%EF%BC%9F"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">Q2：HPA 靠什么指标判断是否需要扩容？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q3%EF%BC%9AHPA-%E6%80%8E%E4%B9%88%E9%85%8D%E7%BD%AE%EF%BC%9FYAML-%E6%80%8E%E4%B9%88%E5%86%99%EF%BC%9F"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">Q3：HPA 怎么配置？YAML 怎么写？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q4%EF%BC%9AHPA-%E9%9C%80%E8%A6%81%E4%BB%80%E4%B9%88%E5%89%8D%E7%BD%AE%E6%9D%A1%E4%BB%B6%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%85%E9%A1%BB%E6%9C%89%EF%BC%9F"><span class="toc-number">3.3.2.4.</span> <span class="toc-text">Q4：HPA 需要什么前置条件？为什么必须有？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q5%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF-Metrics-Server%EF%BC%9F%E5%92%8C-Prometheus-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">3.3.2.5.</span> <span class="toc-text">Q5：什么是 Metrics Server？和 Prometheus 有什么区别？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q6%EF%BC%9AHPA-%E5%A4%9A%E4%B9%85%E6%A3%80%E6%9F%A5%E4%B8%80%E6%AC%A1%EF%BC%9F%E5%A4%9A%E4%B9%85%E8%83%BD%E7%9C%8B%E5%88%B0%E6%95%88%E6%9E%9C%EF%BC%9F"><span class="toc-number">3.3.2.6.</span> <span class="toc-text">Q6：HPA 多久检查一次？多久能看到效果？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q7%EF%BC%9AHPA-%E7%9A%84%E6%89%A9%E5%AE%B9%E5%85%AC%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">3.3.2.7.</span> <span class="toc-text">Q7：HPA 的扩容公式是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q8%EF%BC%9AHPA-%E4%BC%9A%E4%B8%8D%E4%BC%9A%E6%89%A9%E5%AE%B9%E5%88%B0%E8%B6%85%E8%BF%87-maxReplicas%EF%BC%9F"><span class="toc-number">3.3.2.8.</span> <span class="toc-text">Q8：HPA 会不会扩容到超过 maxReplicas？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q9%EF%BC%9AminReplicas-%E8%AE%BE%E7%BD%AE%E5%A4%9A%E5%B0%91%E6%AF%94%E8%BE%83%E5%A5%BD%EF%BC%9F"><span class="toc-number">3.3.2.9.</span> <span class="toc-text">Q9：minReplicas 设置多少比较好？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q10%EF%BC%9AHPA-%E6%80%8E%E4%B9%88%E6%B5%8B%E8%AF%95%EF%BC%9F%E6%80%8E%E4%B9%88%E9%AA%8C%E8%AF%81%E8%83%BD%E5%90%A6%E6%AD%A3%E5%B8%B8%E6%89%A9%E7%BC%A9%E5%AE%B9%EF%BC%9F"><span class="toc-number">3.3.2.10.</span> <span class="toc-text">Q10：HPA 怎么测试？怎么验证能否正常扩缩容？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q11%EF%BC%9AHPA-%E4%B8%8D%E5%B7%A5%E4%BD%9C%E4%BA%86%E6%80%8E%E4%B9%88%E6%8E%92%E6%9F%A5%EF%BC%9F"><span class="toc-number">3.3.2.11.</span> <span class="toc-text">Q11：HPA 不工作了怎么排查？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q12%EF%BC%9A%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B-HPA-%E6%97%A0%E6%B3%95%E5%B7%A5%E4%BD%9C%EF%BC%9F"><span class="toc-number">3.3.2.12.</span> <span class="toc-text">Q12：什么情况下 HPA 无法工作？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q13%EF%BC%9AHPA-VPA-%E5%8F%AF%E4%BB%A5%E4%B8%80%E8%B5%B7%E7%94%A8%E5%90%97%EF%BC%9F"><span class="toc-number">3.3.2.13.</span> <span class="toc-text">Q13：HPA + VPA 可以一起用吗？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q14%EF%BC%9A%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83-HPA-%E6%80%8E%E4%B9%88%E9%85%8D%E7%BD%AE%E6%89%8D%E7%A8%B3%E5%AE%9A%EF%BC%9F"><span class="toc-number">3.3.2.14.</span> <span class="toc-text">Q14：生产环境 HPA 怎么配置才稳定？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E5%AF%B9%E6%AF%94%E8%A1%A8"><span class="toc-number">3.4.</span> <span class="toc-text">总结对比表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CNI-%E6%8F%92%E4%BB%B6%E9%80%89%E5%9E%8B%E9%80%9F%E6%9F%A5"><span class="toc-number">3.4.1.</span> <span class="toc-text">CNI 插件选型速查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RBAC-%E6%A0%B8%E5%BF%83%E5%BF%AB%E8%AE%B0"><span class="toc-number">3.4.2.</span> <span class="toc-text">RBAC 核心快记</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HPA-%E9%85%8D%E7%BD%AE%E5%BF%AB%E8%AE%B0"><span class="toc-number">3.4.3.</span> <span class="toc-text">HPA 配置快记</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/" title="Kubernetes-Ingress服务">Kubernetes-Ingress服务</a><time datetime="2025-12-16T10:12:58.000Z" title="Created 2025-12-16 18:12:58">2025-12-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/16/Kubernetes%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86/" title="Kubernetes存储管理">Kubernetes存储管理</a><time datetime="2025-12-16T01:35:04.000Z" title="Created 2025-12-16 09:35:04">2025-12-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/15/Kubernetes%20%E9%85%8D%E7%BD%AE%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" title="Kubernetes 配置资源管理">Kubernetes 配置资源管理</a><time datetime="2025-12-15T02:54:40.000Z" title="Created 2025-12-15 10:54:40">2025-12-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/12/%E9%98%BF%E9%87%8C%E4%BA%91-%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2/" title="阿里云-设备管理平台部署">阿里云-设备管理平台部署</a><time datetime="2025-12-12T00:54:40.000Z" title="Created 2025-12-12 08:54:40">2025-12-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/10/Kubernetes-Pod%E7%9A%84%E5%8D%87%E7%BA%A7%E4%B8%8E%E6%9B%B4%E6%96%B0/" title="Kubernetes Pod的升级与更新">Kubernetes Pod的升级与更新</a><time datetime="2025-12-10T12:13:46.000Z" title="Created 2025-12-10 20:13:46">2025-12-10</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/imgs/background_footer.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Felix</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.0.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.1"></script><script src="/js/main.js?v=5.5.1"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>