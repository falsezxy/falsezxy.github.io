<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kubernetes-Ingress服务 | Felix的个人博客</title><meta name="author" content="Felix"><meta name="copyright" content="Felix"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Kubernetes-Ingress服务一、Ingress 概述1. 为什么需要 Ingress？K8s 内的 Pod IP 与 Service ClusterIP 仅在集群内部可见。为了让外部应用访问集群内服务，K8s 提供了多种方案： 现有方案的问题 NodePort：适合测试，但服务数量多时端口管理困难（端口范围 30000-32767，每个端口仅服务一种服务） LoadBalancer：需">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes-Ingress服务">
<meta property="og:url" content="http://example.com/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/index.html">
<meta property="og:site_name" content="Felix的个人博客">
<meta property="og:description" content="Kubernetes-Ingress服务一、Ingress 概述1. 为什么需要 Ingress？K8s 内的 Pod IP 与 Service ClusterIP 仅在集群内部可见。为了让外部应用访问集群内服务，K8s 提供了多种方案： 现有方案的问题 NodePort：适合测试，但服务数量多时端口管理困难（端口范围 30000-32767，每个端口仅服务一种服务） LoadBalancer：需">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/imgs/adater.jpg">
<meta property="article:published_time" content="2025-12-16T10:12:58.000Z">
<meta property="article:modified_time" content="2025-12-17T12:31:17.568Z">
<meta property="article:author" content="Felix">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/imgs/adater.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kubernetes-Ingress服务",
  "url": "http://example.com/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/",
  "image": "http://example.com/imgs/adater.jpg",
  "datePublished": "2025-12-16T10:12:58.000Z",
  "dateModified": "2025-12-17T12:31:17.568Z",
  "author": [
    {
      "@type": "Person",
      "name": "Felix",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes-Ingress服务',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.0.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/imgs/background_header.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Felix的个人博客</span></a><a class="nav-page-title" href="/"><span class="site-name">Kubernetes-Ingress服务</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">Kubernetes-Ingress服务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-12-16T10:12:58.000Z" title="Created 2025-12-16 18:12:58">2025-12-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-12-17T12:31:17.568Z" title="Updated 2025-12-17 20:31:17">2025-12-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Kubernetes-Ingress服务"><a href="#Kubernetes-Ingress服务" class="headerlink" title="Kubernetes-Ingress服务"></a>Kubernetes-Ingress服务</h1><h2 id="一、Ingress-概述"><a href="#一、Ingress-概述" class="headerlink" title="一、Ingress 概述"></a>一、Ingress 概述</h2><h3 id="1-为什么需要-Ingress？"><a href="#1-为什么需要-Ingress？" class="headerlink" title="1. 为什么需要 Ingress？"></a>1. 为什么需要 Ingress？</h3><p>K8s 内的 Pod IP 与 Service ClusterIP 仅在集群内部可见。为了让<strong>外部应用</strong>访问集群内服务，K8s 提供了多种方案：</p>
<h4 id="现有方案的问题"><a href="#现有方案的问题" class="headerlink" title="现有方案的问题"></a>现有方案的问题</h4><ul>
<li><strong>NodePort</strong>：适合测试，但服务数量多时端口管理困难（端口范围 30000-32767，每个端口仅服务一种服务）</li>
<li><strong>LoadBalancer</strong>：需要云厂商支持，通常需要额外费用，仅适合公有云</li>
<li><strong>externalIPs</strong>：为 service 分配外部 IP，配置相对复杂</li>
</ul>
<h4 id="Ingress（七层反向代理）-的优势"><a href="#Ingress（七层反向代理）-的优势" class="headerlink" title="Ingress（七层反向代理） 的优势"></a>Ingress（七层反向代理） 的优势</h4><ul>
<li>仅用一个或少量的公网 IP&#x2F;LB，即可同时将多个 HTTP&#x2F;HTTPS 服务暴露到外网</li>
<li>可理解为**”service 的 service”<strong>：基于</strong>域名&#x2F;URL 路径**将请求转发到一个或多个 service</li>
<li><strong>集中管理端口</strong>，减少 K8s 对外暴露的入口数量</li>
</ul>
<p><img src="/./imgs/image-20251216185022120.png" alt="image-20251216185022120"></p>
<hr>
<h2 id="二、Ingress-的核心组件"><a href="#二、Ingress-的核心组件" class="headerlink" title="二、Ingress 的核心组件"></a>二、Ingress 的核心组件</h2><h3 id="1-Ingress（规则定义）"><a href="#1-Ingress（规则定义）" class="headerlink" title="1. Ingress（规则定义）"></a>1. Ingress（规则定义）</h3><ul>
<li>以 <strong>YAML</strong> 格式定义的 <strong>API 对象</strong></li>
<li>定义请求如何转发到 service 的规则</li>
<li>能提供：外部 URL、负载均衡、SSL&#x2F;TLS、基于域名的反向代理</li>
<li>具体功能需 <strong>Ingress Controller</strong> 实现</li>
</ul>
<h3 id="2-Ingress-Controller（执行转发）"><a href="#2-Ingress-Controller（执行转发）" class="headerlink" title="2. Ingress Controller（执行转发）"></a>2. Ingress Controller（执行转发）</h3><ul>
<li>解析 Ingress 规则并实现反向代理与负载均衡</li>
<li>不是 K8s 自带组件，是一类实现的统称：<ul>
<li>官方维护：<strong>ingress-nginx</strong>（推荐）、GCE</li>
<li>第三方实现：Traefik、Kong、Nginx Inc. 等</li>
</ul>
</li>
<li>典型形态：一个 Pod 内同时运行<strong>守护进程</strong>（监控集群配置）与<strong>反向代理程序</strong>（如 Nginx）</li>
<li><strong>ingress-nginx</strong> 特性：动态生成 Nginx 配置、更新 upstream、按需 reload</li>
</ul>
<blockquote>
<p><strong>结论</strong>：<strong>Ingress Controller</strong> 是真正的流量入口；<strong>Ingress 对象</strong>告诉 Controller 如何转发</p>
</blockquote>
<hr>
<h2 id="三、Ingress-工作原理"><a href="#三、Ingress-工作原理" class="headerlink" title="三、Ingress 工作原理"></a>三、Ingress 工作原理</h2><ol>
<li>Ingress Controller 与 <strong>APIServer</strong> 交互，动态感知 Ingress 规则变化</li>
<li>读取规则并按自定义模板生成 <strong>Nginx 配置文件</strong></li>
<li>将生成的 nginx 配置写入 ingress-controller pod 内的 <code>/etc/nginx/nginx.conf</code></li>
<li>执行 <strong>reload</strong> 使配置生效，实现按域名分流与动态更新</li>
</ol>
<p><img src="/./imgs/image-20251216184837955.png" alt="image-20251216184837955"></p>
<hr>
<h2 id="四、K8s-网络分层架构"><a href="#四、K8s-网络分层架构" class="headerlink" title="四、K8s 网络分层架构"></a>四、K8s 网络分层架构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">L7 入口 (Ingress)</span><br><span class="line">    ↓</span><br><span class="line">L4 服务发现 (Service)</span><br><span class="line">    ↓</span><br><span class="line">Pod 内通讯 (CNI 插件：flannel)</span><br><span class="line">    ↓</span><br><span class="line">容器间通讯 (pause 容器：localhost)</span><br></pre></td></tr></table></figure>

<p><strong>关键概念</strong>：</p>
<ul>
<li>Service 通过 <strong>endpoints</strong> 找到后端 Pod</li>
<li>CNI 插件（如 flannel）负责 Pod 间网络通讯</li>
<li>Pause 容器提供 Pod 内容器间的 localhost 通讯</li>
</ul>
<hr>
<h2 id="五、Service-服务发现与暴露模式"><a href="#五、Service-服务发现与暴露模式" class="headerlink" title="五、Service 服务发现与暴露模式"></a>五、Service 服务发现与暴露模式</h2><h3 id="Service-类型对比"><a href="#Service-类型对比" class="headerlink" title="Service 类型对比"></a>Service 类型对比</h3><table>
<thead>
<tr>
<th>类型</th>
<th>用途</th>
<th>特点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ClusterIP</strong></td>
<td>集群内通讯</td>
<td>直接访问 Service IP</td>
<td>无法对外暴露</td>
</tr>
<tr>
<td><strong>Headless</strong></td>
<td>StatefulSet 场景</td>
<td>无 Service IP，直接解析 Pod 名称访问 Pod IP</td>
<td>需手动管理</td>
</tr>
<tr>
<td><strong>NodePort</strong></td>
<td>开发测试</td>
<td>Kube-proxy 映射 Service→节点 IP+随机端口</td>
<td>端口管理困难，安全风险高</td>
</tr>
<tr>
<td><strong>LoadBalancer</strong></td>
<td>公有云</td>
<td>云厂商自动创建 LB</td>
<td>需要额外费用，仅云环境可用</td>
</tr>
<tr>
<td><strong>ExternalName</strong></td>
<td>外部服务</td>
<td>通过 DNS CNAME 解析</td>
<td>使用较少</td>
</tr>
</tbody></table>
<p><strong>端口管理示例</strong>：</p>
<ul>
<li>若有 50 个微服务，平均 3 个服务端口 → 集群需暴露 150 个端口</li>
<li>导致：端口管理困难，安全问题持续上升 → <strong>Ingress 解决</strong></li>
</ul>
<hr>
<h2 id="六、Ingress-Controller-部署（ingress-nginx-示例）"><a href="#六、Ingress-Controller-部署（ingress-nginx-示例）" class="headerlink" title="六、Ingress Controller 部署（ingress-nginx 示例）"></a>六、Ingress Controller 部署（ingress-nginx 示例）</h2><h3 id="获取官方清单"><a href="#获取官方清单" class="headerlink" title="获取官方清单"></a>获取官方清单</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/ingress &amp;&amp; <span class="built_in">cd</span> /opt/ingress</span><br><span class="line"></span><br><span class="line"><span class="comment"># 官方地址</span></span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 国内镜像</span></span><br><span class="line">wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.30.0/deploy/static/mandatory.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明</strong>：mandatory.yaml 包含 namespace、ConfigMap、Role、ServiceAccount 等所有部署所需资源</p>
</blockquote>
<h3 id="修改-RBAC-权限（0-25-版本）"><a href="#修改-RBAC-权限（0-25-版本）" class="headerlink" title="修改 RBAC 权限（0.25+ 版本）"></a>修改 RBAC 权限（0.25+ 版本）</h3><p>在 <code>mandatory.yaml</code> 中的 <code>ClusterRole</code> 规则中添加 <code>networking.k8s.io</code> API 组：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;extensions&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;networking.k8s.io&quot;</span>  <span class="comment"># 增加此行</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">update</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、三种部署模式对比"><a href="#七、三种部署模式对比" class="headerlink" title="七、三种部署模式对比"></a>七、三种部署模式对比</h2><h3 id="模式一：Deployment-LoadBalancer（云端方案）"><a href="#模式一：Deployment-LoadBalancer（云端方案）" class="headerlink" title="模式一：Deployment + LoadBalancer（云端方案）"></a>模式一：Deployment + LoadBalancer（云端方案）</h3><p><strong>适用场景</strong>：公有云环境</p>
<p><strong>理由</strong>：如果要把ingress部署在公有云，那用这种方式比较合适。用Deployment部署ingress-controller，创建一个 type为 LoadBalancer 的 service 关联这组 pod。大部分公有云，都会为 LoadBalancer 的 service 自动创建一个负载均衡器，通常还绑定了公网地址。 只要把域名解析指向该地址，就实现了集群服务的对外暴露</p>
<p><strong>优点</strong>：</p>
<ul>
<li>LB 自动创建并绑定公网 IP</li>
<li>域名解析指向 LB IP 即可完成对外暴露</li>
<li>无需额外配置</li>
</ul>
<p><img src="/./imgs/image-20251216184649481.png" alt="image-20251216184649481"></p>
<p><strong>配置</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f mandatory.yaml</span><br><span class="line"><span class="comment"># 云厂商自动为 LoadBalancer 类型 service 创建 LB</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="模式二：DaemonSet-HostNetwork-NodeSelector（生产推荐）"><a href="#模式二：DaemonSet-HostNetwork-NodeSelector（生产推荐）" class="headerlink" title="模式二：DaemonSet + HostNetwork + NodeSelector（生产推荐）"></a>模式二：DaemonSet + HostNetwork + NodeSelector（生产推荐）</h3><p><strong>适用场景</strong>：大并发生产环境</p>
<p><strong>理由</strong>：用DaemonSet结合nodeselector来部署ingress-controller到特定的node上，然后使用HostNetwork直接把该pod与宿主机node的网络打通，直接使用宿主机的80&#x2F;433端口就能访问服务。这时，ingress-controller所在的node机器就很类似传统架构的边缘节点，比如机房入口的nginx服务器。该方式整个请求链路最简单，性能相对NodePort模式更好。缺点是由于直接利用宿主机节点的网络和端口，一个node只能部署一个ingress-controller pod。 比较适合大并发的生产环境使用。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>直接占用宿主机 80&#x2F;443 端口</li>
<li>请求链路最短，<strong>性能最好</strong></li>
<li>适合大并发场景</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>一个 node 仅能运行一个 ingress-controller pod</li>
<li>若需高可用，需前置 LVS + keepalived</li>
</ul>
<p><strong>实施步骤</strong>：</p>
<h4 id="1、给-node-打标签，仅在-node02-运行："><a href="#1、给-node-打标签，仅在-node02-运行：" class="headerlink" title="1、给 node 打标签，仅在 node02 运行："></a>1、给 node 打标签，仅在 <code>node02</code> 运行：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node node02 ingress=<span class="literal">true</span></span><br><span class="line">kubectl get nodes --show-labels</span><br></pre></td></tr></table></figure>

<h4 id="2、将-Deployment-改为-DaemonSet，启用-HostNetwork-并指定-node："><a href="#2、将-Deployment-改为-DaemonSet，启用-HostNetwork-并指定-node：" class="headerlink" title="2、将 Deployment 改为 DaemonSet，启用 HostNetwork 并指定 node："></a>2、将 <strong>Deployment</strong> 改为 <strong>DaemonSet</strong>，启用 HostNetwork 并指定 node：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">vim mandatory.yaml</span><br><span class="line">...</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line"><span class="comment"># 修改 kind</span></span><br><span class="line"><span class="comment"># kind: Deployment</span></span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line"><span class="comment"># 删除Replicas</span></span><br><span class="line"><span class="comment"># replicas: 1</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: ingress-nginx</span><br><span class="line">      app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/port: <span class="string">&quot;10254&quot;</span></span><br><span class="line">        prometheus.io/scrape: <span class="string">&quot;true&quot;</span></span><br><span class="line">    spec:</span><br><span class="line">      <span class="comment"># 使用主机网络</span></span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 选择节点运行</span></span><br><span class="line">      nodeSelector:</span><br><span class="line">        ingress: <span class="string">&quot;true&quot;</span></span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="3、在所有-node-上传镜像并加载："><a href="#3、在所有-node-上传镜像并加载：" class="headerlink" title="3、在所有 node 上传镜像并加载："></a>3、在所有 node 上传镜像并加载：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/ingress</span><br><span class="line"><span class="comment"># 假设已有压缩包 ingree.contro.tar.gz</span></span><br><span class="line">tar zxvf ingree.contro.tar.gz</span><br><span class="line">docker load -i ingree.contro.tar</span><br></pre></td></tr></table></figure>

<h4 id="4、启动-Controller，验证监听端口（在-node02）："><a href="#4、启动-Controller，验证监听端口（在-node02）：" class="headerlink" title="4、启动 Controller，验证监听端口（在 node02）："></a>4、启动 Controller，验证监听端口（在 node02）：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n ingress-nginx -o wide</span><br><span class="line">kubectl get cm,daemonset -n ingress-nginx -o wide</span><br><span class="line">netstat -lntp | grep nginx</span><br><span class="line"><span class="comment"># 期望监听：80 / 443 / 8181 / 10254</span></span><br><span class="line"></span><br><span class="line">netstat -lntp | grep nginx</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      7131/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:8181            0.0.0.0:*               LISTEN      7131/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      7131/nginx: master  </span><br><span class="line">tcp6       0      0 :::10254                :::*                    LISTEN      7098/nginx-ingress- </span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：<code>8181</code> 为默认 backend 端口（未匹配到规则时流量进入此处）。若需高可用，可在多节点部署，并在前面加 <strong>LVS + keepalived</strong> 做负载均衡。</p>
</blockquote>
<h4 id="5、创建-ingress-规则"><a href="#5、创建-ingress-规则" class="headerlink" title="5、创建 ingress 规则"></a>5、创建 ingress 规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###创建一个 deploy 和 svc</span></span><br><span class="line">vim service-nginx.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app-svc</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br></pre></td></tr></table></figure>

<h4 id="6、创建-Ingress（两种-API-示例）："><a href="#6、创建-Ingress（两种-API-示例）：" class="headerlink" title="6、创建 Ingress（两种 API 示例）："></a>6、创建 Ingress（两种 API 示例）：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一：extensions/v1beta1（1.22 即将弃用）</span></span><br><span class="line">vim ingress-app.yaml	</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: www.benet.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx-app-svc</span><br><span class="line">          servicePort: 80</span><br><span class="line"><span class="comment"># 方法二：networking.k8s.io/v1（推荐）</span></span><br><span class="line">vim ingress-app.yaml	</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: www.benet.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix  <span class="comment"># 也可使用 Exact</span></span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-app-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>路径匹配：</strong></p>
<ul>
<li><code>Prefix</code>：基于前缀匹配，如 <code>/0805</code> 可匹配 <code>/0805、</code>&#x2F;0805&#x2F;yjs<code>、</code>&#x2F;0805&#x2F;yjs&#x2F;zjl&#96;。</li>
<li><code>Exact</code>：完全匹配，如 <code>/0805</code> 只能匹配 <code>/0805</code>。</li>
</ul>
</blockquote>
<h4 id="7、测试："><a href="#7、测试：" class="headerlink" title="7、测试："></a>7、测试：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f service-nginx.yaml</span><br><span class="line">kubectl apply -f ingress-app.yaml</span><br><span class="line">kubectl get ingress</span><br><span class="line"><span class="comment"># /etc/hosts 添加解析：</span></span><br><span class="line"><span class="comment"># 192.168.10.21 www.benet.com</span></span><br><span class="line">curl www.benet.com</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可进入 Controller Pod 查看生成的 <code>/etc/nginx/nginx.conf</code>，确认 <code>server www.benet.com</code> 段落。</p>
</blockquote>
<hr>
<h3 id="模式三：Deployment-Service-NodePort-（常规方案）"><a href="#模式三：Deployment-Service-NodePort-（常规方案）" class="headerlink" title="模式三：Deployment + Service(NodePort)（常规方案）"></a>模式三：Deployment + Service(NodePort)（常规方案）</h3><p><strong>适用场景</strong>：中小规模集群或开发环境</p>
<p><strong>特点</strong>：</p>
<ul>
<li>多一层 kube-proxy NAT 映射</li>
<li>大流量场景可能影响性能</li>
<li>通常前置一层负载均衡器</li>
</ul>
<p><strong>部署步骤</strong>：</p>
<h4 id="1、下载-nginx-ingress-controller-和-ingress-nginx-暴露端口配置文件"><a href="#1、下载-nginx-ingress-controller-和-ingress-nginx-暴露端口配置文件" class="headerlink" title="1、下载 nginx-ingress-controller 和 ingress-nginx 暴露端口配置文件"></a>1、下载 nginx-ingress-controller 和 ingress-nginx 暴露端口配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/ingress-nodeport &amp;&amp; <span class="built_in">cd</span> /opt/ingress-nodeport</span><br><span class="line"><span class="comment"># 清单获取</span></span><br><span class="line">官方下载地址：</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span><br><span class="line"><span class="comment"># 或国内镜像：</span></span><br><span class="line">wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.30.0/deploy/static/mandatory.yaml</span><br><span class="line">wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在所有 node 节点上传镜像包 ingress-controller-0.30.0.tar 到 /opt/ingress-nodeport 目录，并加载镜像</span></span><br><span class="line">docker load -i ingress-controller-0.30.0.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Controller 与 NodePort Service</span></span><br><span class="line">kubectl apply -f mandatory.yaml</span><br><span class="line">kubectl apply -f service-nodeport.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果K8S Pod 调度失败，在 kubectl describe pod资源时显示：</span></span><br><span class="line"><span class="comment"># Warning  FailedScheduling  ...  didn&#x27;t match node selector</span></span><br><span class="line"><span class="comment"># 解决：</span></span><br><span class="line"><span class="comment"># 1) 按 YAML 中的 nodeSelector 给节点加标签</span></span><br><span class="line">kubectl label nodes &lt;node_name&gt; kubernetes.io/os=linux</span><br><span class="line"><span class="comment"># 2) 或删除 YAML 中的 nodeSelector</span></span><br><span class="line"></span><br><span class="line">kubectl get pod,svc -n ingress-nginx</span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251216153920626.png" alt="image-20251216153920626"></p>
<p>启动controller</p>
<p><img src="/./imgs/image-20251216154642569.png" alt="image-20251216154642569"></p>
<p>启动NodePort Service</p>
<p><img src="/./imgs/image-20251216154748647.png" alt="image-20251216154748647"></p>
<p><img src="/./imgs/image-20251216154933520.png" alt="image-20251216154933520"></p>
<p>详细访问效果看八部分</p>
<hr>
<h2 id="八、Ingress-规则配置详解"><a href="#八、Ingress-规则配置详解" class="headerlink" title="八、Ingress 规则配置详解"></a>八、Ingress 规则配置详解</h2><h3 id="8-1-基础-HTTP-代理"><a href="#8-1-基础-HTTP-代理" class="headerlink" title="8.1 基础 HTTP 代理"></a>8.1 基础 HTTP 代理</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建后端应用</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 暴露 Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-app-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 配置 Ingress（networking.k8s.io/v1，推荐）</span></span><br><span class="line"><span class="comment"># Ingress的配置类似于配置nginx.conf</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-app-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.benet.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span>  <span class="comment"># Prefix：前缀匹配；Exact：完全匹配</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-app-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><strong>路径匹配说明</strong>：</p>
<ul>
<li><code>Prefix</code>：基于前缀匹配，如 <code>/api</code> 可匹配 <code>/api</code>、<code>/api/users</code>、<code>/api/users/123</code></li>
<li><code>Exact</code>：完全匹配，如 <code>/api</code> 只能匹配 <code>/api</code></li>
</ul>
<p><strong>验证步骤</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ingress-nginx.yaml</span><br><span class="line">kubectl get ingress</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 ingress-controller 所在节点配置 hosts</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;192.168.110.130 www.benet.com&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">curl www.benet.com  <span class="comment"># 直接访问（HostNetwork 模式）</span></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">curl www.benet.com:31605  <span class="comment"># NodePort 模式（31605 为映射端口）</span></span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251216182546954.png" alt="image-20251216182546954"></p>
<p><img src="/./imgs/image-20251216182553557.png" alt="image-20251216182553557"></p>
<h3 id="8-2-虚拟主机（多域名）"><a href="#8-2-虚拟主机（多域名）" class="headerlink" title="8.2 虚拟主机（多域名）"></a>8.2 虚拟主机（多域名）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署两套应用</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deployment1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">soscscs/myapp:v1</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 第二个应用类似（myapp:v2、svc-2）...</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Ingress 规则：双主机名</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-vhost</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www1.benet.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc-1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www2.benet.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc-2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><strong>测试</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设NodePort端口为32383</span></span><br><span class="line">curl www1.benet.com:32383  <span class="comment"># 返回 v1</span></span><br><span class="line">curl www2.benet.com:32383  <span class="comment"># 返回 v2</span></span><br></pre></td></tr></table></figure>

<p><img src="/./imgs/image-20251216182628557.png" alt="image-20251216182628557"></p>
<p><img src="/./imgs/image-20251216182635036.png" alt="image-20251216182635036"></p>
<h3 id="8-3-HTTPS-TLS-配置"><a href="#8-3-HTTPS-TLS-配置" class="headerlink" title="8.3 HTTPS&#x2F;TLS 配置"></a>8.3 HTTPS&#x2F;TLS 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成自签证书</span></span><br><span class="line">openssl req -x509 -sha256 -nodes -days 365 \</span><br><span class="line">  -newkey rsa:2048 -keyout tls.key -out tls.crt \</span><br><span class="line">  -subj <span class="string">&quot;/CN=nginxsvc/O=nginxsvc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 secret</span></span><br><span class="line">kubectl create secret tls tls-secret --key tls.key --cert tls.crt</span><br><span class="line">kubectl get secret tls-secret -o yaml</span><br><span class="line"><span class="comment"># ingress-https.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc-01</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    name: nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-https</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">    - hosts:</span><br><span class="line">      - www3.benet.com</span><br><span class="line">      secretName: tls-secret</span><br><span class="line">  rules:</span><br><span class="line">    - host: www3.benet.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          pathType: Prefix</span><br><span class="line">          backend:</span><br><span class="line">            service:</span><br><span class="line">              name: nginx-svc-01</span><br><span class="line">              port:</span><br><span class="line">                number: 80</span><br><span class="line"> </span><br><span class="line">kubectl apply -f ingress-https.yaml</span><br><span class="line"></span><br><span class="line">kubectl get svc -n ingress-nginx</span><br><span class="line">NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">ingress-nginx   NodePort   10.96.67.119   &lt;none&gt;        80:32383/TCP,443:32133/TCP   3h41m</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设 443:32133 映射</span></span><br><span class="line"><span class="comment"># hosts 添加：192.168.10.21 www3.benet.com</span></span><br><span class="line"><span class="comment"># 浏览器访问：https://www3.benet.com:32133</span></span><br><span class="line">curl --insecure https://www3.benet.com:32133</span><br></pre></td></tr></table></figure>

<h3 id="8-4-BasicAuth-认证"><a href="#8-4-BasicAuth-认证" class="headerlink" title="8.4 BasicAuth 认证"></a>8.4 BasicAuth 认证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/ingress-nodeport/basic-auth &amp;&amp; <span class="built_in">cd</span> /opt/ingress-nodeport/basic-auth</span><br><span class="line"><span class="comment"># 生成 auth 文件</span></span><br><span class="line">yum -y install httpd</span><br><span class="line">htpasswd -c auth zhangsan  <span class="comment"># 交互式输入密码</span></span><br><span class="line"><span class="comment"># 存为 secret</span></span><br><span class="line">kubectl create secret generic basic-auth --from-file=auth</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-auth</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-type: basic</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-secret: basic-auth</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-realm: <span class="string">&#x27;Authentication Required - zhangsan&#x27;</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: auth.benet.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<p><strong>验证</strong>：需要输入用户名密码才能访问</p>
<h3 id="8-5-URL-重写（Rewrite）"><a href="#8-5-URL-重写（Rewrite）" class="headerlink" title="8.5 URL 重写（Rewrite）"></a>8.5 URL 重写（Rewrite）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ingress-rewrite.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-rewrite</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">http://www1.benet.com:32383</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">re.benet.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><strong>常用注解</strong>：</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/rewrite-target</code>：重定向目标 URI（必填）</li>
<li><code>nginx.ingress.kubernetes.io/ssl-redirect</code>：是否仅允许 SSL（默认 true）</li>
<li><code>nginx.ingress.kubernetes.io/force-ssl-redirect</code>：强制 HTTPS 跳转</li>
<li><code>nginx.ingress.kubernetes.io/app-root</code>：应用根路径</li>
<li><code>nginx.ingress.kubernetes.io/use-regex</code>：路径是否使用正则</li>
</ul>
<hr>
<h2 id="九、问题排查与调试"><a href="#九、问题排查与调试" class="headerlink" title="九、问题排查与调试"></a>九、问题排查与调试</h2><h3 id="查看-Controller-运行状态"><a href="#查看-Controller-运行状态" class="headerlink" title="查看 Controller 运行状态"></a>查看 Controller 运行状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Pod 与端口</span></span><br><span class="line">kubectl get pod -n ingress-nginx -o wide</span><br><span class="line">kubectl get svc -n ingress-nginx</span><br><span class="line">netstat -lntp | grep nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 ConfigMap 和资源</span></span><br><span class="line">kubectl get cm,daemonset -n ingress-nginx -o wide</span><br></pre></td></tr></table></figure>

<h3 id="进入-Pod-检查-Nginx-配置"><a href="#进入-Pod-检查-Nginx-配置" class="headerlink" title="进入 Pod 检查 Nginx 配置"></a>进入 Pod 检查 Nginx 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it &lt;controller-pod&gt; -n ingress-nginx -- /bin/bash</span><br><span class="line">more /etc/nginx/nginx.conf</span><br><span class="line"><span class="comment"># 查找 server www.benet.com ... end server www.benet.com 段落</span></span><br></pre></td></tr></table></figure>

<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p><strong>问题 1</strong>：调度失败，提示 <code>didn&#39;t match node selector</code></p>
<ul>
<li><p><strong>解决</strong>：给目标节点加对应标签，或删除 YAML 中的 <code>nodeSelector</code></p>
</li>
<li><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes &lt;node_name&gt; kubernetes.io/os=linux</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>问题 2</strong>：Ingress 创建后仍无法访问</p>
<ul>
<li>检查 hosts 文件是否配置</li>
<li>检查防火墙是否开放端口</li>
<li>验证后端 Pod 是否正常运行：<code>kubectl get pods</code></li>
</ul>
<hr>
<h2 id="十、实践总结"><a href="#十、实践总结" class="headerlink" title="十、实践总结"></a>十、实践总结</h2><h3 id="完整配置流程"><a href="#完整配置流程" class="headerlink" title="完整配置流程"></a>完整配置流程</h3><ol>
<li><strong>部署 ingress-controller</strong><ul>
<li>创建 namespace、RBAC、ConfigMap</li>
<li>部署 ingress-controller pod（选择合适的部署模式）</li>
<li>创建 Service 暴露 controller</li>
</ul>
</li>
<li><strong>配置后端应用</strong><ul>
<li>创建 Deployment</li>
<li>创建 ClusterIP Service</li>
</ul>
</li>
<li><strong>定义 Ingress 规则</strong><ul>
<li>编写 Ingress YAML（指定域名、路径、后端 service）</li>
<li>配置 TLS、认证等高级功能</li>
</ul>
</li>
<li><strong>验证与测试</strong><ul>
<li>配置 hosts 解析</li>
<li>curl 测试域名访问</li>
<li>检查 nginx.conf 配置是否生成</li>
</ul>
</li>
</ol>
<h3 id="生产最佳实践"><a href="#生产最佳实践" class="headerlink" title="生产最佳实践"></a>生产最佳实践</h3><ul>
<li><strong>高可用</strong>：多节点 DaemonSet 部署 + 前置 LVS + keepalived</li>
<li><strong>性能优化</strong>：采用 <strong>DaemonSet + HostNetwork</strong> 模式，避免多层 NAT</li>
<li><strong>监控告警</strong>：接入 Prometheus 采集 ingress-controller 指标（10254 端口）</li>
<li><strong>安全加固</strong>：<ul>
<li>配置 TLS&#x2F;HTTPS</li>
<li>启用 BasicAuth 或 OAuth2 认证</li>
<li>考虑 WAF、限速等防护</li>
<li>定期更新证书</li>
</ul>
</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li>官方 GitHub：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx">https://github.com/kubernetes/ingress-nginx</a></li>
<li>官方网站：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/">https://kubernetes.github.io/ingress-nginx/</a></li>
<li>认证示例：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/examples/auth/basic/">https://kubernetes.github.io/ingress-nginx/examples/auth/basic/</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">Felix</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/">http://example.com/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/imgs/adater.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/12/17/Kubernets-network_rbac_hpa/" title="Kubernetes 网络、RBAC 和 HPA 相关知识"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Kubernetes 网络、RBAC 和 HPA 相关知识</div></div><div class="info-2"><div class="info-item-1">Kubernetes 网络、RBAC 和 HPA 相关知识一、Kubernetes 网络体系详解1.1 三层网络架构Kubernetes 集群网络由三个独立的网络层组成，每层承担不同的责任： 节点网络（Node Network） 定义：负责集群宿主机节点间的通信，并打通与集群外部的连接 IP 类型：nodeIP 实现基础：物理网卡或云网络基础设施 通信方式：通过物理网卡上的 nodeIP 实现跨主机通信 典型场景：集群内部节点相互访问、外部客户端访问集群入口  Pod 网络（Pod Network） 定义：为集群内所有 Pod 提供网络通信能力 IP 类型：podIP，全局唯一 关键特性：Pod 可以跨节点相互通信，无论它们运行在同一节点还是不同节点 实现机制：通过 CNI（Container Network Interface）网络插件实现 网络模型： Overlay（覆盖网络）：数据包经过二次封装，增加额外处理但支持跨网段 Route（路由网络）：基于路由表转发，性能更优但对网络基础设施有要求    Service 网络（Service Network） 定义：集群部署时指定...</div></div></div></a><a class="pagination-related" href="/2025/12/16/Kubernetes%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86/" title="Kubernetes存储管理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Kubernetes存储管理</div></div><div class="info-2"><div class="info-item-1">Kubernetes 存储管理一、ConfigMap 与 Secret 配置管理1.1 ConfigMap（配置管理）概念ConfigMap 用于管理 Pod 中容器内服务的配置文件和环境变量。 适用场景 存储应用配置文件（如 Nginx.conf、数据库连接配置） 定义环境变量 非加密的配置数据  典型例子：Ruo-Yi 微服务 前端：Nginx + VUE 框架（DIST 文件） 配置文件：Nginx.conf  1.2 Secret（加密管理）概念Secret 管理 Pod 中容器的加密信息、令牌与密钥文件。 适用场景 存储加密密钥 管理用户凭证（用户名&#x2F;密码） 存储 API Token 和 Secret 密钥文件 敏感信息保护  Secret 创建方式方式一：使用 kubectl 命令创建 1kubectl create secret generic &lt;secret-name&gt; --from-file=&lt;file-path&gt;  方式二：Base64 编码后编写 YAML 12345678910111213141516# 编码敏感信息ech...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/imgs/adater.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Felix</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">41</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/falsezxy"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-Ingress%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">Kubernetes-Ingress服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Ingress-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">一、Ingress 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-Ingress%EF%BC%9F"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. 为什么需要 Ingress？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%B0%E6%9C%89%E6%96%B9%E6%A1%88%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">现有方案的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ingress%EF%BC%88%E4%B8%83%E5%B1%82%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%EF%BC%89-%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">Ingress（七层反向代理） 的优势</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Ingress-%E7%9A%84%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">二、Ingress 的核心组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Ingress%EF%BC%88%E8%A7%84%E5%88%99%E5%AE%9A%E4%B9%89%EF%BC%89"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. Ingress（规则定义）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Ingress-Controller%EF%BC%88%E6%89%A7%E8%A1%8C%E8%BD%AC%E5%8F%91%EF%BC%89"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. Ingress Controller（执行转发）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Ingress-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">三、Ingress 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81K8s-%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84"><span class="toc-number">1.4.</span> <span class="toc-text">四、K8s 网络分层架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81Service-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E6%9A%B4%E9%9C%B2%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.</span> <span class="toc-text">五、Service 服务发现与暴露模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-%E7%B1%BB%E5%9E%8B%E5%AF%B9%E6%AF%94"><span class="toc-number">1.5.1.</span> <span class="toc-text">Service 类型对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81Ingress-Controller-%E9%83%A8%E7%BD%B2%EF%BC%88ingress-nginx-%E7%A4%BA%E4%BE%8B%EF%BC%89"><span class="toc-number">1.6.</span> <span class="toc-text">六、Ingress Controller 部署（ingress-nginx 示例）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%98%E6%96%B9%E6%B8%85%E5%8D%95"><span class="toc-number">1.6.1.</span> <span class="toc-text">获取官方清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-RBAC-%E6%9D%83%E9%99%90%EF%BC%880-25-%E7%89%88%E6%9C%AC%EF%BC%89"><span class="toc-number">1.6.2.</span> <span class="toc-text">修改 RBAC 权限（0.25+ 版本）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E4%B8%89%E7%A7%8D%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-number">1.7.</span> <span class="toc-text">七、三种部署模式对比</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%B8%80%EF%BC%9ADeployment-LoadBalancer%EF%BC%88%E4%BA%91%E7%AB%AF%E6%96%B9%E6%A1%88%EF%BC%89"><span class="toc-number">1.7.1.</span> <span class="toc-text">模式一：Deployment + LoadBalancer（云端方案）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%BA%8C%EF%BC%9ADaemonSet-HostNetwork-NodeSelector%EF%BC%88%E7%94%9F%E4%BA%A7%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">1.7.2.</span> <span class="toc-text">模式二：DaemonSet + HostNetwork + NodeSelector（生产推荐）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E7%BB%99-node-%E6%89%93%E6%A0%87%E7%AD%BE%EF%BC%8C%E4%BB%85%E5%9C%A8-node02-%E8%BF%90%E8%A1%8C%EF%BC%9A"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">1、给 node 打标签，仅在 node02 运行：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%B0%86-Deployment-%E6%94%B9%E4%B8%BA-DaemonSet%EF%BC%8C%E5%90%AF%E7%94%A8-HostNetwork-%E5%B9%B6%E6%8C%87%E5%AE%9A-node%EF%BC%9A"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">2、将 Deployment 改为 DaemonSet，启用 HostNetwork 并指定 node：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E5%9C%A8%E6%89%80%E6%9C%89-node-%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E5%B9%B6%E5%8A%A0%E8%BD%BD%EF%BC%9A"><span class="toc-number">1.7.2.3.</span> <span class="toc-text">3、在所有 node 上传镜像并加载：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%90%AF%E5%8A%A8-Controller%EF%BC%8C%E9%AA%8C%E8%AF%81%E7%9B%91%E5%90%AC%E7%AB%AF%E5%8F%A3%EF%BC%88%E5%9C%A8-node02%EF%BC%89%EF%BC%9A"><span class="toc-number">1.7.2.4.</span> <span class="toc-text">4、启动 Controller，验证监听端口（在 node02）：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E5%88%9B%E5%BB%BA-ingress-%E8%A7%84%E5%88%99"><span class="toc-number">1.7.2.5.</span> <span class="toc-text">5、创建 ingress 规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81%E5%88%9B%E5%BB%BA-Ingress%EF%BC%88%E4%B8%A4%E7%A7%8D-API-%E7%A4%BA%E4%BE%8B%EF%BC%89%EF%BC%9A"><span class="toc-number">1.7.2.6.</span> <span class="toc-text">6、创建 Ingress（两种 API 示例）：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="toc-number">1.7.2.7.</span> <span class="toc-text">7、测试：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%B8%89%EF%BC%9ADeployment-Service-NodePort-%EF%BC%88%E5%B8%B8%E8%A7%84%E6%96%B9%E6%A1%88%EF%BC%89"><span class="toc-number">1.7.3.</span> <span class="toc-text">模式三：Deployment + Service(NodePort)（常规方案）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E4%B8%8B%E8%BD%BD-nginx-ingress-controller-%E5%92%8C-ingress-nginx-%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">1、下载 nginx-ingress-controller 和 ingress-nginx 暴露端口配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81Ingress-%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.8.</span> <span class="toc-text">八、Ingress 规则配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%9F%BA%E7%A1%80-HTTP-%E4%BB%A3%E7%90%86"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 基础 HTTP 代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%EF%BC%88%E5%A4%9A%E5%9F%9F%E5%90%8D%EF%BC%89"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 虚拟主机（多域名）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-HTTPS-TLS-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.8.3.</span> <span class="toc-text">8.3 HTTPS&#x2F;TLS 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-BasicAuth-%E8%AE%A4%E8%AF%81"><span class="toc-number">1.8.4.</span> <span class="toc-text">8.4 BasicAuth 认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-URL-%E9%87%8D%E5%86%99%EF%BC%88Rewrite%EF%BC%89"><span class="toc-number">1.8.5.</span> <span class="toc-text">8.5 URL 重写（Rewrite）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B8%8E%E8%B0%83%E8%AF%95"><span class="toc-number">1.9.</span> <span class="toc-text">九、问题排查与调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-Controller-%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81"><span class="toc-number">1.9.1.</span> <span class="toc-text">查看 Controller 运行状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5-Pod-%E6%A3%80%E6%9F%A5-Nginx-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.9.2.</span> <span class="toc-text">进入 Pod 检查 Nginx 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.9.3.</span> <span class="toc-text">常见问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93"><span class="toc-number">1.10.</span> <span class="toc-text">十、实践总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B"><span class="toc-number">1.10.1.</span> <span class="toc-text">完整配置流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.10.2.</span> <span class="toc-text">生产最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.11.</span> <span class="toc-text">参考文献</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/18/CI%20CD%20%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Ruo-Yi%E9%A1%B9%E7%9B%AE/" title="CI/CD持续集成Ruo-Yi项目">CI/CD持续集成Ruo-Yi项目</a><time datetime="2025-12-18T11:27:44.000Z" title="Created 2025-12-18 19:27:44">2025-12-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/17/Kubernets-network_rbac_hpa/" title="Kubernetes 网络、RBAC 和 HPA 相关知识">Kubernetes 网络、RBAC 和 HPA 相关知识</a><time datetime="2025-12-17T10:34:40.000Z" title="Created 2025-12-17 18:34:40">2025-12-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/16/Kubernetes-Ingress%E6%9C%8D%E5%8A%A1/" title="Kubernetes-Ingress服务">Kubernetes-Ingress服务</a><time datetime="2025-12-16T10:12:58.000Z" title="Created 2025-12-16 18:12:58">2025-12-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/16/Kubernetes%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86/" title="Kubernetes存储管理">Kubernetes存储管理</a><time datetime="2025-12-16T01:35:04.000Z" title="Created 2025-12-16 09:35:04">2025-12-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/15/Kubernetes%20%E9%85%8D%E7%BD%AE%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" title="Kubernetes 配置资源管理">Kubernetes 配置资源管理</a><time datetime="2025-12-15T02:54:40.000Z" title="Created 2025-12-15 10:54:40">2025-12-15</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/imgs/background_footer.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Felix</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.0.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.1"></script><script src="/js/main.js?v=5.5.1"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>